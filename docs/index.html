<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Jane Go Guidelines</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <link rel="stylesheet" href="assets/style1.css" />
  <link rel="stylesheet" href="assets/style2.css" />
  <link rel="stylesheet" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
  <script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Jane Go Guidelines</h1>
<p class="subtitle">Recommended Best Practices &amp; Style For Go Code</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#introductions"><span class="toc-section-number">1</span> Introductions</a>
<ul>
<li><a href="#a-quick-heads-up"><span class="toc-section-number">1.1</span> A Quick Heads-Up</a></li>
<li><a href="#on-idiomatic-go"><span class="toc-section-number">1.2</span> On "Idiomatic" Go</a></li>
<li><a href="#language-notes"><span class="toc-section-number">1.3</span> Language Notes</a></li>
<li><a href="#supported-go-version"><span class="toc-section-number">1.4</span> Supported Go Version</a></li>
</ul></li>
<li><a href="#guiding-principles"><span class="toc-section-number">2</span> Guiding Principles</a>
<ul>
<li><a href="#simplicity"><span class="toc-section-number">2.1</span> Simplicity</a></li>
<li><a href="#clarity"><span class="toc-section-number">2.2</span> Clarity</a></li>
<li><a href="#productivity"><span class="toc-section-number">2.3</span> Productivity</a></li>
</ul></li>
<li><a href="#style-syntax"><span class="toc-section-number">3</span> Style &amp; Syntax</a>
<ul>
<li><a href="#identifiers"><span class="toc-section-number">3.1</span> Identifiers</a></li>
<li><a href="#comments"><span class="toc-section-number">3.2</span> Comments</a></li>
</ul></li>
<li><a href="#using-go-features"><span class="toc-section-number">4</span> Using Go Features</a>
<ul>
<li><a href="#errors"><span class="toc-section-number">4.1</span> Errors</a></li>
<li><a href="#testing"><span class="toc-section-number">4.2</span> Testing</a></li>
<li><a href="#concurrency"><span class="toc-section-number">4.3</span> Concurrency</a></li>
<li><a href="#logging"><span class="toc-section-number">4.4</span> Logging</a></li>
</ul></li>
<li><a href="#architecture"><span class="toc-section-number">5</span> Architecture</a>
<ul>
<li><a href="#package-design"><span class="toc-section-number">5.1</span> Package Design</a></li>
<li><a href="#project-structure"><span class="toc-section-number">5.2</span> Project Structure</a></li>
<li><a href="#api-design"><span class="toc-section-number">5.3</span> API Design</a></li>
</ul></li>
<li><a href="#apendixes"><span class="toc-section-number">6</span> Apendixes</a>
<ul>
<li><a href="#error-handling-too-many-behaviours"><span class="toc-section-number">6.1</span> Error Handling: Too Many Behaviours</a></li>
<li><a href="#why-do-some-packages-define-their-own-interfaces"><span class="toc-section-number">6.2</span> Why <em>Do</em> Some Packages Define Their Own Interfaces?</a></li>
<li><a href="#why-is-io.reader-an-example-of-great-interface-design"><span class="toc-section-number">6.3</span> Why is <code class="verbatim">io.Reader</code> an example of great interface design?</a></li>
<li><a href="#api-design-google-vs-amazon"><span class="toc-section-number">6.4</span> API Design, Google vs Amazon</a></li>
<li><a href="#tips-tricks-gotchas"><span class="toc-section-number">6.5</span> Tips, Tricks, &amp; Gotchas</a></li>
</ul></li>
<li><a href="#sources"><span class="toc-section-number">7</span> Sources</a>
<ul>
<li><a href="#other-readingviewing"><span class="toc-section-number">7.1</span> Other Reading/Viewing</a></li>
</ul></li>
</ul>
</nav>
<section id="introductions" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introductions</h1>
<p>Welcome to the Jane Go Code Guidelines!</p>
<p>There are a couple of reasons this document has come into being.</p>
<p>The first is that as great as the documentation provided by the Go team is, there are still places where we might want to be more prescriptive with how we use the various features available in Go.</p>
<p>Second, there are places the documentation provided by the Go team don't cover. As such, there are a number of "best practices" – often referred to as "idiomatic" Go – that have grown up around Go.</p>
<p>This document collects these best practices and conventions into a single document for ease of reading.</p>
<section id="a-quick-heads-up" class="level2" data-number="1.1" id="382e5fc0-987e-4787-8dcf-bf7896e7edc3">
<h2 data-number="1.1" id="382e5fc0-987e-4787-8dcf-bf7896e7edc3"><span class="header-section-number">1.1</span> A Quick Heads-Up</h2>
<p>Much of this document is sourced ( aka "cribbed" ) from multiple sources. All such sources are referenced in a bibliography at the end of document.</p>
<p>That said, everything in this document are things the team at Jane has agreed are things we agree with. They're all things we believe will help us write good, clear, maintainable code.</p>
</section>
<section id="on-idiomatic-go" class="level2" data-number="1.2">
<h2 data-number="1.2"><span class="header-section-number">1.2</span> On "Idiomatic" Go</h2>
<p>The authors of this document eschew the use of the phrase "idiomatic Go".</p>
<p>To say that something is idiomatic is to say that it follows the style of the time. If something is not idiomatic, it is not following the prevailing style. It is unfashionable.</p>
<p>More importantly, to say to someone that their code is not idiomatic does not explain <em>why</em> it’s not idiomatic. Why is this? Like all truths, the answer is found in the dictionary.</p>
<div class="DEFINITION">
<p>idiom (noun): a group of words established by usage as having a meaning not deducible from those of the individual words.</p>
</div>
<p>Idioms are hallmarks of shared values. Idiomatic Go is not something you learn from a book, it’s something that you acquire by being part of a community.</p>
<blockquote>
<p>My concern with the mantra of idiomatic Go is, in many ways, it can be exclusionary. It’s saying “you can’t sit with us.” After all, isn’t that what we mean when critique of someone’s work as non-idiomatic? They didn’t do It right. It doesn’t look right. It doesn’t follow the style of time.</p>
<p>I offer that idiomatic Go is not a suitable mechanism for teaching how to write good Go code because it is defined, fundamentally, by telling someone they did it wrong. Wouldn’t it be better if the advice we gave didn’t alienate the author right at the point they were most willing to accept it?</p>
<p>– Dave Cheney</p>
</blockquote>
<p>So while we technically want to be writing "idiomatic Jane Go code", we argue that Go developers should be using words that more clearly explain what we're trying to do.</p>
<p>If you work at Jane you have to read this document, you don't get a choice. But something the authors hope we can all agree on is that we should always be trying to do the following:</p>
<ul>
<li>write clear, easy to understand code</li>
<li>write simple, easy to maintain code</li>
<li>write code that further enables productivity</li>
</ul>
<p>Funnily enough, those are pretty close to what you could describe as the <a href="id:e276f32e-34c3-4519-bf53-3a419a781c59">guiding principles</a> of Go – which should also be the guiding principles of Jane when we write Go code.</p>
<p>So instead, rather than just saying code isn't "idiomatic", point them to this guideline or any of the sources linked within to explain how someone can improve their code.</p>
</section>
<section id="language-notes" class="level2" data-number="1.3">
<h2 data-number="1.3"><span class="header-section-number">1.3</span> Language Notes</h2>
<p>As of the date writing this document ( March 25, 2022 ), Go 1.18 has been out for ten days. One of the changes was the introduction of <code class="verbatim">any</code>, which is an <em>alias</em> for <code class="verbatim">interface{}</code>. This was introduced as part of the general release of generics.</p>
<p>So in this document I'll be using <code class="verbatim">any</code> – just know that it's an alias for <code class="verbatim">interface{}</code> and you should be good.</p>
<p>As new features are introduced to Go in the future, we will endeavor to update this document with guidelines on how to use that feature. For some features this will be easy and quick; other features will require some experimentation and waiting before we decide on how to use said features. In other words: if a brand-new language feature in Go isn't covered here, and you think it should be covered, AND you work at Jane: open an issue or a PR!</p>
<p>If you don't work at Jane, sorry!</p>
</section>
<section id="supported-go-version" class="level2" data-number="1.4">
<h2 data-number="1.4"><span class="header-section-number">1.4</span> Supported Go Version</h2>
<p>Speaking of the latest version of Go…</p>
<p>Go only supports the two newest versions. At the time of this writing that's Go 1.17 and Go 1.18. Jane should follow the same practice, always updating the <code class="verbatim">go</code> line in <code class="verbatim">go.mod</code> to point to the latest version.</p>
<p>This doesn't mean we have to <strong>use</strong> new features from new releases. The backwards compatibility guarantee means that any code we write <em>should</em> continue to work so long as we're still using Go 1. The only exceptions is code that was unintentionally relying on a bug that has been fixed, or a new feature still in it's shake-down phase ( such as generics ).</p>
<p>While this does mean that we're always able to use new features, the main reason for this policy isn't that. The reason is that new versions of Go often include large productivity gains and optimizations. For example, in <a href="https://go.dev/doc/go1.18#runtime">Go 1.18, the runtime and the compiler have been updated</a> to improve speed and memory usage. Previous versions of Go have seen large improvements to both speed or memory usage, sometimes both.</p>
<p>By keeping up with the latest releases we open up the possibility that our code will see speed &amp; memory improvements without having to change anything except a single line in our <code class="verbatim">go.mod</code> files.</p>
<p>In cases where the newest version has features that need some exploration before we figure out how we want to use them at Jane – such as generics – I suggest we allow repositories to stay on the previous version when a new version is released. This would be preferred over stating we <em>can't</em> use a new version because we haven't fully evaluated it yet. The thinking here is that the only way to evaluate a new version is to use it, and we can't use it if the policy is "wait and see".</p>
<p>This way teams &amp; repositories that are comfortable with the risk of immediately upgrading to a new version of Go can do so, while other teams/repos can hold off to see how things shake out. This grace period shouldn't be indefinite, however. At the very least when a new version of Go is released teams will <em>have</em> to upgrade; ie, teams using Go 1.17 now can use that until Go 1.19 is released – at which point they have to upgrade to Go 1.18, as only Go 1.18 and 1.19 will be supported once Go 1.19 comes out. I would recommend that teams don't push upgrading versions until forced to by a new Go release, however.</p>
</section>
</section>
<section id="guiding-principles" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Guiding Principles</h1>
<p>One of the things that's probably apparent to any of us who have worked in multiple languages is that each language has a set of what you could call "core principles". These principles aren't about what they <em>don't</em> do; rather that when things get tough those principles are what that language focuses on.</p>
<p>Before we talk about the core set of principles for Go, let's take a quick digression to talk about a quote from Russ Cox ( the Go team lead ):</p>
<blockquote>
<p>Software engineering is what happens to programming when you add time and other programmers.</p>
<p>— Russ Cox</p>
</blockquote>
<p>Russ is making the distinction between software <em>programming</em> and software <em>engineering</em>. The former is a program you write for yourself, the latter is a product that many people will work with over time. Engineers will come and go, teams will grow and shrink, requirements will change, features will be added and bugs fixed. This is the nature of software engineering.</p>
<p>I've been using Go for over 5 years now, but I'm not trying to argue that seniority gives my views more weight. Rather, the advice I'm going over in this document is informed by what I believe to be the guiding principles of Go, as well as the principles of Jane.</p>
<p>So what are the guiding principles of Go?</p>
<ol>
<li>Simplicity</li>
<li>Clarity</li>
<li>Productivity</li>
</ol>
<div class="NOTE">
<p>You'll notice that I didn't say <em>performance</em>, <em>concurrency</em>, or anything else. There are languages quicker than Go, but they're certainly not as simple. There are languages which make concurrency their highest goal but they're not as readable nor as productive as Go.</p>
</div>
<section id="simplicity" class="level2" data-number="2.1">
<h2 data-number="2.1"><span class="header-section-number">2.1</span> Simplicity</h2>
<p>Why should we strive for simplicity? Why is this a core Go value?</p>
<blockquote>
<p>Controlling complexity is the essence of computer programming.</p>
<p>— Brian Kernighan</p>
</blockquote>
<p>We've all been in a situation where we said "I can't understand this code", right? Regardless of whether we only said it to ourselves or not, it's happened. We've all worked on programs that where we were too nervous about making any changes because we might break something elsewhere. A part you don't understand and don't know how to fix. This is complexity.</p>
<blockquote>
<p>There are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies, and the other way is to make it so complicated that there are no obvious deficiencies. The first method is far more difficult.</p>
<p>— C. A. R. Hoare</p>
</blockquote>
<p>Complexity turns reliable software into unreliable software. It kills projects, and causes burnout.</p>
<p>Therefore simplicity is the highest goal of Go. Whatever code we end up writing, we should be able to agree that the code we write is simple as we can make it.</p>
</section>
<section id="clarity" class="level2" data-number="2.2">
<h2 data-number="2.2"><span class="header-section-number">2.2</span> Clarity</h2>
<blockquote>
<p>Programs must be written for people to read, and only incidentally for machines to execute.</p>
<p>— Hal Abelson and Gerald Sussman Structure and Interpretation of Computer Programs</p>
</blockquote>
<p>Code is going to be read far more times than it is written. A single line of code will be read hundreds if not thousands of times.</p>
<p>So clarity is important because all software, not just Go programs, are written by humans to be read by other humans. The fact that the code is also consumed by a computer is secondary.</p>
<p>If you want to write a program for yourself, or that only has to run once, or you're the only person who's ever going to see &amp; maintain it – go nuts, do whatever works best for you.</p>
<p>But if other people need to contribute to the code, or it's going to be used by folks over enough time that requirements, features, or the environment it runs in may change; then the goal for the program needs to be that it's <em>maintainable</em>.</p>
<p>In other words, every repository of Go code at Jane must be maintainable – because even if we discover the secret to immortality you're not going to want to have to maintain some Go code in a Jane repository forever. You're going to want to be able to hand it off to other developers.</p>
<p>Therefore we should be striving to write clear code.</p>
</section>
<section id="productivity" class="level2" data-number="2.3">
<h2 data-number="2.3"><span class="header-section-number">2.3</span> Productivity</h2>
<p>The last underlying principle to highlight is productivity. Developer productivity is a sprawling topic but it boils down to this; how much time do you spend doing useful work, verses waiting for your tools or hopelessly lost in a foreign code-base. Go programmers should feel that they can get a lot done with Go.</p>
<p>The joke goes that Go was designed while waiting for a C++ program to compile. Fast compilation is a key feature of Go and a key recruiting tool to attract new developers. While compilation speed remains a constant battleground, it is fair to say that operations which take minutes in other languages, take seconds in Go. This helps Go developers feel as productive as their counterparts working in dynamic languages without the reliability issues inherent in those languages.</p>
<p>More fundamental to the question of developer productivity, Go programmers realize that code is written to be read and so place the act of reading code above the act of writing it. Go goes so far as to enforce, via tooling and custom, that all code be formatted in a specific style. This removes the friction of learning a project specific dialect and helps spot mistakes because they just look incorrect.</p>
<p>Go programmers don’t spend days debugging inscrutable compile errors. They don’t waste days with complicated build scripts or deploying code to production. And most importantly they don’t spend their time trying to understand what their coworker wrote.</p>
<p>That isn't to say Go developers <em>never</em> spend days trying to figure out some weird obscure problem in Go. That's obviously not true; just Google `golang debug memory leak` and you should find at least a handful of folks talking about all the time they spent tracking down a memory leak.</p>
<p>Rather, Go tries to eliminate as many unproductive parts of the development process as it can. Go tries to be expressive when throwing a compile error so that it's easy to fix the problem. Go tries to make it so all you need is <code class="verbatim">go
build</code>. If your project is architected properly, that's all you should need to get a <em>working</em> – but not necessarily <em>correct</em> – binary. So we're left with the most important part of being productive: <strong>understanding code so you can make changes to it</strong>.</p>
<p>To say that Go is a language designed to be productive is an understanding it is built for software design in the large, at industrial scale.</p>
<p>Productivity is what the Go team mean when they say the language must scale.</p>
</section>
</section>
<section id="style-syntax" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Style &amp; Syntax</h1>
<p>This section is heavy on guidelines, light on prescriptive rules. The reason is that what constitutes "a good name" or "enough documentation" is highly subjective – but we can draw some boundaries around what we all find acceptable.</p>
<p>Additionally, there are many tools that we should be able to use to enforce the rough boundaries of these guidelines for us. This would mean being able to fix our code before anybody else ever sees it.</p>
<p>The same way that <code class="verbatim">gofmt</code> eliminated the arguments over tabs vs spaces, we can ( and should! ) use other tools to enforce the kind of style guidelines we talk about here.</p>
<section id="identifiers" class="level2" data-number="3.1">
<h2 data-number="3.1"><span class="header-section-number">3.1</span> Identifiers</h2>
<p>Go is not a language that optimizes for clever one liners. It doesn't optimize for programs with the least number of lines. When we're writing Go, we're not optimizing for the size of the source code on disk, or how long it takes to type the program out.</p>
<p>Rather, we want to optimize our code being clear to the reader.</p>
<blockquote>
<p>Good naming is like a good joke. If you have to explain it, it’s not funny.</p>
<p>— Dave Cheney</p>
</blockquote>
<p>Key to this clarity is the names we choose for identifiers in Go code.</p>
<p>So what are some of the qualities of a good name?</p>
<ul>
<li><strong>A good name is concise.</strong> This doesn't mean that it's as short as possible, rather that no space is wasted on extraneous details. Good names have a high signal to noise ratio.</li>
<li><strong>A good name is descriptive.</strong> A good name should describe the <em>application</em> of a variable or constant, <em>not</em> their contents. A good name should describe the <em>result</em> of a function, <em>not</em> the implementation. A good name should describe the <em>purpose</em> of a package, <em>not</em> its contents. The better the choice of a name, the more accurately it describes the thing it identifies.</li>
<li><strong>A good name should be predictable.</strong> You should be able to infer the way a symbol will be used from its name alone. This is a function of choosing describe names, but also about following tradition. This is what Go programmers talk about when they say <em>idiomatic</em>.</li>
</ul>
<p>Another way to put this is <a href="https://talks.golang.org/2014/names.slide#3">like this</a>: a good name is</p>
<ul>
<li>Consistent (easy to guess)</li>
<li>Short (easy to type)</li>
<li>Accurate (easy to understand)</li>
</ul>
<p>Okay, that's a good start, but let's talk about this in a bit more depth.</p>
<section id="identifier-length" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1"><span class="header-section-number">3.1.1</span> Identifier Length</h3>
<p>Sometimes people criticise the Go style for recommending short variable names. As Rob Pike said, "Go programmers want the right length identifiers".</p>
<p>Andrew Gerrand suggests that by using <a href="https://talks.golang.org/2014/names.slide#4">longer identifies</a> to indicate to the reader things of higher importance.</p>
<blockquote>
<p>The greater the distance between a name’s declaration and its uses, the longer the name should be.</p>
<p>— Andrew Gerrand</p>
</blockquote>
<p>So from this we can draw up some guidelines:</p>
<ul>
<li>Short variable names work well when the distance between their declaration and last use is short.</li>
<li>Long variable names need to justify themselves; the longer they are the more value they need to provide. Lengthy bureaucratic names carry a low amount of signal compared to their weight on the page.</li>
<li>Don’t include the name of your type in the name of your variable.</li>
<li>Constants should describe the value they hold, not how that value is used.</li>
<li>Prefer single letter variables for loops and branches, single words for parameters and return values, multiple words for functions and package level declarations</li>
<li>Prefer one word over two, two over three, etc</li>
<li>Prefer single words for methods, interfaces, and packages.</li>
<li>Remember that the name of a package is part of the name the caller uses to to refer to it, so make use of that.</li>
</ul>
<p>And an example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Person <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a> Name <span class="dt">string</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a> Age  <span class="dt">int</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">// AverageAge returns the average age of people.</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> AverageAge<span class="op">(</span>people <span class="op">[]</span>Person<span class="op">)</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> <span class="bu">len</span><span class="op">(</span>people<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="dv">0</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> count<span class="op">,</span> sum <span class="dt">int</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> p <span class="op">:=</span> <span class="kw">range</span> people <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  sum <span class="op">+=</span> p<span class="op">.</span>Age</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  count <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> sum <span class="op">/</span> count</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this example, the range variable <code class="verbatim">p</code> is declared on line 10 and only referenced once, on the following line. <code class="verbatim">p</code> lives for a very short time on the page and in limited scope during the execution of the function. A reader who is interested in the effect values of <code class="verbatim">p</code> have on the program need only read the three loop’s three lines.</p>
<p>By comparison <code class="verbatim">people</code> is declared in the function parameters, is live for the body of the function, and is referenced three times over seven lines. The same is true for <code class="verbatim">sum</code>, and <code class="verbatim">count</code>, thus they justify their longer names. The reader has to scan a wider number of lines to locate them so they are given more distinctive names.</p>
<p>I could have chosen <code class="verbatim">s</code> for <code class="verbatim">sum</code> and <code class="verbatim">c</code> (or possibly <code class="verbatim">n</code>) for <code class="verbatim">count</code> but this would have reduced all the variables in the program to the same level of importance. I could have chosen p instead of people but that would have left the problem of what to call the <code class="verbatim">for …​ range</code> iteration variable and the singular <code class="verbatim">person</code> would look odd as the loop iteration variable which lives for little time has a longer name than the slice of values it was derived from.</p>
<div class="NOTE">
<p>Use blank lines to break up the flow of a function in the same way you use paragraphs to break up the flow of a document. In <code class="verbatim">AverageAge</code> we have three operations occurring in sequence. The first is the precondition, checking that we don’t divide by zero if people is empty, the second is the accumulation of the sum and count, and the final is the computation of the average.</p>
</div>
</section>
<section id="context-is-key-no-not-that-context" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2"><span class="header-section-number">3.1.2</span> Context Is Key (No Not That Context)</h3>
<p>It’s important to recognise that most advice on naming is contextual. Naming is always going to be a guideline. Trying to make rules about naming things just leads to the rules being ignored until right before code is pushed up and the developer spends half an hour re-naming things using their IDE's refactoring tools.</p>
<p>What is the difference between two identifiers, <code class="verbatim">i</code>, and <code class="verbatim">index</code>. We cannot say conclusively that one is better than another.</p>
<p>Take this loop, for example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> index <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> index <span class="op">&lt;</span> <span class="bu">len</span><span class="op">(</span>s<span class="op">);</span> index<span class="op">++</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a> <span class="co">//</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Is that fundamentally more readable than:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="bu">len</span><span class="op">(</span>s<span class="op">);</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a> <span class="co">//</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We'd argue it isn't, because it is likely the scope of <code class="verbatim">i</code>, and <code class="verbatim">index</code> for that matter, is limited to the body of the <code class="verbatim">for</code> loop and the extra verbosity of the latter adds little to <em>comprehension</em> of the program.</p>
<p>However, which of these functions is more readable?</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>s <span class="op">*</span>SNMP<span class="op">)</span> Fetch<span class="op">(</span>oid <span class="op">[]</span><span class="dt">int</span><span class="op">,</span> index <span class="dt">int</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span></code></pre></div>
<p>versus</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>s <span class="op">*</span>SNMP<span class="op">)</span> Fetch<span class="op">(</span>o <span class="op">[]</span><span class="dt">int</span><span class="op">,</span> i <span class="dt">int</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span></code></pre></div>
<p>In this example, <code class="verbatim">oid</code> is an abbreviation for SNMP Object ID, so shortening it to <code class="verbatim">o</code> would mean programmers have to translate from the common notation that they read in documentation to the shorter notation in your code. Similarly, reducing <code class="verbatim">index</code> to <code class="verbatim">i</code> obscures what <code class="verbatim">i</code> stands for; in SNMP messages a sub value of each OID is called an Index.</p>
<div class="NOTE">
<p>Dont' mix and match long and short formal parameters in the same declaration.</p>
</div>
</section>
<section id="a-variables-name-should-describe-its-contents" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3"><span class="header-section-number">3.1.3</span> A Variable's Name Should Describe Its Contents</h3>
<p>You shouldn’t name your variables after their types for the same reason you don’t name your pets "dog" and "cat". You shouldn’t include the name of your type in the name of your variable’s name for the same reason.</p>
<p>The name of the variable should describe its contents, not the type of its contents. Consider this example:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> usersMap <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]*</span>User</span></code></pre></div>
<p>What’s good about this declaration? We can see that its a map, and it has something to do with the <code class="verbatim">*User</code> type, that’s probably good. But <code class="verbatim">usersMap</code> is a map, and Go being a statically typed language won’t let us accidentally use it where a different type is required. The <code class="verbatim">Map</code> suffix is redundant from the point of view of the compiler. Hence utility of the suffix is entirely down to whether we can prove it is of use to the reader.</p>
<p>Now, consider what happens if we were to declare other variables:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> <span class="op">(</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>        companiesMap <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]*</span>Company</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        productsMap  <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]*</span>Products</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span></code></pre></div>
<p>Now we have three map type variables in scope, <code class="verbatim">usersMap</code>, <code class="verbatim">companiesMap</code>, and <code class="verbatim">productsMap</code>, all mapping strings to different types. We know they are maps; it’s right there in their declaration. We also know that their map declarations prevent us from using one in place of another—​the compiler will throw an error if we try to use <code class="verbatim">companiesMap</code> where code was expecting a <code class="verbatim">map[string]*User</code>. In this situation it’s clear that the <code class="verbatim">Map</code> suffix does not improve the clarity of the code, its just extra boilerplate to type.</p>
<p>Our suggestion is to avoid any suffix that resembles the type of the variable.</p>
<p>This advice also applies to function parameters. For example:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Config <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// lots of fields go here</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteConfig<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> config <span class="op">*</span>Config<span class="op">)</span></span></code></pre></div>
<p>Naming the <code class="verbatim">*Config</code> parameter <code class="verbatim">config</code> is redundant. We know its a <code class="verbatim">*Config</code>, it says so right there.</p>
<p>In this case consider <code class="verbatim">conf</code> or maybe <code class="verbatim">c</code> will do if the lifetime of the variable is short enough.</p>
<p>If there is more that one <code class="verbatim">*Config</code> in scope at any one time then calling them <code class="verbatim">conf1</code> and <code class="verbatim">conf2</code> is less descriptive than calling them <code class="verbatim">original</code> and <code class="verbatim">updated</code> as the latter are less likely to be mistaken for one another.</p>
<div class="NOTE">
<p>Don’t let package names steal good variable names.</p>
<p>The name of an imported identifier includes its package name. For example the <code class="verbatim">Context</code> type in the <code class="verbatim">context</code> package will be known as <code class="verbatim">context.Context</code>. This makes it impossible to use <code class="verbatim">context</code> as a variable or type in your package.</p>
<p><code class="verbatim">func WriteLog(context context.Context, message string)</code></p>
<p>Will not compile. This is why the local declaration for <code class="verbatim">context.Context</code> types is traditionally <code class="verbatim">ctx</code>. eg.</p>
<p><code class="verbatim">func WriteLog(ctx context.Context, message string)</code></p>
</div>
</section>
<section id="hiding-in-plain-sight" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4"><span class="header-section-number">3.1.4</span> Hiding In Plain Sight</h3>
<p>This is a tip from <a href="https://www.youtube.com/watch?v=Ic2y6w8lMPA">Kate Gregory</a>. Sometimes you’ll find a better name for a variable hiding in a comment.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// registry of SQL drivers</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> registry <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]*</span>sql<span class="op">.</span>Driver<span class="op">)</span></span></code></pre></div>
<p>The comment was added by the author because <code class="verbatim">registry</code> doesn’t explain enough about its purpose—​it’s a registry, but a registry of what?</p>
<p>By renaming the variable to <code class="verbatim">sqlDrivers</code> its now clear that the purpose of this variable is to hold SQL drivers.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sqlDrivers <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]*</span>sql<span class="op">.</span>Driver<span class="op">)</span></span></code></pre></div>
<p>Now the comment is redundant and can be removed.</p>
</section>
<section id="use-a-consistent-naming-style" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5"><span class="header-section-number">3.1.5</span> Use A Consistent Naming Style</h3>
<p>Another property of a good name is it should be predictable. The reader should be able to understand the use of a name when they encounter it for the first time. When they encounter a <em>common</em> name, they should be able to assume it has not changed meanings since the last time they saw it. You could also say that a good name should feel familiar.</p>
<p>For example, if your code passes around a database handle, make sure each time the parameter appears it has the same name. Don't use a combination of <code class="verbatim">d *sql.DB</code>, <code class="verbatim">dbase *sql.DB</code>, <code class="verbatim">DB *sql.DB</code>, and <code class="verbatim">database *sql.DB</code>. Rather, consolidate on the following:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>db <span class="op">*</span>sql<span class="op">.</span>DB</span></code></pre></div>
<p>…and use it consistently across parameters, return values, local declarations, and potentially receivers. Doing so promotes familiarity; if you see a <code class="verbatim">db</code>, you know it’s a <code class="verbatim">*sql.DB</code> ( or at least something that acts like one ) and that it has either been declared locally or provided for you by the caller.</p>
<p>Similar advice applies to method receivers; use the same receiver name every method on that type. This makes it easier for the reader to internalize the use of the receiver across the methods in this type.</p>
<div class="NOTE">
<p>The convention for short receiver names in Go is at odds with the advice provided so far. This is just one of the choices made early on that has become the preferred style, just like the use of <code class="verbatim">CamelCase</code> rather than <code class="verbatim">snake_case</code>. It also has some logic to it, as the identifier for a reciever will be seen many more times, allowing developers to internalize that (for example) <code class="verbatim">c</code> means <code class="verbatim">*Client</code>.</p>
<p><a href="https://github.com/golang/go/wiki/CodeReviewComments#receiver-names">The Go Code Review</a> style dictates that receivers have a one or two letter name, or acronyms derived from their type. You may find that the name of your receiver sometimes conflicts with name of a parameter in a method. In this case, consider making the parameter name slightly longer, and don’t forget to use this new parameter name consistently.</p>
</div>
<p>Finally, certain single letter variables have traditionally been associated with loops and counting. For example, <code class="verbatim">i</code>, <code class="verbatim">j</code>, and <code class="verbatim">k</code> are commonly the loop induction variable for simple <code class="verbatim">for</code> loops. <code class="verbatim">n</code> is commonly associated with a counter or accumulator. <code class="verbatim">v</code> is a common shorthand for a value in a generic encoding function, <code class="verbatim">k</code> is commonly used for the key of a map. <code class="verbatim">a</code> and <code class="verbatim">b</code> are generic names for parameters comparing two variables of the same type. <code class="verbatim">x</code> and <code class="verbatim">y</code> are generic names for local variables created for comparision, and <code class="verbatim">s</code> is often used as shorthand for parameters of type string.</p>
<p>As with the <code class="verbatim">db</code> example above programmers <em>expect</em> <code class="verbatim">i</code> to be a loop induction variable. So ensuring that <code class="verbatim">i</code> is always a loop variable, and not used in other contexts outside a <code class="verbatim">for</code> loop saves everybody time and headaches. When readers encounter a variable called <code class="verbatim">i</code>, or <code class="verbatim">j</code>, they know that a loop is close by.</p>
<div class="NOTE">
<p>If you found yourself with so many nested loops that you exhaust your supply of <code class="verbatim">i</code>, <code class="verbatim">j</code>, and <code class="verbatim">k</code> variables, its probably time to break your function into smaller ones.</p>
</div>
</section>
<section id="use-a-consistent-declaration-style" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6"><span class="header-section-number">3.1.6</span> Use A Consistent Declaration Style</h3>
<p>Go has at least six different ways to declare a variable</p>
<ul>
<li><code>x := 1</code></li>
<li><code>var y = 2</code></li>
<li><code>var z int = 3</code></li>
<li><code>var a int; a = 4</code></li>
<li><code>var b = int(5)</code></li>
<li><code>c := int(6)</code></li>
</ul>
<p>This list does not include receivers, formal parameters and named return values. There are probably plenty more that we haven’t thought of.</p>
<p>This is something that Go’s designers recognise was probably a mistake, but its too late to change it now, and, they argue, the bigger problem is shadowing. With all these different ways of declaring a variable, how do we avoid each Go programmer choosing their own style?</p>
<p>In Go each variable has a purpose because each variable we declare has to be used within the same scope. Here is a suggestion for how to make the purpose of each declaration clear to the reader. This is the style we should try to use where possible.</p>
</section>
<section id="prefer-either-var-or-for-declaring-and-initializing-respectively" class="level3" data-number="3.1.7" id="fad3dbd8-5df7-4c45-9a98-ccdca80342db">
<h3 data-number="3.1.7" id="fad3dbd8-5df7-4c45-9a98-ccdca80342db"><span class="header-section-number">3.1.7</span> Prefer either <code class="verbatim">var</code> or <code>:=</code> for declaring and initializing, respectively</h3>
<p>When declaring a variable that will be explicitly initialised later, use the var keyword.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> players <span class="dt">int</span>    <span class="co">// 0</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">[]</span>Thing <span class="co">// an empty slice of Things</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> thing Thing    <span class="co">// empty Thing struct</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>json<span class="op">.</span>Unmarshall<span class="op">(</span>reader<span class="op">,</span> <span class="op">&amp;</span>thing<span class="op">)</span></span></code></pre></div>
<p>The <code class="verbatim">var</code> acts as a clue to say that this variable has been <em>deliberately</em> declared as the zero value of the indicated type. This is also consistent with the requirement to declare variables at the package level using <em>var</em> as opposed to the short declaration syntax.</p>
<p>Later on we'll be making the case that you shouldn't use package-level variables at all, as well.</p>
<p>When declaring <em>and</em> initialising the variable at the same time — ​that is to say we’re not letting the variable be implicitly initialised to its zero value — we recommend using the short variable declaration form. This makes it clear to the reader that the variable on the left hand side of the <code>:=</code> is being deliberately initialised to the expression on the right.</p>
</section>
<section id="explanations-examples" class="level3" data-number="3.1.8">
<h3 data-number="3.1.8"><span class="header-section-number">3.1.8</span> Explanations &amp; Examples</h3>
<p>Let's take that example from the section above, and walk through how we end up at our two rules of only using <code class="verbatim">var</code> for uninitialized values and <code>:=</code> for values that need to be initialized.</p>
<p>So let's start by taking the example, and being as explicit as possible about initializing each variable:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> players <span class="dt">int</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">[]</span>Thing <span class="op">=</span> <span class="ot">nil</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> thing <span class="op">*</span>Thing <span class="op">=</span> <span class="bu">new</span><span class="op">(</span>Thing<span class="op">)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>json<span class="op">.</span>Unmarshall<span class="op">(</span>reader<span class="op">,</span> thing<span class="op">)</span></span></code></pre></div>
<p>In the first and third examples, because in Go there are no automatic conversions from one type to another; the type on the left hand side of the assignment operator <em>must</em> be identical to the type on the right hand side. The compiler can infer the type of the variable being declared from the type on the right hand side, to the example can be written more concisely like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> players <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">[]</span>Thing <span class="op">=</span> <span class="ot">nil</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> thing <span class="op">=</span> <span class="bu">new</span><span class="op">(</span>Thing<span class="op">)</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>json<span class="op">.</span>Unmarshall<span class="op">(</span>reader<span class="op">,</span> thing<span class="op">)</span></span></code></pre></div>
<p>This leaves us with explicitly initialising <code class="verbatim">players</code> to <code class="verbatim">0</code> which is redundant because <code class="verbatim">0</code> is <code class="verbatim">players</code> zero value. So it’s better to make it clear that we’re going to use the zero value by instead writing</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> players <span class="dt">int</span></span></code></pre></div>
<p>What about the second statement? We cannot elide the type and write</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">=</span> <span class="ot">nil</span></span></code></pre></div>
<p>Because <code class="verbatim">nil</code> does not have a type. Instead we have a choice, do we want the zero value for a slice?</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">[]</span>Thing</span></code></pre></div>
<p>or do we want to create a slice with zero elements?</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> things <span class="op">=</span> <span class="bu">make</span><span class="op">([]</span>Thing<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p>If we wanted the latter then this is <em>not</em> the zero value for a slice so we should make it clear to the reader that we’re making this choice by using the short declaration form:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>things <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span>Thing<span class="op">,</span> <span class="dv">0</span><span class="op">)</span></span></code></pre></div>
<p>Which tells the reader that we have chosen to initialize <code class="verbatim">things</code> explicitly.</p>
<p>However, this is still a bit long, and we can shorten it up quite a bit:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>things <span class="op">:=</span> <span class="op">[]</span>Thing<span class="op">{}</span></span></code></pre></div>
<p>That lets any other developers who come along know that we wanted an empty slice and <strong>not</strong> the zero value for a slice ( ie, <code class="verbatim">nil</code> ). That said, most of the time the difference between an empty slice and a nil slice is academic as we usually immediately do something with the slice. In other words, we usually follow it up with something like this:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>things <span class="op">:=</span> <span class="op">[]</span>Thing<span class="op">{}</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> json<span class="op">.</span>Unmarshal<span class="op">(</span>bits<span class="op">,</span> <span class="op">&amp;</span>things<span class="op">)</span></span></code></pre></div>
<p>So we fall back to "we want to declare but not initialize", as <code class="verbatim">json.Unmarshal</code> is what's <em>actually</em> initializing the variable with a value. So most of the time <code class="verbatim">var things []Thing</code> is fine.</p>
<p>This brings us to the third declaration,</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> thing <span class="op">=</span> <span class="bu">new</span><span class="op">(</span>Thing<span class="op">)</span></span></code></pre></div>
<p>Which is both explicitly initialising a variable and introduces the uncommon use of the <code class="verbatim">new</code> keyword which some Go programmer dislike. If we apply our short declaration syntax recommendation then the statement becomes</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>thing <span class="op">:=</span> <span class="bu">new</span><span class="op">(</span>Thing<span class="op">)</span></span></code></pre></div>
<p>Which makes it clear that thing is explicitly initialised to the result of the expression <code class="verbatim">new(Thing)</code> – a pointer to a <code class="verbatim">Thing</code> – but still leaves us with the unusual use of <code class="verbatim">new</code>. We could address this by using the compact literal struct initialiser form:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>thing <span class="op">:=</span> <span class="op">&amp;</span>Thing<span class="op">{}</span></span></code></pre></div>
<p>Which does the same as <code class="verbatim">new(Thing)</code>, hence why some Go programmers are upset by the duplication. However this means we’re explicitly initialising <code class="verbatim">thing</code> with a pointer to the literal <code class="verbatim">Thing{}</code>, which itself is the zero value for a <code class="verbatim">Thing</code>.</p>
<p>Instead we should recognise that thing is being declared as its zero value and use the address of operator to pass the address of thing to <code class="verbatim">json.Unmarshall</code></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> thing Thing</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>json<span class="op">.</span>Unmarshall<span class="op">(</span>reader<span class="op">,</span> <span class="op">&amp;</span>thing<span class="op">)</span></span></code></pre></div>
</section>
<section id="avoid-make-and-new-when-possible" class="level3" data-number="3.1.9">
<h3 data-number="3.1.9"><span class="header-section-number">3.1.9</span> Avoid <code class="verbatim">make</code> and <code class="verbatim">new</code> when possible</h3>
<p><a href="https://dave.cheney.net/2014/08/17/go-has-both-make-and-new-functions-what-gives">This article goes more in-depth</a>, but to pull out the summary:</p>
<blockquote>
<p><code class="verbatim">make</code> and <code class="verbatim">new</code> do different things.</p>
<p>If you are coming from another language, especially one that uses constructors, it may appear that <code class="verbatim">new</code> should be all you need, but Go is not those languages, nor does it have constructors.</p>
<p>My advice is to use <code class="verbatim">new</code> sparingly, there are almost always easier or cleaner ways to write your program without it.</p>
<p>As a code reviewer, the use of <code class="verbatim">new</code>, like the use of named return arguments, is a signal that the code is trying to do something clever and I need to pay special attention. It may be that code really is clever, but more than likely, it can be rewritten to be clearer…</p>
</blockquote>
<p>Additionally, using <code class="verbatim">make</code> can lead to unexpected bugs when used to initialize slices &amp; arrays with a non-zero length. What does the following code output:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">(){</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  toChange <span class="op">:=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;one&quot;</span><span class="op">,</span><span class="st">&quot;two&quot;</span><span class="op">,</span><span class="st">&quot;three&quot;</span><span class="op">}</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  list <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span><span class="dt">string</span><span class="op">,</span> <span class="bu">len</span><span class="op">(</span>toChange<span class="op">))</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>l<span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    list <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>list<span class="op">,</span> strings<span class="op">.</span>Repeat<span class="op">(</span>toChange<span class="op">[</span>i<span class="op">],</span> i<span class="op">+</span><span class="dv">1</span><span class="op">))</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;values: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> strings<span class="op">.</span>Join<span class="op">(</span>list<span class="op">,</span> <span class="st">&quot; - &quot;</span><span class="op">))</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Did you guess this:</p>
<pre class="shell"><code>values:  one - twotwo - threethreethree
</code></pre>
<p>Because what it actually prints out is this:</p>
<pre class="shell"><code>values:  -  -  - one - twotwo - threethreethree
</code></pre>
<p>Because the value of <code class="verbatim">list</code> after it's initialized by <code class="verbatim">make</code> is <code class="verbatim">[]string{"","",""}</code> – because <code class="verbatim">make</code> fills in the slice with the zero value for that slice. So, rather than using make, use <code class="verbatim">var list []string</code> when initializing an empty slice.</p>
</section>
<section id="exceptions-to-the-rule" class="level3" data-number="3.1.10">
<h3 data-number="3.1.10"><span class="header-section-number">3.1.10</span> Exceptions To The Rule</h3>
<p>Of course, with any rule of thumb, there are exceptions. For example, sometimes two variables <em>of the same type</em> are closely related so writing</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> min <span class="dt">int</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>max <span class="op">:=</span> <span class="dv">1000</span></span></code></pre></div>
<p>would look odd. The declaration may be more readable like this</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>min<span class="op">,</span> max <span class="op">:=</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1000</span></span></code></pre></div>
<p>However, we'd recommend not initializing more than two ( maaaaybe three ) variables in this manner.</p>
</section>
<section id="make-tricky-code-look-tricky" class="level3" data-number="3.1.11">
<h3 data-number="3.1.11"><span class="header-section-number">3.1.11</span> Make Tricky Code <em>Look</em> Tricky</h3>
<p>Make tricky declarations obvious!</p>
<p>When something is complicated, it should look complicated.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> length <span class="dt">uint32</span> <span class="op">=</span> <span class="dv">0x80</span></span></code></pre></div>
<p>Here length may be being used with a library which requires a specific numeric type and is more explicit that <code class="verbatim">length</code> is being explicitly declared to be <code class="verbatim">uint32</code>, rather than using the short declaration form:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>length <span class="op">:=</span> <span class="dt">uint32</span><span class="op">(</span><span class="dv">0x80</span><span class="op">)</span></span></code></pre></div>
<p>In the first example we're deliberately breaking the rule of using the <code class="verbatim">var</code> declaration form with an explicit initialiser. This decision to vary from the usual form is a clue to the reader that something unusual is happening.</p>
<p>However, such cases should usually have a comment that explains <em>why</em> this complexity is required.</p>
</section>
<section id="summary" class="level3" data-number="3.1.12">
<h3 data-number="3.1.12"><span class="header-section-number">3.1.12</span> Summary</h3>
<ul>
<li>When declaring a variable without initialisation, use the <code class="verbatim">var</code> syntax.</li>
<li>When declaring and explicitly initialising a variable, use <code>:=</code>.</li>
</ul>
<p>We've talked about a goal of software engineering is to produce maintainable code. Therefore you will likely spend most of your career working on projects of which you are not the sole author. Our advice in this situation is: follow the local style.</p>
<p>Changing styles in the middle of a file is jarring. Uniformity, even if its not your preferred approach, is more valuable for maintenance over the long run than your personal preference. The rule we should all try to follow is; if it fits through <code class="verbatim">go fmt</code> then it’s usually not worth holding up a code review for.</p>
<p>Additionally, there are tools such as <a href="https://github.com/rinchsan/gosimports">gosimports</a> (not <code class="verbatim">goimports</code> ), <a href="https://github.com/mvdan/gofumpt">gofumpt</a>, and <a href="https://golangci-lint.run/">golangci-lint</a> that we can use to try and catch some of these things before a code review. As we haven't figured out a Jane-wide set of tools – or the configurations for each of those tools – yet, for now use your best judgement.</p>
<div class="TIP">
<p>If you want to do a renaming across a codebase, do not mix this into another change. If someone is using git bisect they don’t want to wade through thousands of lines of renaming to find the code you changed as well.</p>
</div>
</section>
</section>
<section id="comments" class="level2" data-number="3.2">
<h2 data-number="3.2"><span class="header-section-number">3.2</span> Comments</h2>
<p>Before we move on to larger items, we should spend a little time talking about comments.</p>
<blockquote>
<p>Good code has lots of comments, bad code requires lots of comments.</p>
<p>— Dave Thomas and Andrew Hunt, <a href="https://www.amazon.ca/Pragmatic-Programmer-Journeyman-Master/dp/020161622X">The Pragmatic Programmer</a></p>
</blockquote>
<p>Comments are very important to the readability of a Go program. Each comment should do one — ​and only one —​ of the following three things:</p>
<ol>
<li>The comment should explain <em>what</em> the thing does.</li>
<li>The comment should explain <em>how</em> the thing does what it does.</li>
<li>The comment should explain <em>why</em> the thing is the way it is.</li>
</ol>
<section id="quick-dive" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1"><span class="header-section-number">3.2.1</span> Quick Dive</h3>
<section id="what" class="level4" data-number="3.2.1.1">
<h4 data-number="3.2.1.1"><span class="header-section-number">3.2.1.1</span> What</h4>
<p>The first form is ideal for commentary on public symbols:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Open opens the named file for reading.</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="co">// If successful, methods on the returned file can be used for reading.</span></span></code></pre></div>
</section>
<section id="how" class="level4" data-number="3.2.1.2">
<h4 data-number="3.2.1.2"><span class="header-section-number">3.2.1.2</span> How</h4>
<p>The second form is ideal for commentary inside a method:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// queue all dependant actions</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> results <span class="op">[]</span><span class="kw">chan</span> <span class="dt">error</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> _<span class="op">,</span> dep <span class="op">:=</span> <span class="kw">range</span> a<span class="op">.</span>Deps <span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>results<span class="op">,</span> execute<span class="op">(</span>seen<span class="op">,</span> dep<span class="op">))</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="why" class="level4" data-number="3.2.1.3">
<h4 data-number="3.2.1.3"><span class="header-section-number">3.2.1.3</span> Why</h4>
<p>The third form, the <em>why</em>, is unique as it does not displace the first two, but at the same time it’s not a replacement for the <em>what</em>, or the <em>how</em>. The <em>why</em> style of commentary exists to explain the external factors that drove the code you read on the page. Frequently those factors rarely make sense taken out of context, the comment exists to provide that context.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span> <span class="op">&amp;</span>v2<span class="op">.</span>Cluster_CommonLbConfig<span class="op">{</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Disable HealthyPanicThreshold</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// See https://www.envoyproxy.io/docs/envoy/v1.9.0/intro/arch_overview/load_balancing/panic_threshold#arch-overview-load-balancing-panic-threshold</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  HealthyPanicThreshold<span class="op">:</span> <span class="op">&amp;</span>envoy_type<span class="op">.</span>Percent<span class="op">{</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    Value<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">},</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this example it may not be immediately clear what the effect of setting <code class="verbatim">HealthyPanicThreshold</code> to zero percent will do. The comment is needed to clarify that the value of <code class="verbatim">0</code> will disable the panic threshold behaviour.</p>
<p>Comments such as these record hard won battles for understanding deep in the business logic. When you have the opportunity to write them, be sure to include enough hints that the next reader can follow your research. Links to issues, design documents, RFCs, or specifications that provide more background are always helpful.</p>
</section>
</section>
<section id="comments-on-variables-constants-should-describe-the-contents" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2"><span class="header-section-number">3.2.2</span> Comments On Variables &amp; Constants Should Describe The Contents</h3>
<p>When you add a comment to a variable or constant, that comment should describe the variables <em>contents</em>, not the variables <em>purpose</em>.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> RandomNumber <span class="op">=</span> <span class="dv">6</span> <span class="co">// determined from roll of an unbiased die 🎲</span></span></code></pre></div>
<p>In this example the comment describes why <code class="verbatim">RandomNumber</code> is assigned the value six, and where the six was derived from. The comment does <em>not</em> describe where <code class="verbatim">RandomNumber</code> will be used. This is deliberate; <code class="verbatim">RandomNumber</code> may be used many times by any package that references it. It is not possible to keep a record of all those uses at the site that <code class="verbatim">RandomNumber</code> is declared. Instead the name of the constant should be a guide the appropriate use for potential users.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="op">(</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    StatusContinue           <span class="op">=</span> <span class="dv">100</span> <span class="co">// RFC 7231, 6.2.1</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    StatusSwitchingProtocols <span class="op">=</span> <span class="dv">101</span> <span class="co">// RFC 7231, 6.2.2</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    StatusProcessing         <span class="op">=</span> <span class="dv">102</span> <span class="co">// RFC 2518, 10.1</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    StatusOK                 <span class="op">=</span> <span class="dv">200</span> <span class="co">// RFC 7231, 6.3.1</span></span></code></pre></div>
<p>In general use the untyped constant <code class="verbatim">100</code> is just the number one hundred. <em>In the context of HTTP</em> the number <code class="verbatim">100</code> is known as <code class="verbatim">StatusContinue</code>, as defined in RFC 7231, section 6.2.1. The comment included with that declaration helps the reader understand <em>why</em> <code class="verbatim">100</code> has special significance as a HTTP response code.</p>
<section id="note-1-uninitialized-variables" class="level4" data-number="3.2.2.1">
<h4 data-number="3.2.2.1"><span class="header-section-number">3.2.2.1</span> Note 1: Uninitialized Variables</h4>
<p>For variables without an initial value, the comment should describe who is responsible for initialising this variable.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// sizeCalculationDisabled indicates whether it is safe</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">// to calculate Types&#39; widths and alignments. See dowidth.</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sizeCalculationDisabled <span class="dt">bool</span></span></code></pre></div>
<p>This example comes deep from the bowels of the Go compiler. Here, the comment lets the reader know that the <code class="verbatim">dowidth</code> function is responsible for maintaining the state of <code class="verbatim">sizeCalculationDisabled</code>.</p>
<p>The fact that this advice runs contrary to previous advice that comments should not describe who uses them is a hint that <code class="verbatim">dowidth</code> and <code class="verbatim">sizeCalculationDisabled</code> are intimately entwined. The comments presence suggests a possible design weakness.</p>
</section>
</section>
<section id="comments-on-functions-should-describe-their-purpose" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3"><span class="header-section-number">3.2.3</span> Comments On Functions Should Describe Their Purpose</h3>
<p>The comment on a function signature should describe what the function intends to do, not how it does it. Similarly they should describe the inputs and outputs of a function, not be overly perscriptive of how those should be used. Rather than describe the type of the return value, the function’s comment should describe the value’s meaning.</p>
<p>If a function is so simple that the name is enough to document it, document it anyways. You'll need a comment to disable linting for that missing comment anyways, so just write a short sentence or two that maybe explains <em>why</em> this extremely simple function exists <strong>and is exported</strong>.</p>
<p>The description should be sufficient to write a unit test for the documented behaviour.</p>
<p>Be on the lookout for conjoining words like or, they are smell that a function may do more than one thing, violating the single responsibility principle. The comment should explain what the thing does, not how it does it.</p>
</section>
<section id="always-document-public-symbols-types" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4"><span class="header-section-number">3.2.4</span> Always Document Public Symbols &amp; Types</h3>
<p>Because <a href="https://pkg.go.dev/golang.org/x/tools/cmd/godoc">godoc</a> is the documentation for your package, you should always add a comment for every public symbol —​ type, variable, constant, function, and method —​ declared in your package.</p>
<p>Here are two rules from the Google Style guide:</p>
<ul>
<li>Any public function that is not both obvious and short must be commented.</li>
<li>Any function in a library must be commented regardless of length or complexity.</li>
</ul>
<div class="sourceCode" id="cb39"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> ioutil</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ReadAll reads from r until an error or EOF and returns the data it read.</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co">// A successful call returns err == nil, not err == EOF. Because ReadAll is</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="co">// defined to read from src until EOF, it does not treat an EOF from Read</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="co">// as an error to be reported.</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ReadAll<span class="op">(</span>r io<span class="op">.</span>Reader<span class="op">)</span> <span class="op">([]</span><span class="dt">byte</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span></code></pre></div>
<p>There is one exception to this rule; you don’t need to document methods that implement an interface. Specifically, don’t do this:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Read implements the io.Reader interface</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>r <span class="op">*</span>FileReader<span class="op">)</span> Read<span class="op">(</span>buf <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span></code></pre></div>
<p>This comment says nothing. It doesn’t tell you what the method does. In fact it’s worse than, it tells you to go look somewhere else for the documentation. In this situation I suggest removing the comment entirely.</p>
<p>Here is an example from the io package</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">// LimitReader returns a Reader that reads from r</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">// but stops with EOF after n bytes.</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The underlying implementation is a *LimitedReader.</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> LimitReader<span class="op">(</span>r Reader<span class="op">,</span> n <span class="dt">int64</span><span class="op">)</span> Reader <span class="op">{</span> <span class="kw">return</span> <span class="op">&amp;</span>LimitedReader<span class="op">{</span>r<span class="op">,</span> n<span class="op">}</span> <span class="op">}</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="co">// A LimitedReader reads from R but limits the amount of</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">// data returned to just N bytes. Each call to Read</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="co">// updates N to reflect the new amount remaining.</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Read returns EOF when N &lt;= 0 or when the underlying R returns EOF.</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> LimitedReader <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a> R Reader <span class="co">// underlying reader</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a> N <span class="dt">int64</span>  <span class="co">// max bytes remaining</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>l <span class="op">*</span>LimitedReader<span class="op">)</span> Read<span class="op">(</span>p <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span>n <span class="dt">int</span><span class="op">,</span> err <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> l<span class="op">.</span>N <span class="op">&lt;=</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="dv">0</span><span class="op">,</span> EOF</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> <span class="dt">int64</span><span class="op">(</span><span class="bu">len</span><span class="op">(</span>p<span class="op">))</span> <span class="op">&gt;</span> l<span class="op">.</span>N <span class="op">{</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>  p <span class="op">=</span> p<span class="op">[</span><span class="dv">0</span><span class="op">:</span>l<span class="op">.</span>N<span class="op">]</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a> n<span class="op">,</span> err <span class="op">=</span> l<span class="op">.</span>R<span class="op">.</span>Read<span class="op">(</span>p<span class="op">)</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a> l<span class="op">.</span>N <span class="op">-=</span> <span class="dt">int64</span><span class="op">(</span>n<span class="op">)</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Note that the <code class="verbatim">LimitedReader</code> declaration is directly preceded by the function that uses it, and the declaration of <code class="verbatim">LimitedReader.Read</code> follows the declaration of <code class="verbatim">LimitedReader</code> itself. Even though <code class="verbatim">LimitedReader.Read</code> has no documentation itself, it should be that it is an implementation of <code class="verbatim">io.Reader</code>.</p>
<div class="TIP">
<p>Before you write the function, write the comment describing the function. If you find it hard to write the comment, then it’s a sign that the code you’re about to write is going to be hard to understand.</p>
</div>
</section>
<section id="dont-comment-bad-code-rewrite-it" class="level3" data-number="3.2.5">
<h3 data-number="3.2.5"><span class="header-section-number">3.2.5</span> Don't Comment Bad Code, Rewrite It</h3>
<p>Comments highlighting the grossness of a particular piece of code are not sufficient. If you encounter one of these comments, you should raise an issue as a reminder to refactor it later. It is okay to live with technical debt, as long as the amount of debt is known.</p>
<p>The tradition in the standard library is to annotate a TODO style comment with the username of the person who noticed it.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// </span><span class="al">TODO</span><span class="co">(dfc) this is O(N^2), find a faster way to do this.</span></span></code></pre></div>
<p>The username is not a promise that that person has committed to fixing the issue, but they may be the best person to ask when the time comes to address it.</p>
<p>Additionally, there are tools that can search a code base to find all such 'TODO' comments and surface them. Some can even automatically generate tickets!</p>
</section>
<section id="rather-than-commenting-a-block-of-code-refactor-it" class="level3" data-number="3.2.6">
<h3 data-number="3.2.6"><span class="header-section-number">3.2.6</span> Rather Than Commenting A Block of Code, Refactor It</h3>
<blockquote>
<p>Good code is its own best documentation. As you’re about to add a comment, ask yourself, 'How can I improve the code so that this comment isn’t needed?' Improve the code <strong>and then document it to make it even clearer</strong>.</p>
<p>— Steve McConnell</p>
</blockquote>
<p>Emphasis ours.</p>
<p>Functions should do one thing only. If you find yourself commenting a piece of code because it is unrelated to the rest of the function, consider extracting it into a function of its own.</p>
<p>In addition to being easier to comprehend, smaller functions are easier to test in isolation. Once you’ve isolated the orthogonal code into its own function, its name may be all the documentation required… but you should probably still write <em>something</em>.</p>
</section>
</section>
</section>
<section id="using-go-features" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Using Go Features</h1>
<p>In this section we're going to start talking about some guidelines that are slightly more prescriptive than the ones in the previous section. These guidelines are ones that shouldn't necessarily hold up a code review, but should be at least marked for further review or clean-up later.</p>
<p>These are the kinds of guidelines that tools such as <code class="verbatim">go vet</code> or <code class="verbatim">golangci-lint</code> should be able to help us catch and fix.</p>
<section id="errors" class="level2" data-number="4.1">
<h2 data-number="4.1"><span class="header-section-number">4.1</span> Errors</h2>
<p>Error handling is important for reliable programs. Error handling is as important, if not more important than the rest of your code. Error handling is as important as checking a loop index for the exit condition, or checking the result of a shift operation, or testing the result of a multiplication is within the expected bounds, that’s how fundamental error handling is to Go.</p>
<p>And, just like shifting or comparisons or multiplication, error handling is a first class responsibility of all Go programmers. So important that Go makes it a first class citizen. Because you have to plan for failure.</p>
<p>When you write to a network, assume the other side never gets the request. When you write to a channel, assume the other side never picks up the write. When you write to a file, expect it not to exist or be un-writable.</p>
<p>The <code class="verbatim">error</code> interface is the key to Go’s composable error handling story.</p>
<section id="errors-are-just-values" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1"><span class="header-section-number">4.1.1</span> Errors Are Just Values</h3>
<p>This statement is almost universal in the Go programmer’s phrase book, but what do Go programmers mean when they say "errors are just values", and what does this technique imply? By way of explanation, consider the counter example of <code class="verbatim">panic</code> and <code class="verbatim">recover</code>, often mistaken for exceptions.</p>
<p><code class="verbatim">panic</code> and <code class="verbatim">recover</code>, two keywords added to the language for a single purpose. <code class="verbatim">recover</code> can only be used for one purpose; to access a value previously passed to <code class="verbatim">panic</code>. If that wasn’t enough <code class="verbatim">recover</code>'s use case is so specific, it can only be used inside a <code class="verbatim">defer</code> block. You cannot use <code class="verbatim">recover</code> for any other purpose, it can only be used in concert with <code class="verbatim">panic</code>.</p>
<p>This pair of features sit by themselves in a corner of the language. How’s that for non orthogonal?</p>
<p>By contrast, error values are not limited to the rarefied semantics of <code class="verbatim">panic</code> and <code class="verbatim">recover</code>.</p>
<p>However, spend enough time in Go and you may notice that there are a few core strategies for handling errors.</p>
<div class="NOTE">
<p>As an aside, you should never inspect the output of the <code class="verbatim">error.Error()</code> method. The <code class="verbatim">Error</code> method on the <code class="verbatim">error</code> interface exists for humans, not code.</p>
<p>The contents of that string belong in a log file, or displayed on screen. You shouldn’t try to change the behaviour of your program by inspecting it.</p>
<p>The only place where it's even close to okay to inspect the output of <code class="verbatim">error.Error</code> is inside a test; however consider it a code smell and act appropriately.</p>
</div>
<section id="sentinel-errors" class="level4" data-number="4.1.1.1">
<h4 data-number="4.1.1.1"><span class="header-section-number">4.1.1.1</span> Sentinel Errors</h4>
<p>The first category of error handling is what are typically called sentinel errors.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">==</span> ErrSomething <span class="op">{</span></span></code></pre></div>
<p>The name descends from the practice in computer programming of using a specific value to signify that no further processing is possible. So to with Go, we use specific values to signify an error.</p>
<p>Examples include values like <code class="verbatim">io.EOF</code> or low level errors like the constants in the <code class="verbatim">syscall</code> package, like <code class="verbatim">syscall.ENOENT</code>.</p>
<p>There are even sentinel errors that signify that an error <em>did not</em> occur, like <code class="verbatim">go/build.NoGoError</code>, and <code class="verbatim">path/filepath.SkipDir</code> from <code class="verbatim">path/filepath.Walk</code>.</p>
<p>Using sentinel values is the least flexible error handling strategy, as the caller must compare the result to predeclared value using the equality operator. This presents a problem when you want to provide more context, as returning a different error would will break the equality check.</p>
<p>With the addition of wrapping errors in Go 1.13, we now have the <code class="verbatim">%w</code> formatting key to use with <code class="verbatim">fmt.Errorf</code>. This means that we can check to see the type of an error by using <code class="verbatim">errors.Is</code>. This is great when we have an error that we want to see if it's wrapped an <code class="verbatim">io.EOF</code> or something. However, wrapping errors can still have downsides, which we'll get into a bit later.</p>
<section id="sentinel-errors-become-part-of-your-public-api" class="level5" data-number="4.1.1.1.1">
<h5 data-number="4.1.1.1.1"><span class="header-section-number">4.1.1.1.1</span> Sentinel errors become part of your public API</h5>
<p>If your public function or method returns an error of a particular value then that value must be public, and of course documented. This adds to the surface area of your API.</p>
<p>If your API defines an interface which returns a specific error, all implementations of that interface will be restricted to returning only that error, even if they could provide a more descriptive error.</p>
<p>We see this with <code class="verbatim">io.Reader</code>. Functions like <code class="verbatim">io.Copy</code> require a reader implementation to return exactly <code class="verbatim">io.EOF</code> to signal to the caller no more data, but that isn’t an error.</p>
</section>
<section id="sentinel-errors-create-a-hard-dependency-between-packages" class="level5" data-number="4.1.1.1.2">
<h5 data-number="4.1.1.1.2"><span class="header-section-number">4.1.1.1.2</span> Sentinel errors create a hard dependency between packages</h5>
<p>By far the worst problem with sentinel error values is they create a source code dependency between two packages. As an example, to check if an error is equal to <code class="verbatim">io.EOF</code>, your code must import the <code class="verbatim">io</code> package.</p>
<p>This specific example does not sound so bad, because it is quite common. However, imagine the coupling that exists when many packages in your project export error values, which other packages in your project must import to check for specific error conditions.</p>
<p>To quote Dave Cheney:</p>
<blockquote>
<p>Having worked in a large project that toyed with this pattern, I can tell you that the spectre of bad design–in the form of an import loop–was never far from our minds.</p>
</blockquote>
</section>
<section id="conclusion-try-to-avoid-sentinel-errors" class="level5" data-number="4.1.1.1.3">
<h5 data-number="4.1.1.1.3"><span class="header-section-number">4.1.1.1.3</span> Conclusion: try to avoid sentinel errors</h5>
<p>So, our advice is to avoid using sentinel error values in the code you write. There are a few cases where they are used in the standard library, but this is not a pattern that you should emulate.</p>
<p>If someone asks you to export an error value from your package, you should politely decline and instead suggest an alternative method, such as the ones we'll discuss next.</p>
</section>
</section>
<section id="custom-error-types" class="level4" data-number="4.1.1.2">
<h4 data-number="4.1.1.2"><span class="header-section-number">4.1.1.2</span> Custom Error Types</h4>
<p>Error types are the second form of Go error handling we'll discuss.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err<span class="op">,</span> ok <span class="op">:=</span> err<span class="op">.(</span>MyError<span class="op">);</span> ok <span class="op">{</span> … <span class="op">}</span></span></code></pre></div>
<p>An error type is a type that you create that implements the error interface. Below you can see the definition of the <code class="verbatim">MyError</code> type. This custom error type tracks the file and line, as well as a message explaining what happened.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> MyError <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  Msg <span class="dt">string</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  File <span class="dt">string</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  Line <span class="dt">int</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>e <span class="op">*</span>MyError<span class="op">)</span> Error<span class="op">()</span> <span class="dt">string</span> <span class="op">{</span> </span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;%s:%d: %s&quot;</span><span class="op">,</span> e<span class="op">.</span>File<span class="op">,</span> e<span class="op">.</span>Line<span class="op">,</span> e<span class="op">.</span>Msg<span class="op">)</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">// later, somewhere in the code</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span> <span class="op">&amp;</span>MyError<span class="op">{</span><span class="st">&quot;Something happened&quot;</span><span class="op">,</span> <span class="st">&quot;server.go&quot;</span><span class="op">,</span> <span class="dv">42</span><span class="op">}</span></span></code></pre></div>
<p>Because <code class="verbatim">MyError</code> error is a type, callers can use type assertion to extract the extra context from the error.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">:=</span> something<span class="op">()</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">switch</span> err <span class="op">:=</span> err<span class="op">.(</span><span class="kw">type</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="kw">case</span> <span class="ot">nil</span><span class="op">:</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// call succeeded, nothing to do</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">case</span> <span class="op">*</span>MyError<span class="op">:</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span>“error occurred on line<span class="op">:</span>”<span class="op">,</span> err<span class="op">.</span>Line<span class="op">)</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a><span class="kw">default</span><span class="op">:</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="co">// unknown error</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A big improvement of error types over error values is their ability to wrap an underlying error to provide more context.</p>
<p>An excellent example of this is the <code class="verbatim">os.PathError</code> type which annotates the underlying error with the operation it was trying to perform, and the file it was trying to use.</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">// PathError records an error and the operation</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="co">// and file path that caused it.</span></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> PathError <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>        Op   <span class="dt">string</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        Path <span class="dt">string</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>        Err  <span class="dt">error</span> <span class="co">// the cause</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>e <span class="op">*</span>PathError<span class="op">)</span> Error<span class="op">()</span> <span class="dt">string</span></span></code></pre></div>
<section id="problems-with-error-types" class="level5" data-number="4.1.1.2.1">
<h5 data-number="4.1.1.2.1"><span class="header-section-number">4.1.1.2.1</span> Problems with error types</h5>
<p>So because the caller can use a type assertion or type switch, error types must be made public.</p>
<p>If your code implements an interface whose contract requires a specific error type, everywhere you want to implement that interface need to depend on the package that defines the error type.</p>
<p>This intimate knowledge of a package’s types creates a strong coupling with the caller, making for a brittle API.</p>
</section>
<section id="conclusion-avoid-error-types-when-possible" class="level5" data-number="4.1.1.2.2">
<h5 data-number="4.1.1.2.2"><span class="header-section-number">4.1.1.2.2</span> Conclusion: avoid error types when possible</h5>
<p>While error types are better than sentinel error values, because they can capture more context about what went wrong, error types share many of the problems of error values.</p>
<p>So again my advice is to avoid error types, or at least, avoid making them part of your public API.</p>
</section>
</section>
<section id="opaque-errors" class="level4" data-number="4.1.1.3">
<h4 data-number="4.1.1.3"><span class="header-section-number">4.1.1.3</span> Opaque Errors</h4>
<p>Now we come to the third category of error handling.</p>
<p>In the words of Dave Cheney:</p>
<blockquote>
<p>In my opinion this is the most flexible error handling strategy as it requires the least coupling between your code and caller.</p>
<p>I call this style opaque error handling, because while you know an error occurred, you don’t have the ability to see inside the error. As the caller, all you know about the result of the operation is that it worked, or it didn’t.</p>
</blockquote>
<p>This is all there is to opaque error handling – just return the error without assuming anything about its contents. If you adopt this position, then error handling can become significantly more useful as a debugging aid.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> “github<span class="op">.</span>com<span class="op">/</span>quux<span class="op">/</span>bar”</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> fn<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>        x<span class="op">,</span> err <span class="op">:=</span> bar<span class="op">.</span>Foo<span class="op">()</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> err</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// use x</span></span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For example, <code class="verbatim">Foo</code>'s contract makes no guarantees about what it will return in the context of an error. The author of <code class="verbatim">Foo</code> is now free to annotate errors that pass through it with additional context without breaking its contract with the caller.</p>
<p>However, there are times when you don't have a choice, you have to check for a sentinel error or a specific error type. But there is a way around this while still trying to keep ourselves on the path of "use opaque errors". That way to do it is the fantastic <code class="verbatim">Is</code> method which has been with us since Go 1.13.</p>
<p>So while it's best to try and avoid checking for specific types of errors, if you do, use <code class="verbatim">errors.Is</code>.</p>
</section>
<section id="constant-errors" class="level4" data-number="4.1.1.4">
<h4 data-number="4.1.1.4"><span class="header-section-number">4.1.1.4</span> Constant Errors</h4>
<p>A fourth type of error? But you said there were only three!</p>
<p>You're not wrong, but we also weren't really lying.</p>
<p>Constant errors are a potential way to have sentinel errors without some of the drawbacks. This isn't a way to side-step everything written above; rather, it's a way to provide sentinel errors that deals with some of their drawbacks.</p>
<p>So, to recap:</p>
<blockquote>
<p>Sentinel errors are bad, they introduce strong source and run time coupling, but are sometimes necessary. io.EOF is one of these sentinel values. Ideally a sentinel value should behave as a constant, that is it should be immutable and fungible.</p>
</blockquote>
<p>That comes from <a href="https://dave.cheney.net/2016/04/07/constant-errors">Dave Cheney's article on 'constant errors'</a>, which is what this section is based on.</p>
<p>So let's talk about two of the issues we've got with sentinel errors by examining <code class="verbatim">io.EOF</code> a bit.</p>
<p>First up: <code class="verbatim">io.EOF</code> is a public variable. Any code that imports the <code class="verbatim">io</code> package could technically change the value of <code class="verbatim">io.EOF</code>. It wouldn't really <em>do</em> all that much; everything that compares that an error is equal to <code class="verbatim">io.EOF</code> should still work just fine. Mostly, this is an issue because it could create potentially very confusing problems to try and debug.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>io<span class="op">.</span>EOF <span class="op">==</span> io<span class="op">.</span>EOF<span class="op">)</span> <span class="co">// true</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>x <span class="op">:=</span> io<span class="op">.</span>EOF</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>io<span class="op">.</span>EOF <span class="op">==</span> x<span class="op">)</span>      <span class="co">// true</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>io<span class="op">.</span>EOF <span class="op">=</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;whoops&quot;</span><span class="op">)</span></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>io<span class="op">.</span>EOF <span class="op">==</span> io<span class="op">.</span>EOF<span class="op">)</span> <span class="co">// true</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>x <span class="op">==</span> io<span class="op">.</span>EOF<span class="op">)</span>      <span class="co">// false</span></span></code></pre></div>
<p>The second problem is that <code class="verbatim">io.EOF</code> behaves more like a singleton instead of a constant. Even if we follow the exact procedure used by the io package to create our own EOF value, they are not comparable.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">:=</span> errors<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;EOF&quot;</span><span class="op">)</span>   <span class="co">// io/io.go line 38</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>io<span class="op">.</span>EOF <span class="op">==</span> err<span class="op">)</span> <span class="co">// false</span></span></code></pre></div>
<p>Combine these properties and you have a set of weird behaviours stemming from the fact that sentinel error values in Go, those traditionally created with <code class="verbatim">errors.New</code> or <code class="verbatim">fmt.Errorf</code>, are not constants.</p>
<section id="quick-error-interface-re-primer" class="level5" data-number="4.1.1.4.1">
<h5 data-number="4.1.1.4.1"><span class="header-section-number">4.1.1.4.1</span> Quick <code class="verbatim">error</code> interface re-primer</h5>
<p>Let’s recap how the error interface works in Go. Any type with an <code class="verbatim">Error() string</code> method fulfils the <code class="verbatim">error</code> interface. This includes primitive types like <code class="verbatim">string</code>, including constant strings.</p>
</section>
<section id="implementing-constant-errors" class="level5" data-number="4.1.1.4.2">
<h5 data-number="4.1.1.4.2"><span class="header-section-number">4.1.1.4.2</span> Implementing constant errors</h5>
<p>Consider this error implementation.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Error <span class="dt">string</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>e Error<span class="op">)</span> Error<span class="op">()</span> <span class="dt">string</span> <span class="op">{</span> <span class="kw">return</span> <span class="dt">string</span><span class="op">(</span>e<span class="op">)</span> <span class="op">}</span></span></code></pre></div>
<p>It looks similar to the <a href="https://github.com/golang/go/blob/master/src/errors/errors.go#L63">errors.errorString</a> implementation that powers <code class="verbatim">errors.New</code>. However unlike <code class="verbatim">errors.errorString</code> this type is a constant expression.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> err <span class="op">=</span> Error<span class="op">(</span><span class="st">&quot;EOF&quot;</span><span class="op">)</span> </span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> err2 <span class="op">=</span> errorString<span class="op">{</span><span class="st">&quot;EOF&quot;</span><span class="op">}</span> <span class="co">// const initializer errorString literal is not a constant</span></span></code></pre></div>
<p>As constants of the <code class="verbatim">Error</code> type are not variables, they are immutable.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> err <span class="op">=</span> Error<span class="op">(</span><span class="st">&quot;EOF&quot;</span><span class="op">)</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> Error<span class="op">(</span><span class="st">&quot;not EOF&quot;</span><span class="op">)</span> <span class="co">// error, cannot assign to err</span></span></code></pre></div>
<p>Additionally, two constant strings are always equal if their contents are equal, which means two <code class="verbatim">Error</code> values with the same contents are equal.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> err <span class="op">=</span> Error<span class="op">(</span><span class="st">&quot;EOF&quot;</span><span class="op">)</span> </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>err <span class="op">==</span> Error<span class="op">(</span><span class="st">&quot;EOF&quot;</span><span class="op">))</span> <span class="co">// true</span></span></code></pre></div>
<p>Said another way, equal <code class="verbatim">Error</code> values are the same, in the way that the constant <code class="verbatim">1</code> is the same as every other constant <code class="verbatim">1</code>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> eof <span class="op">=</span> Error<span class="op">(</span><span class="st">&quot;eof&quot;</span><span class="op">)</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Reader <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>r <span class="op">*</span>Reader<span class="op">)</span> Read<span class="op">([]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="dv">0</span><span class="op">,</span> eof</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> r Reader</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        _<span class="op">,</span> err <span class="op">:=</span> r<span class="op">.</span>Read<span class="op">([]</span><span class="dt">byte</span><span class="op">{})</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>        fmt<span class="op">.</span>Println<span class="op">(</span>err <span class="op">==</span> eof<span class="op">)</span> <span class="co">// true</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Could we change the definition of <code class="verbatim">io.EOF</code> to be a constant? It turns out that this compiles just fine and passes all the tests, but it’s probably a stretch for the Go 1 contract.</p>
<p>So, to sum up: if you absolutely do need to export a sentinel error from a package, consider making it a constant error. It should make your code easier to understand, and hopefully make testing easier too!</p>
</section>
</section>
</section>
<section id="errors-should-be-opaque" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2"><span class="header-section-number">4.1.2</span> Errors Should Be Opaque</h3>
<p>We've already covered this above when we went over the error types, but it's worth restating:</p>
<blockquote>
<p>With a sufficient number of users of an API, it does not matter what you promise in the contract, all observable behaviours of your system will be depended on by somebody.</p>
<p> — <a href="https://www.hyrumslaw.com/">Hyram’s Law</a></p>
</blockquote>
<p>Programmers will rely on whatever behaviour, guaranteed or not, they observe from your API. Simply put, the more observable state your API returns, the larger the yoke of backwards compatibility you are implicitly committing to.</p>
<p>To the caller, the type and contents of an error value, if not <code class="verbatim">nil</code>, should be considered opaque. To do otherwise introduces brittle coupling between the function and its caller.</p>
<p>The exception to this rule are are sentinel values from the standard library like io.EOF. However, these are the exception to the rule; not a pattern to be emulated.</p>
</section>
<section id="assert-errors-for-behaviour-not-type" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3"><span class="header-section-number">4.1.3</span> Assert Errors For Behaviour, Not Type</h3>
<p>So what do you do when you <strong>do</strong> need to check the type of an error?</p>
<p>The common contract for functions which return a value of the interface type <code class="verbatim">error</code>, is the caller should not presume anything about the state of the other values returned from that call without first checking the error. In the <strong>majority</strong> of cases, error values returned from functions should be opaque to the caller. That is to say, a test that error is <code class="verbatim">nil</code> indicates if the call succeeded or failed, and that’s all there is to it.</p>
<p>The methodology we recommend you follow is this: if a function can return an error, you cannot make any assumptions about the state of any other values returned until you check the error. If it was found that the error was set (ie, not <code class="verbatim">nil</code>), then the state of those other values is unknown.</p>
<p>HOWEVER.</p>
<p>There are a small number of cases that require that the caller investigate the nature of the error to decide if it is reasonable to retry the operation. A common request for package authors is to return errors of a known public type, so the caller can type assert and inspect them.</p>
<p>Quoting Dave Cheney again:</p>
<blockquote>
<p>I believe this practice leads to a number of undesirable outcomes:</p>
<ol>
<li>Public error types increase the surface area of the package’s API.</li>
<li>New implementations must only return types specified in the interface’s declaration, even if they are a poor fit. This also introduces coupling. My implementation must import the package that declares the specific error type required.</li>
<li>The error type cannot be changed or deprecated after introduction without breaking compatibility, making for a brittle API.</li>
</ol>
<p>You should feel no more comfortable asserting an error is a particular type than they would be asserting the string returned from <code class="verbatim">Error()</code> matches a particular pattern.</p>
</blockquote>
<p>Instead he presents a suggestion that permits package authors and consumers to communicate about their intention, without having to overly couple their implementation to the caller. This suggestion fits the <code class="verbatim">has a</code> <em>behaviour</em> nature of Go’s implicit interfaces, rather than the <code class="verbatim">is a</code> <em>subtype of</em> nature of inheritance based languages. Consider this example:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> isTimeout<span class="op">(</span>err <span class="dt">error</span><span class="op">)</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">type</span> timeout <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                Timeout<span class="op">()</span> <span class="dt">bool</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>        te<span class="op">,</span> ok <span class="op">:=</span> err<span class="op">.(</span>timeout<span class="op">)</span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> ok <span class="op">&amp;&amp;</span> te<span class="op">.</span>Timeout<span class="op">()</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The caller can use <code class="verbatim">isTimeout</code> to determine if the error is related to a timeout, and if so confirm if the error was timeout related, all without knowing anything about the type, or the original source of the <code class="verbatim">error</code> value.</p>
<p>Gift wrapping errors, usually by libraries that annotate the error path, is enabled by this method; providing that the wrapped error types also implement the interfaces of the error they wrap. This may seem like a generally intractable problem, but in practice there are relatively few interface methods that are in common use, so <code class="verbatim">Timeout() bool</code> and <code class="verbatim">Temporary() bool</code> cover a large set of use cases.</p>
<p>For package authors, if your package generates errors of a temporary nature, ensure you return error types that implement the respective interface methods. If you wrap error values on the way out, ensure that your wrappers respect the interface(s) that the underlying error value implemented.</p>
<p>For package users, <em>if</em> you need to inspect an error —​ and hopefully this should be infrequent — ​declare and assert an interface to assert the behaviour you expect, not the error’s type. Don’t ask package authors for public error types; instead ask that they make their types conform to common interfaces as appropriate.</p>
<p>A more thorough example of how this can be achieved ( or straight up side-stepped ) can be found in the appendixes: "Too Many Behaviours".</p>
</section>
<section id="panicing-dont" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4"><span class="header-section-number">4.1.4</span> Panicing: Don't</h3>
<p>Go’s <code class="verbatim">error</code> handling strategy is via the error interface and returning <code class="verbatim">error</code> values. Go does have <code class="verbatim">panic</code>, which is a by-product of the counterpart in the runtime’s internal <code class="verbatim">throw</code> function. There are few cases of using <code class="verbatim">recover</code> that I know of, and all of those are used to simulate non local transfer of control <em>not</em> exception handling. Using <code class="verbatim">recover</code> has all the problems of sensing errors by type, with the added complication that the set of types returned is unbounded.</p>
<p>While it is true that any Go function can call <code class="verbatim">panic</code>, any Go procedure can fail due to out of memory, the program can be killed by a process manager, or the serve can simply fail. Always write your programs to assume failure, not success. Avoid <code class="verbatim">panic</code> and eschew <code class="verbatim">recover</code>, they’re not the tool you are looking for.</p>
<p>For example, take an HTTP service with some middleware that can catch any panics thrown during the execution of a handler. This kind of middleware is important, and should be part of any service (regardless of the protocol) that accepts requests from end-users. However, the point of panic-catching middleware is not so that you've got an easy shortcut for returning an error status. Rather, <em>it's</em> <em>so that your service doesn't crash and die</em>.</p>
<p>So how should you handle errors inside a handler? Use whatever methods within your HTTP framework to set the header status code and return an appropriate value. That could be a JSON object with an error message, it could be nothing.</p>
<p>Panicing as a way of returning an error to the user is like… something ridiculous, I can't think of a good analogy right now.</p>
<section id="avoid-selfish-panics" class="level4" data-number="4.1.4.1">
<h4 data-number="4.1.4.1"><span class="header-section-number">4.1.4.1</span> Avoid Selfish Panics</h4>
<p>If a function or method returns an error value, there is no call for a <code class="verbatim">panic</code>. <code class="verbatim">panic</code> must be truly the last resort; exiting on impossible conditions, or in scenarios where the applications truly cannot recover. Panicing in a library must be the absolute last resort. Not only does it have direct impact on the reliability of the program your code is embedded into, but engenders a belief that your library is hard to work with, or itself unreliable.</p>
<p>Panic will, during unwinding the stack, execute any deferred statements. However just as a panic in one goroutine cannot be recovered in another, a panic in one goroutine will not allow defer statements in other goroutines to exit. For a goroutine spawned by a library to panic the entire program is selfish and must be avoided.</p>
<p>Additionally, even if you do <code class="verbatim">recover</code> you can still leak memory from goroutines. Goroutines that wait on a channel can fail to exit if the channel isn't closed or the 'stop' value isn't sent. As there is no way to clean up goroutines except by using a channel or something akin to <code class="verbatim">context.Context#Done()</code> to ask the goroutine to exit, using <code class="verbatim">panic</code> is a good way to leave goroutines hanging accidentally.</p>
</section>
<section id="avoid-log.fatal-log.panic" class="level4" data-number="4.1.4.2">
<h4 data-number="4.1.4.2"><span class="header-section-number">4.1.4.2</span> Avoid <code class="verbatim">log.Fatal</code> &amp; <code class="verbatim">log.Panic</code></h4>
<p>This is possibly the hottest take ever seen from a Go personality.</p>
<p>From Dave Cheney:</p>
<blockquote>
<p>The log package provides two ways to exit your program, log.Fatal and log.Panic. These are effectively the same as panic, and the same rules for panic should apply. They were a mistake and should not have been added. The convenience of being able to log and crash the program in one line, not two, created a misleading precedent.</p>
</blockquote>
<p>He's not wrong; if we shouldn't be panicing we shouldn't be using either of these functions.</p>
</section>
<section id="panic-middleware-is-not-there-to-handle-you-forgot-a-parameter" class="level4" data-number="4.1.4.3">
<h4 data-number="4.1.4.3"><span class="header-section-number">4.1.4.3</span> Panic Middleware Is Not There To Handle "You Forgot A Parameter"</h4>
<p>Panic middleware exists for one reason: to keep your server up and running.</p>
<p>The only reason to have panic middleware is to ensure that a runtime error such as a nil de-reference or some other kind of runtime error doesn't cause your application to crash.</p>
<p>Therefore: don't use the panic middleware to avoid writing error handling code.</p>
</section>
</section>
<section id="eliminate-error-handling-by-eliminating-errors" class="level3" data-number="4.1.5">
<h3 data-number="4.1.5"><span class="header-section-number">4.1.5</span> Eliminate Error Handling By Eliminating Errors</h3>
<p>Some of the things in this section may go away depending on what happens with Go 2.</p>
<p>But do you know what is better than an improved syntax for handling errors? Not needing to handle errors at all.</p>
<p>We're not saying "remove your error handling".</p>
<p>What we are suggesting is this: change your code so you do not have errors to handle.</p>
<p>This section draws inspiration from John Ousterhout’s book, <a href="https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201">A Philosophy of Software Design</a>. One of the chapters in that book is called "Define Errors Out of Existence". We’re going to try to apply this advice to Go.</p>
<section id="example-1-counting-lines" class="level4" data-number="4.1.5.1">
<h4 data-number="4.1.5.1"><span class="header-section-number">4.1.5.1</span> Example 1: Counting Lines</h4>
<p>Let’s write a function to count the number of lines in a file.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> CountLines<span class="op">(</span>r io<span class="op">.</span>Reader<span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> <span class="op">(</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    br    <span class="op">=</span> bufio<span class="op">.</span>NewReader<span class="op">(</span>r<span class="op">)</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    lines <span class="dt">int</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    err   <span class="dt">error</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">)</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    _<span class="op">,</span> err <span class="op">=</span> br<span class="op">.</span>ReadString<span class="op">(</span><span class="ch">&#39;\n&#39;</span><span class="op">)</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    lines<span class="op">++</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">break</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> io<span class="op">.</span>EOF <span class="op">{</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="dv">0</span><span class="op">,</span> err</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> lines<span class="op">,</span> <span class="ot">nil</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Because we’re following our advice from previous sections, <code class="verbatim">CountLines</code> takes an <code class="verbatim">io.Reader</code>, not an <code class="verbatim">*os.File</code>; its the job of the caller to provide the <code class="verbatim">io.Reader</code> who’s contents we want to count.</p>
<p>We construct a <code class="verbatim">bufio.Reader</code>, and then sit in a loop calling the <code class="verbatim">ReadString</code> method, incrementing a counter until we reach the end of the file, then we return the number of lines read.</p>
<p>At least that’s the code we want to write, but instead this function is made more complicated by error handling. For example, there is this strange construction,</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>_<span class="op">,</span> err <span class="op">=</span> br<span class="op">.</span>ReadString<span class="op">(</span><span class="ch">&#39;\n&#39;</span><span class="op">)</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>lines<span class="op">++</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">break</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We increment the count of lines before checking the error —​ that looks odd.</p>
<p>The reason we have to write it this way is <code class="verbatim">ReadString</code> will return an error if it encounters and end-of-file before hitting a newline character. This can happen if there is no final newline in the file.</p>
<p>To try to fix this, we rearrange the logic to increment the line count, then see if we need to exit the loop.</p>
<p>But we’re not done checking errors yet. <code class="verbatim">ReadString</code> will return io.EOF when it hits the end of the file. This is expected, <code class="verbatim">ReadString</code> needs some way of saying stop, there is nothing more to read. So before we return the error to the caller of <code class="verbatim">CountLine</code>, we need to check if the error was not <code class="verbatim">io.EOF</code>, and in that case propagate it up, otherwise we return <code class="verbatim">nil</code> to say that everything worked fine.</p>
<p>This is a good example of Russ Cox’s observation that error handling can obscure the operation of the function. Let’s look at an improved version.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> CountLines<span class="op">(</span>r io<span class="op">.</span>Reader<span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a> sc <span class="op">:=</span> bufio<span class="op">.</span>NewScanner<span class="op">(</span>r<span class="op">)</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a> lines <span class="op">:=</span> <span class="dv">0</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> sc<span class="op">.</span>Scan<span class="op">()</span> <span class="op">{</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  lines<span class="op">++</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> lines<span class="op">,</span> sc<span class="op">.</span>Err<span class="op">()</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This improved version switches from using <code class="verbatim">bufio.Reader</code> to <code class="verbatim">bufio.Scanner</code>.</p>
<p>Under the hood <code class="verbatim">bufio.Scanner</code> uses <code class="verbatim">bufio.Reader</code>, but it adds a nice layer of abstraction which helps remove the error handling with obscured the operation of <code class="verbatim">CountLines</code>. As a note: <code class="verbatim">bufio.Scanner</code> can scan for any pattern, but by default it looks for newlines.</p>
<p>The method, <code class="verbatim">sc.Scan()</code> returns <code class="verbatim">true</code> if the scanner <em>has</em> matched a line of text and has not encountered an error. So, the body of our <code class="verbatim">for</code> loop will be called only when there is a line of text in the scanner’s buffer. This means our revised <code class="verbatim">CountLines</code> correctly handles the case where there is no trailing newline, and also handles the case where the file was empty.</p>
<p>Secondly, as <code class="verbatim">sc.Scan</code> returns false once an error is encountered, our for loop will exit when the end-of-file is reached or an error is encountered. The <code class="verbatim">bufio.Scanner</code> type memoises the first error it encountered and we can recover that error once we’ve exited the loop using the <code class="verbatim">sc.Err()</code> method.</p>
<p>Lastly, <code class="verbatim">sc.Err()</code> takes care of handling <code class="verbatim">io.EOF</code> and will convert it to a nil if the end of file was reached without encountering another error.</p>
</section>
<section id="example-2-writeresponse" class="level4" data-number="4.1.5.2">
<h4 data-number="4.1.5.2"><span class="header-section-number">4.1.5.2</span> Example 2: WriteResponse</h4>
<p>This example was inspired by the <a href="https://go.dev/blog/errors-are-values">Errors are values</a> blog post.</p>
<p>Earlier in this (absolutely massive) document we went over examples dealing with opening, writing, and closing files. The error handling is present, but not overwhelming as the operations can be encapsulated in helpers like <code class="verbatim">ioutil.ReadFile</code> and <code class="verbatim">ioutil.WriteFile</code>. However when dealing with low level network protocols it becomes necessary to build the response directly using I/O primitives the error handling can become repetitive. Consider this fragment of a HTTP server which is constructing the HTTP response.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Header <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a> Key<span class="op">,</span> Value <span class="dt">string</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Status <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a> Code   <span class="dt">int</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a> Reason <span class="dt">string</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteResponse<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> st Status<span class="op">,</span> headers <span class="op">[]</span>Header<span class="op">,</span> body io<span class="op">.</span>Reader<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a> _<span class="op">,</span> err <span class="op">:=</span> fmt<span class="op">.</span>Fprintf<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;HTTP/1.1 %d %s</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">,</span> st<span class="op">.</span>Code<span class="op">,</span> st<span class="op">.</span>Reason<span class="op">)</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> h <span class="op">:=</span> <span class="kw">range</span> headers <span class="op">{</span></span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a>  _<span class="op">,</span> err <span class="op">:=</span> fmt<span class="op">.</span>Fprintf<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;%s: %s</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">,</span> h<span class="op">.</span>Key<span class="op">,</span> h<span class="op">.</span>Value<span class="op">)</span></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>   <span class="kw">return</span> err</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> _<span class="op">,</span> err <span class="op">:=</span> fmt<span class="op">.</span>Fprint<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a> _<span class="op">,</span> err <span class="op">=</span> io<span class="op">.</span>Copy<span class="op">(</span>w<span class="op">,</span> body<span class="op">)</span></span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> err</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>First we construct the status line using <code class="verbatim">fmt.Fprintf</code>, and check the error. Then for each header we write the header key and value, checking the error each time. Lastly we terminate the header section with an additional <code class="verbatim">\r\n</code>, check the error, and copy the response body to the client. Finally, although we don’t need to check the error from <code class="verbatim">io.Copy</code>, we need to translate it from the two return value form that <code class="verbatim">io.Copy</code> returns into the single return value that <code class="verbatim">WriteResponse</code> returns.</p>
<p>That’s a lot of repetitive work. But we can make it easier on ourselves by introducing a small wrapper type, <code class="verbatim">errWriter</code>.</p>
<p><code class="verbatim">errWriter</code> fulfils the <code class="verbatim">io.Writer</code> contract so it can be used to wrap an existing <code class="verbatim">io.Writer</code>. <code class="verbatim">errWriter</code> passes writes through to its underlying writer until an error is detected. From that point on, it discards any writes and returns the previous error.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> errWriter <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a> io<span class="op">.</span>Writer</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a> err <span class="dt">error</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>e <span class="op">*</span>errWriter<span class="op">)</span> Write<span class="op">(</span>buf <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> e<span class="op">.</span>err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="dv">0</span><span class="op">,</span> e<span class="op">.</span>err</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> n <span class="dt">int</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a> n<span class="op">,</span> e<span class="op">.</span>err <span class="op">=</span> e<span class="op">.</span>Writer<span class="op">.</span>Write<span class="op">(</span>buf<span class="op">)</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> n<span class="op">,</span> <span class="ot">nil</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteResponse<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> st Status<span class="op">,</span> headers <span class="op">[]</span>Header<span class="op">,</span> body io<span class="op">.</span>Reader<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a> ew <span class="op">:=</span> <span class="op">&amp;</span>errWriter<span class="op">{</span>Writer<span class="op">:</span> w<span class="op">}</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Fprintf<span class="op">(</span>ew<span class="op">,</span> <span class="st">&quot;HTTP/1.1 %d %s</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">,</span> st<span class="op">.</span>Code<span class="op">,</span> st<span class="op">.</span>Reason<span class="op">)</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> h <span class="op">:=</span> <span class="kw">range</span> headers <span class="op">{</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintf<span class="op">(</span>ew<span class="op">,</span> <span class="st">&quot;%s: %s</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">,</span> h<span class="op">.</span>Key<span class="op">,</span> h<span class="op">.</span>Value<span class="op">)</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Fprint<span class="op">(</span>ew<span class="op">,</span> <span class="st">&quot;</span><span class="ch">\r\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a> io<span class="op">.</span>Copy<span class="op">(</span>ew<span class="op">,</span> body<span class="op">)</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> ew<span class="op">.</span>err</span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Applying <code class="verbatim">errWriter</code> to <code class="verbatim">WriteResponse</code> dramatically improves the clarity of the code. Each of the operations no longer needs to bracket itself with an error check. Reporting the error is moved to the end of the function by inspecting the <code class="verbatim">ew.err</code> field, avoiding the annoying translation from <code class="verbatim">io.Copy</code>'s return values.</p>
</section>
</section>
<section id="only-handle-an-error-once" class="level3" data-number="4.1.6" id="0372bf73-a8e4-4eb4-823f-0dcf1564163b">
<h3 data-number="4.1.6" id="0372bf73-a8e4-4eb4-823f-0dcf1564163b"><span class="header-section-number">4.1.6</span> Only Handle An Error Once</h3>
<p>Lastly, we want to mention that you should only handle errors once. Handling an error means inspecting the error value, and making a <em>single</em> decision.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// WriteAll writes the contents of buf to the supplied writer.</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteAll<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> buf <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        w<span class="op">.</span>Write<span class="op">(</span>buf<span class="op">)</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you make less than one decision, you’re ignoring the error. As we see here, the error from <code class="verbatim">w.WriteAll</code> is being discarded.</p>
<p>But making <em>more than one</em> decision in response to a single error is also problematic. The following is code you will probably see frequently:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteAll<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> buf <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a> _<span class="op">,</span> err <span class="op">:=</span> w<span class="op">.</span>Write<span class="op">(</span>buf<span class="op">)</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;unable to write:&quot;</span><span class="op">,</span> err<span class="op">)</span> <span class="co">// annotated error goes to log file</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err                           <span class="co">// unannotated error returned to caller</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this example if an error occurs during <code class="verbatim">w.Write</code>, a line will be written to a log file, noting the file and line that the error occurred, and the error is also returned to the caller, who possibly will log it, and return it, all the way back up to the top of the program.</p>
<p>The caller is probably doing the same</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteConfig<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> conf <span class="op">*</span>Config<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a> buf<span class="op">,</span> err <span class="op">:=</span> json<span class="op">.</span>Marshal<span class="op">(</span>conf<span class="op">)</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;could not marshal config: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">:=</span> WriteAll<span class="op">(</span>w<span class="op">,</span> buf<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;could not write config: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So you get a stack of duplicate lines in your log file,</p>
<pre><code>unable to write: io.EOF
could not write config: io.EOF
</code></pre>
<p>…but at the top of the program you get the original error without any context.</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">:=</span> WriteConfig<span class="op">(</span>f<span class="op">,</span> <span class="op">&amp;</span>conf<span class="op">)</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>fmt<span class="op">.</span>Println<span class="op">(</span>err<span class="op">)</span> <span class="co">// io.EOF</span></span></code></pre></div>
<p>We want to dig into this a little further because we don’t see the problems with logging and returning as just a matter of personal preference.</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> WriteConfig<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">,</span> conf <span class="op">*</span>Config<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a> buf<span class="op">,</span> err <span class="op">:=</span> json<span class="op">.</span>Marshal<span class="op">(</span>conf<span class="op">)</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;could not marshal config: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// oops, forgot to return</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">:=</span> WriteAll<span class="op">(</span>w<span class="op">,</span> buf<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;could not write config: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The problem seen often is programmers forgetting to return from an error. As we talked about earlier, Go style is to use guard clauses, checking preconditions as the function progresses and returning early.</p>
<p>In this example the author checked the error, logged it, but forgot to return. This has caused a subtle bug.</p>
<p>The contract for error handling in Go says that you cannot make any assumptions about the contents of other return values in the presence of an error. As the JSON marshalling failed, the contents of buf are unknown, maybe it contains nothing, but worse it could contain a half written JSON fragment.</p>
<p>Because the programmer forgot to return after checking and logging the error, the corrupt buffer will be passed to <code class="verbatim">WriteAll</code>, which will probably succeed and so the config file will be written incorrectly. However the function will return just fine, and the only indication that a problem happened will be a single log line complaining about marshalling JSON, not a failure to write the config.</p>
</section>
<section id="annotate-instead-of-handling-when-possible" class="level3" data-number="4.1.7">
<h3 data-number="4.1.7"><span class="header-section-number">4.1.7</span> Annotate Instead Of Handling When Possible</h3>
<p>This brings us to a Go proverb that should talk about:</p>
<blockquote>
<p>Don’t just check errors, handle them gracefully.</p>
</blockquote>
<p>Can you suggest some problems with the following piece of code?</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> AuthenticateRequest<span class="op">(</span>r <span class="op">*</span>Request<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>        err <span class="op">:=</span> authenticate<span class="op">(</span>r<span class="op">.</span>User<span class="op">)</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> err</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>An obvious suggestion is that the five lines of the function could be replaced with</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span> authenticate<span class="op">(</span>r<span class="op">.</span>User<span class="op">)</span></span></code></pre></div>
<p>But this is the simple stuff that everyone should be catching in code review. More fundamentally the problem with this code is you cannot tell where the original error came from.</p>
<p>If <code class="verbatim">authenticate</code> returns an error, then <code class="verbatim">AuthenticateRequest</code> will return the error to its caller, who will probably do the same, and so on. At the top of the program the main body of the program will print the error to the screen or a log file, and all that will be printed is: <code class="verbatim">No such file or directory</code>.</p>
<p>There is no information of file and line where the error was generated. There is no stack trace of the call stack leading up to the error. The author of this code will be forced to a long session of bisecting their code to discover which code path trigged the file not found error.</p>
<p>Donovan and Kernighan’s <em>The Go Programming Language</em> recommends that you add context to the error path using <code class="verbatim">fmt.Errorf</code>:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> AuthenticateRequest<span class="op">(</span>r <span class="op">*</span>Request<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>        err <span class="op">:=</span> authenticate<span class="op">(</span>r<span class="op">.</span>User<span class="op">)</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>                <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;authenticate failed: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code class="verbatim">%w</code> formatting directive for <code class="verbatim">fmt.Errorf</code> is great, and you should be using it. However, there is such a thing as too much of a good thing.</p>
<p>Take this for example:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> readconfig<span class="op">(</span>file <span class="dt">string</span><span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> openfile<span class="op">(</span>file<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;read config failed: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If <code class="verbatim">openfile</code> failed it would likely annotate the error it returned with "open failed". Similarly, <code class="verbatim">readconfig</code>'s wrapped error would be annotated with "read config failed".</p>
<p>Errors with too much information are almost as bad as errors with no information. The more noise you have to sift through to figure out what actually went wrong the longer it'll take you to actually solve the problem.</p>
<p>So how do we determine when we should wrap?</p>
<section id="when-the-error-is-from-outside-the-code-base" class="level4" data-number="4.1.7.1">
<h4 data-number="4.1.7.1"><span class="header-section-number">4.1.7.1</span> When The Error Is From Outside The Code Base</h4>
<p>When calling a 3rd-party API ( HTTP, GRPC, or a library ), we don't have any control of what's in an error.</p>
<p>So, to ensure the error can be traced back to a specific location, annotate errors from 3rd-party APIs.</p>
</section>
<section id="when-the-site-of-the-error-contains-useful-information" class="level4" data-number="4.1.7.2">
<h4 data-number="4.1.7.2"><span class="header-section-number">4.1.7.2</span> When The Site Of The Error Contains Useful Information</h4>
<p>This is for when an error occurs inside a function after you've done some processing. Maybe you've called a method that told you where to save a file, but when you try to open that file for writing you get an error.</p>
<p>Annotate that error with the full path to the file you're trying to open.</p>
<p>Useful information here means things you only have at the moment the error is encountered.</p>
<p>For example, there are error packages that have a <code class="verbatim">New(string)</code> function that returns a string error – that has been annotated with the stack trace of where the error was created. That's useful!</p>
<p>Appending the name of the function where the error was found is not, that leads to:</p>
<pre><code>main: foo: bar: baz: thing: other thing: helper: api: last call: unable to open file
</code></pre>
<p>Wouldn't this be nicer:</p>
<pre><code>user registration: foo-bar api call: unable to open file
</code></pre>
<p>Doesn't that help point you to where the error actually is?</p>
</section>
<section id="thats-it" class="level4" data-number="4.1.7.3">
<h4 data-number="4.1.7.3"><span class="header-section-number">4.1.7.3</span> That's It!</h4>
<p>Errors need to be useful, so we want to add context to them.</p>
<p>Errors need to be readable to be useful, so we don't want to add <em>too much</em> context to them.</p>
<p>So, err (pun intended) on the side of less annotation as much as possible.</p>
</section>
</section>
</section>
<section id="testing" class="level2" data-number="4.2">
<h2 data-number="4.2"><span class="header-section-number">4.2</span> Testing</h2>
<p>Go makes testing easier than other languages in some ways, and harder in others. Testing is built into the language, which is great! However, all you get is the somewhat barebones ( but still <u>awesome</u> ) <code class="verbatim">testing</code> package.</p>
<p>So, because testing is built into the language, we should use it.</p>
<p>For example, this means that your initial response when given either a bug to fix or a feature to implement, should be to write a failing test first. But once you’ve fixed the bug or added the feature you have the test case to prove it works, and you check them in together.</p>
<p>Let's talk about how to write tests in Go, and some ways to make them easier and cleaner to write and maintain.</p>
<p>The first thing to note before we continue though, is this:</p>
<p><strong>Tests lock in behaviour.</strong></p>
<p>Unit tests at the package level should lock in the behaviour of the package’s API. They describe, in code, what the package promises to do.</p>
<p>If there is a unit test for each input permutation, you have defined the contract for what the code will do in code, not documentation. This is a contract you can assert as simply as typing go test. At any stage, you can know with a high degree of confidence, that the behaviour people relied on before your change continues to function after your changes.</p>
<section id="test-test-testing" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1"><span class="header-section-number">4.2.1</span> Test Test Testing</h3>
<p>Let’s say we have a function that splits strings:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Split slices s into all substrings separated by sep and</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="co">// returns a slice of the substrings between those separators.</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Split<span class="op">(</span>s<span class="op">,</span> sep <span class="dt">string</span><span class="op">)</span> <span class="op">[]</span><span class="dt">string</span> <span class="op">{</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> result <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    i <span class="op">:=</span> strings<span class="op">.</span>Index<span class="op">(</span>s<span class="op">,</span> sep<span class="op">)</span></span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> i <span class="op">&gt;</span> <span class="op">-</span><span class="dv">1</span> <span class="op">{</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>        result <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>result<span class="op">,</span> s<span class="op">[:</span>i<span class="op">])</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> s<span class="op">[</span>i<span class="op">+</span><span class="bu">len</span><span class="op">(</span>sep<span class="op">):]</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>        i <span class="op">=</span> strings<span class="op">.</span>Index<span class="op">(</span>s<span class="op">,</span> sep<span class="op">)</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="bu">append</span><span class="op">(</span>result<span class="op">,</span> s<span class="op">)</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In Go, unit tests are just regular Go functions (with a few rules) so we write a unit test for this function starting with a file in the same directory, with the same package name, <code class="verbatim">strings</code>.</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> split</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;reflect&quot;</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;testing&quot;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> TestSplit<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    got <span class="op">:=</span> Split<span class="op">(</span><span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> <span class="st">&quot;/&quot;</span><span class="op">)</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    want <span class="op">:=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">!</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>want<span class="op">,</span> got<span class="op">)</span> <span class="op">{</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>         t<span class="op">.</span>Fatalf<span class="op">(</span><span class="st">&quot;expected: %v, got: %v&quot;</span><span class="op">,</span> want<span class="op">,</span> got<span class="op">)</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Tests are just regular Go functions with a few rules:</p>
<ul>
<li>The name of the test function must start with Test.</li>
<li>The test function must take one argument of type <code class="verbatim">*testing.T</code>. A <code class="verbatim">*testing.T</code> is a type injected by the testing package itself, to provide ways to print, skip, and fail the test.</li>
</ul>
<p>In our test we call <code class="verbatim">Split</code> with some inputs, then compare it to the result we expected.</p>
<section id="going-beyond-100-coverage" class="level4" data-number="4.2.1.1">
<h4 data-number="4.2.1.1"><span class="header-section-number">4.2.1.1</span> Going beyond 100% coverage</h4>
<p>So, we wrote one test case, got 100% coverage, but this isn’t really the end of the story. We have good branch coverage but we probably need to test some of the boundary conditions. For example, what happens if we try to split it on comma?</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> TestSplitWrongSep<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    got <span class="op">:=</span> Split<span class="op">(</span><span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> <span class="st">&quot;,&quot;</span><span class="op">)</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    want <span class="op">:=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a/b/c&quot;</span><span class="op">}</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">!</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>want<span class="op">,</span> got<span class="op">)</span> <span class="op">{</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span>Fatalf<span class="op">(</span><span class="st">&quot;expected: %v, got: %v&quot;</span><span class="op">,</span> want<span class="op">,</span> got<span class="op">)</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Or, what happens if there are no separators in the source string?</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> TestSplitNoSep<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>    got <span class="op">:=</span> Split<span class="op">(</span><span class="st">&quot;abc&quot;</span><span class="op">,</span> <span class="st">&quot;/&quot;</span><span class="op">)</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    want <span class="op">:=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;abc&quot;</span><span class="op">}</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="op">!</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>want<span class="op">,</span> got<span class="op">)</span> <span class="op">{</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span>Fatalf<span class="op">(</span><span class="st">&quot;expected: %v, got: %v&quot;</span><span class="op">,</span> want<span class="op">,</span> got<span class="op">)</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We’re starting build a set of test cases that exercise boundary conditions. This is good.</p>
</section>
<section id="introducing-table-driven-tests" class="level4" data-number="4.2.1.2">
<h4 data-number="4.2.1.2"><span class="header-section-number">4.2.1.2</span> Introducing table driven tests</h4>
<p>However the there is a lot of duplication in our tests. For each test case only the input, the expected output, and name of the test case change. Everything else is boilerplate. What we’d like to to set up all the inputs and expected outputs and feel them to a single test harness. This is a great time to introduce table driven testing.</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> TestSplit<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">type</span> test <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    input <span class="dt">string</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    sep   <span class="dt">string</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    want  <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>  tests <span class="op">:=</span> <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]</span>test<span class="op">{</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;normal&quot;</span><span class="op">:</span> <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}},</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;comma separator&quot;</span><span class="op">:</span> <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;,&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a/b/c&quot;</span><span class="op">}},</span></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;no separator&quot;</span><span class="op">:</span> <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;abc&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;abc&quot;</span><span class="op">}},</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> name<span class="op">,</span> xx <span class="op">:=</span> <span class="kw">range</span> tests <span class="op">{</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">:=</span> xx</span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>Run<span class="op">(</span>name<span class="op">,</span> <span class="kw">func</span><span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">){</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>      got <span class="op">:=</span> Split<span class="op">(</span>tc<span class="op">.</span>input<span class="op">,</span> tc<span class="op">.</span>sep<span class="op">)</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> <span class="op">!</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>tc<span class="op">.</span>want<span class="op">,</span> got<span class="op">)</span> <span class="op">{</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span>Fatalf<span class="op">(</span><span class="st">&quot;expected: %v, got: %v&quot;</span><span class="op">,</span> tc<span class="op">.</span>want<span class="op">,</span> got<span class="op">)</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We declare a structure to hold our test inputs and expected outputs. This is our table. The tests structure is usually a local declaration because we want to reuse this name for other tests in this package.</p>
<p>In fact, we don’t even need to give the type a name, we can use an anonymous struct literal to reduce the boilerplate like this:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> TestSplit<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>    tests <span class="op">:=</span> <span class="kw">map</span><span class="op">[</span><span class="dt">string</span><span class="op">]</span><span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>        input <span class="dt">string</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>        sep   <span class="dt">string</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>        want  <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}{</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}},</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;,&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a/b/c&quot;</span><span class="op">}},</span></span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;abc&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;abc&quot;</span><span class="op">}},</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> </span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">for</span> name<span class="op">,</span> xx <span class="op">:=</span> <span class="kw">range</span> tests <span class="op">{</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>    tc <span class="op">:=</span> xx</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>        t<span class="op">.</span>Run<span class="op">(</span>name<span class="op">,</span> <span class="kw">func</span><span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>            got <span class="op">:=</span> Split<span class="op">(</span>tc<span class="op">.</span>input<span class="op">,</span> tc<span class="op">.</span>sep<span class="op">)</span></span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>            <span class="kw">if</span> <span class="op">!</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>tc<span class="op">.</span>want<span class="op">,</span> got<span class="op">)</span> <span class="op">{</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>                t<span class="op">.</span>Fatalf<span class="op">(</span><span class="st">&quot;expected: %v, got: %v&quot;</span><span class="op">,</span> tc<span class="op">.</span>want<span class="op">,</span> got<span class="op">)</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">})</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now, adding a new test is a straight forward matter; simply add another line the tests structure. For example, what will happen if our input string has a trailing separator?</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}},</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;,&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a/b/c&quot;</span><span class="op">}},</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;abc&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;abc&quot;</span><span class="op">}},</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c/&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}},</span> <span class="co">// trailing sep</span></span></code></pre></div>
<p>Also, because each sub test now has a name we get that name automatically printed out in any test runs.</p>
<pre><code>% go test
--- FAIL: TestSplit (0.00s)
    --- FAIL: TestSplit/trailing_sep (0.00s)
        split_test.go:25: expected: [a b c], got: [a b c ]
</code></pre>
<p>Each subtest is its own anonymous function, therefore we can use <code class="verbatim">t.Fatalf</code>, <code class="verbatim">t.Skipf</code>, and all the other <code class="verbatim">testing.Thelpers</code>, while retaining the compactness of a table driven test.</p>
</section>
<section id="individual-sub-test-cases-can-be-executed-directly" class="level4" data-number="4.2.1.3">
<h4 data-number="4.2.1.3"><span class="header-section-number">4.2.1.3</span> Individual sub test cases can be executed directly</h4>
<p>Because sub tests have a name, you can run a selection of sub tests by name using the go test -run flag.</p>
<pre><code>% go test -run=.*/trailing -v
=== RUN   TestSplit
=== RUN   TestSplit/trailing_sep
--- FAIL: TestSplit (0.00s)
    --- FAIL: TestSplit/trailing_sep (0.00s)
        split_test.go:25: expected: [a b c], got: [a b c ]
</code></pre>
</section>
<section id="table-driven-testing" class="level4" data-number="4.2.1.4">
<h4 data-number="4.2.1.4"><span class="header-section-number">4.2.1.4</span> Table Driven Testing++</h4>
<p>So one improvement I stumbled upon recently is this:</p>
<p>Don't store the table of test cases within the test itself; put them in a JSON file in that package's <code class="verbatim">testdata</code> folder.</p>
<p>What this means is that you replace all the lines like this:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a&quot;</span><span class="op">,</span> <span class="st">&quot;b&quot;</span><span class="op">,</span> <span class="st">&quot;c&quot;</span><span class="op">}},</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;a/b/c&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;,&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;a/b/c&quot;</span><span class="op">}},</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span>input<span class="op">:</span> <span class="st">&quot;abc&quot;</span><span class="op">,</span> sep<span class="op">:</span> <span class="st">&quot;/&quot;</span><span class="op">,</span> want<span class="op">:</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{</span><span class="st">&quot;abc&quot;</span><span class="op">}},</span></span></code></pre></div>
<p>With something like this:</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>helpers<span class="op">.</span>LoadTestData<span class="op">(</span>t<span class="op">,</span> <span class="st">&quot;split-table.json&quot;</span><span class="op">,</span> <span class="op">&amp;</span>tests<span class="op">)</span></span></code></pre></div>
<p>That's a helper function that does something like this:</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">// LoadTestData expects that &#39;file&#39; points to a JSON file. It will open and read</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="co">// that file, and then unmarshal the JSON into &#39;val&#39;.</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> LoadTestData<span class="op">(</span>t <span class="op">*</span>testing<span class="op">.</span>T<span class="op">,</span> file <span class="dt">string</span><span class="op">,</span> val any<span class="op">)</span> <span class="op">{</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>  t<span class="op">.</span>Helper<span class="op">()</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>  file <span class="op">=</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;testdata/%v&quot;</span><span class="op">,</span> file<span class="op">)</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  f<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>OpenFile<span class="op">(</span>file<span class="op">,</span> os<span class="op">.</span>O_RDONLY<span class="op">,</span> fileMode<span class="op">)</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to open testing data file &#39;%v&#39;, reason: %v&quot;</span><span class="op">,</span> file<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>FailNow<span class="op">()</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  bits<span class="op">,</span> err <span class="op">:=</span> io<span class="op">.</span>ReadAll<span class="op">(</span>f<span class="op">)</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to read testing data from file &#39;%v&#39;, reason: %v&quot;</span><span class="op">,</span> file<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>FailNow<span class="op">()</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a>  err <span class="op">=</span> json<span class="op">.</span>Unmarshal<span class="op">(</span>bits<span class="op">,</span> val<span class="op">)</span></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to unmarshal data from file &#39;%v&#39; into value: %v&quot;</span><span class="op">,</span> file<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>    t<span class="op">.</span>FailNow<span class="op">()</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now you can have a test with tens or hundreds of test cases and your actual test files aren't 90% tables.</p>
<p>One thing that this can't do is allow you to define functions as part of your test table; I'm still pondering how to solve that.</p>
</section>
</section>
</section>
<section id="concurrency" class="level2" data-number="4.3">
<h2 data-number="4.3"><span class="header-section-number">4.3</span> Concurrency</h2>
<p>Often Go is chosen for a project because of its concurrency features. The Go team have gone to great lengths to make concurrency in Go cheap (in terms of hardware resources) and performant, however it is possible to use Go’s concurrency features to write code which is neither performant or reliable.</p>
<p>In this section, we'll go over some advice for avoiding some of the pitfalls that come with Go’s concurrency features.</p>
<p>Go features first class support for concurrency with channels, and the <code class="verbatim">select</code> and <code class="verbatim">go</code> statements. If you’ve learnt Go formally from a book or training course, you might have noticed that the concurrency section is always one of the last you’ll cover. This workshop is no different, I have chosen to cover concurrency last, as if it is somehow additional to the regular the skills a Go programmer should master.</p>
<p>There is a dichotomy here; Go’s headline feature is our simple, lightweight concurrency model. As a product, our language almost sells itself on this feature alone. On the other hand, there is a narrative that concurrency isn’t actually that easy to use, otherwise authors wouldn’t make it the last chapter in their book.</p>
<section id="channel-axioms" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1"><span class="header-section-number">4.3.1</span> Channel Axioms</h3>
<p>Go programmers quickly grasp the idea of a channel as a queue of values and are comfortable with the notion that channel operations may block when full or empty. In this section I want to explore several of the less common properties of channels.</p>
<section id="a-send-to-a-nil-channel-blocks-forever" class="level4" data-number="4.3.1.1">
<h4 data-number="4.3.1.1"><span class="header-section-number">4.3.1.1</span> A send to a nil channel blocks forever</h4>
<p>It can be surprising to newcomers that is a send on a nil channel blocks forever.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> c <span class="kw">chan</span> <span class="dt">string</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a> c <span class="op">&lt;-</span> <span class="st">&quot;let&#39;s get started&quot;</span> <span class="co">// deadlock!</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This example program will deadlock on line 5 because the zero value for an uninitialised channel is nil. You cannot send to a channel that has not been initialised.</p>
</section>
<section id="a-receive-from-a-nil-channel-blocks-forever" class="level4" data-number="4.3.1.2">
<h4 data-number="4.3.1.2"><span class="header-section-number">4.3.1.2</span> A receive from a nil channel blocks forever</h4>
<p>Similarly receiving from a nil channel blocks the receiver forever.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> c <span class="kw">chan</span> <span class="dt">string</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Println<span class="op">(&lt;-</span>c<span class="op">)</span> <span class="co">// .....deadlock!</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So why does this happen? Here is one possible explanation:</p>
<ul>
<li>The size of a channel’s buffer is not part of its type declaration, so it must be part of the channel’s value.</li>
<li>If the channel is not initialised then its buffer size will be zero.</li>
<li>If the size of the channel’s buffer is zero, then the channel is unbuffered.</li>
<li>If the channel is unbuffered, then a send will block until another goroutine is ready to receive.</li>
<li>If the channel is nil then the sender and receiver have no reference to each other; they are both blocked waiting on independent channels and will never unblock.</li>
</ul>
</section>
<section id="a-send-to-a-closed-channel-panics" class="level4" data-number="4.3.1.3">
<h4 data-number="4.3.1.3"><span class="header-section-number">4.3.1.3</span> A send to a closed channel panics</h4>
<p>The following program will likely panic as the first goroutine to reach 10 will close the channel before its siblings have time to finish sending their values.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> c <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>                <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">for</span> j <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> j<span class="op">++</span> <span class="op">{</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>                                c <span class="op">&lt;-</span> j</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">close</span><span class="op">(</span>c<span class="op">)</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">}()</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">for</span> i <span class="op">:=</span> <span class="kw">range</span> c <span class="op">{</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>                fmt<span class="op">.</span>Println<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So why isn’t there a version of close that lets you check if a channel is closed? Something like this:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> <span class="op">!</span>isClosed<span class="op">(</span>c<span class="op">)</span> <span class="op">{</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// c isn&#39;t closed, send the value</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>        c <span class="op">&lt;-</span> v</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>But this function would have an inherent race. Someone may close the channel after we checked <code class="verbatim">isClosed(c)</code> but before the code gets to <code class="verbatim">c ← v</code>.</p>
<p>One way to think about how this is possible is to imagine that goroutines work in different universes. They cannot observe each other unless they communicate. Because they cannot observe each other except for these communication points, time moves differently for each goroutine (given we cannot prove the opposite; time moves at the same rate for each goroutine, we must admit that it is <em>possible</em>) hence you cannot make statements like "a small amount of time" when talking about the interactions of different goroutines. There is no <em>happens before</em> relationship with goroutines unless they explicitly communicate.</p>
<p>This is not just a theoretical bun fight, it is easily demonstrable that the operating system thread backing any goroutine may be rescheduled at any time by the operating system. A different thread hosting a different goroutine can move ahead, relative to the sleeping thread, in time easily able to execute the channel close operation before the original thread is revived to attempt to send on the now closed channel.</p>
<p>If you need to ensure that only one goroutine closes a channel you must create a point of coordination <em>before</em> the close operation.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> c <span class="op">=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">100</span><span class="op">)</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> mu sync<span class="op">.</span>Mutex</span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> closed <span class="dt">bool</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>   <span class="kw">for</span> j <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="dv">10</span><span class="op">;</span> j<span class="op">++</span> <span class="op">{</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    c <span class="op">&lt;-</span> j</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>   mu<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>   <span class="kw">if</span> <span class="op">!</span>closed <span class="op">{</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">close</span><span class="op">(</span>c<span class="op">)</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>    closed <span class="op">=</span> <span class="ot">true</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>   <span class="op">}</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>   mu<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}()</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> i <span class="op">:=</span> <span class="kw">range</span> c <span class="op">{</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Println<span class="op">(</span>i<span class="op">)</span></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="a-receive-from-a-closed-channel-returns-the-zero-value-immediately" class="level4" data-number="4.3.1.4">
<h4 data-number="4.3.1.4"><span class="header-section-number">4.3.1.4</span> A receive from a closed channel returns the zero value immediately</h4>
<p>The final case is the inverse of the previous. Once a channel is closed <em>and</em> all values drained from its buffer, the channel will always return zero values immediately.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a> c <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">int</span><span class="op">,</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a> c <span class="op">&lt;-</span> <span class="dv">1</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a> c <span class="op">&lt;-</span> <span class="dv">2</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a> c <span class="op">&lt;-</span> <span class="dv">3</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a> <span class="bu">close</span><span class="op">(</span>c<span class="op">)</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">4</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;%d &quot;</span><span class="op">,</span> <span class="op">&lt;-</span>c<span class="op">)</span> <span class="co">// prints 1 2 3 0</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>When consuming values from a channel until it closes, the better solution is to use a for range style loop.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> v <span class="op">:=</span> <span class="kw">range</span> c <span class="op">{</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// do something with v</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Which is just syntactic sugar over the more verbose</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="kw">for</span> v<span class="op">,</span> ok <span class="op">:=</span> <span class="op">&lt;-</span> c<span class="op">;</span> ok <span class="op">;</span> v<span class="op">,</span> ok <span class="op">=</span> <span class="op">&lt;-</span> c <span class="op">{</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// do something with v</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>These two statements are equivalent in function, and demonstrate what for range is doing under the hood.</p>
</section>
<section id="prefer-channels-with-a-size-of-zero-or-one" class="level4" data-number="4.3.1.5">
<h4 data-number="4.3.1.5"><span class="header-section-number">4.3.1.5</span> Prefer channels with a size of zero or one</h4>
<p>When dealing with an unknown producer or consumer choose a buffer size of zero or one.</p>
<p>A buffer size of zero is ideal for coordination. A buffer size of one is idea to permit the sender to deposit the value without blocking and move on.</p>
<p>A buffer size greater than one is useful in the case where you know that exact number of values that will be deposited in the channel <em>before</em> it is drained. The common case is multiple workers operating in parallel, and a coordinator waiting on that result.</p>
<p>The most reasonable channels sizes are usually zero and one. Most other sizes are <em>guesses</em>. When you guess incorrectly, the program is unreliable.</p>
</section>
<section id="keep-yourself-busy-or-do-the-work-yourself" class="level4" data-number="4.3.1.6">
<h4 data-number="4.3.1.6"><span class="header-section-number">4.3.1.6</span> Keep yourself busy or do the work yourself</h4>
<p>What is the problem with this program?</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;log&quot;</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;net/http&quot;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;Hello, GopherCon SG&quot;</span><span class="op">)</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>   log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The program does what we intended, it serves a simple web server. However it also does something else at the same time, it wastes CPU in an infinite loop. This is because the <code class="verbatim">for{}</code> on the last line of main is going to block the main goroutine because it doesn’t do any IO, wait on a lock, send or receive on a channel, or otherwise communicate with the scheduler.</p>
<p>As the Go runtime is mostly cooperatively scheduled, this program is going to spin fruitlessly on a single CPU, and may eventually end up live-locked.</p>
<p>How could we fix this? Here’s one suggestion.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;log&quot;</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;net/http&quot;</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;runtime&quot;</span></span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;Hello, GopherCon SG&quot;</span><span class="op">)</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>   log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>  runtime<span class="op">.</span>Gosched<span class="op">()</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This might look silly, but it’s a common solution you'll probably see in the wild. It’s symptomatic of not understanding the underlying problem.</p>
<p>Now, if you’re a little more experienced with go, you might instead write something like this.</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;log&quot;</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;net/http&quot;</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;Hello, GopherCon SG&quot;</span><span class="op">)</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>   log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">select</span> <span class="op">{}</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>An empty select statement will block forever. This is a useful property because now we’re not spinning a whole CPU just to call <code class="verbatim">runtime.GoSched()</code>. However, we’re only treating the symptom, not the cause.</p>
<p>I want to present to you another solution, one which has hopefully already occurred to you. Rather than run <code class="verbatim">http.ListenAndServe</code> in a goroutine, leaving us with the problem of what to do with the main goroutine, simply run <code class="verbatim">http.ListenAndServe</code> on the main goroutine itself.</p>
<p>If the <code class="verbatim">main.main</code> function of a Go program returns then the Go program will unconditionally exit no matter what other goroutines started by the program over time are doing.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;log&quot;</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;net/http&quot;</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>w<span class="op">,</span> <span class="st">&quot;Hello, GopherCon SG&quot;</span><span class="op">)</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So this is my first piece of advice: if your goroutine cannot make progress until it gets the result from another, oftentimes it is simpler to just do the work yourself rather than to delegate it.</p>
<p>This often eliminates a lot of state tracking and channel manipulation required to plumb a result back from a goroutine to its initiator.</p>
<p>Many Go programmers overuse goroutines, especially when they are starting out. As with all things in life, moderation is the key to success.</p>
</section>
</section>
<section id="leave-concurrency-to-the-caller" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2"><span class="header-section-number">4.3.2</span> Leave Concurrency To The Caller</h3>
<p>What is the difference between these two APIs?</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ListDirectory returns the contents of dir.</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ListDirectory<span class="op">(</span>dir <span class="dt">string</span><span class="op">)</span> <span class="op">([]</span><span class="dt">string</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co">// ListDirectory returns a channel over which</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="co">// directory entries will be published. When the list</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="co">// of entries is exhausted, the channel will be closed.</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ListDirectory<span class="op">(</span>dir <span class="dt">string</span><span class="op">)</span> <span class="kw">chan</span> <span class="dt">string</span></span></code></pre></div>
<p>The obvious differences are the first example reads a directory into a slice then returns the whole slice, or an error if something went wrong. This happens synchronously, the caller of <code class="verbatim">ListDirectory</code> blocks until all directory entries have been read. Depending on how large the directory, this could take a long time, and could potentially allocate a lot of memory building up the slide of directory entry names.</p>
<p>Lets look at the second example. This is a little more Go like, <code class="verbatim">ListDirectory</code> returns a channel over which directory entries will be passed. When the channel is closed, that is your indication that there are no more directory entries. As the population of the channel happens <em>after</em> <code class="verbatim">ListDirectory</code> returns, <code class="verbatim">ListDirectory</code> is probably starting a goroutine to populate the channel.</p>
<p>It’s not necessary for the second version to actually use a Go routine; it could allocate a channel sufficient to hold all the directory entries without blocking, fill the channel, close it, then return the channel to the caller. But this is unlikely, as this would have the same problems with consuming a large amount of memory to buffer all the results in a channel.</p>
<p>The channel version of <code class="verbatim">ListDirectory</code> has two further problems:</p>
<ul>
<li>By using a closed channel as the signal that there are no more items to process there is no way for <code class="verbatim">ListDirectory</code> to tell the caller that the set of items returned over the channel is incomplete because an error was encountered partway through. There is no way for the caller to tell the difference between an <em>empty directory</em> and an <em>error</em> to read from the directory entirely. Both result in a channel returned from <code class="verbatim">ListDirectory</code> which appears to be closed immediately.</li>
<li>The caller must continue to read from the channel until it is closed because that is the only way the caller can know that the goroutine which was started to fill the channel has stopped. This is a serious limitation on the use of <code class="verbatim">ListDirectory</code>, the caller has to spend time reading from the channel even though it may have received the answer it wanted. It is probably more efficient in terms of memory usage for medium to large directories, but this method is no faster than the original slice based method.</li>
</ul>
<p>The solution to the problems of both implementations is to use a callback, a function that is called in the context of each directory entry as it is executed.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ListDirectory<span class="op">(</span>dir <span class="dt">string</span><span class="op">,</span> fn <span class="kw">func</span><span class="op">(</span><span class="dt">string</span><span class="op">))</span></span></code></pre></div>
<p>Not surprisingly this is how the <code class="verbatim">filepath.WalkDir</code> function works.</p>
<p>If your function starts a goroutine you must provide the caller with a way to explicitly stop that goroutine. It is often easier to leave decision to execute a function asynchronously to the caller of that function.</p>
</section>
<section id="never-start-a-goroutine-without-knowing-when-it-will-stop" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3"><span class="header-section-number">4.3.3</span> Never Start A Goroutine Without Knowing When It Will Stop</h3>
<p>Perhaps fitting for the final topic in this section, we’re going to talk about stopping.</p>
<p>A previous example showed using a goroutine when one wasn’t really necessary. But one of the driving reasons for using Go is the first class concurrency features the language offers. Indeed there are many instances where you want to exploit the parallelism available in your hardware. To do so, you must use goroutines.</p>
<p>This simple application serves http traffic on two different ports, port 8080 for application traffic and port 8001 for access to the <code class="verbatim">/debug/pprof</code> endpoint.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;fmt&quot;</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a> <span class="st">&quot;net/http&quot;</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a> _ <span class="st">&quot;net/http/pprof&quot;</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a> mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a> mux<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>resp http<span class="op">.</span>ResponseWriter<span class="op">,</span> req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>resp<span class="op">,</span> <span class="st">&quot;Hello, QCon!&quot;</span><span class="op">)</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;127.0.0.1:8001&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">)</span> <span class="co">// debug</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">)</span>                       <span class="co">// app traffic</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Although this program isn’t very complicated, it represents the basis of a real application.</p>
<p>There are a few problems with the application as it stands which will reveal themselves as the application grows, so lets address a few of them now.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveApp<span class="op">()</span> <span class="op">{</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a> mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a> mux<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>resp http<span class="op">.</span>ResponseWriter<span class="op">,</span> req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>resp<span class="op">,</span> <span class="st">&quot;Hello, QCon!&quot;</span><span class="op">)</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">)</span></span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveDebug<span class="op">()</span> <span class="op">{</span></span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;127.0.0.1:8001&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">)</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> serveDebug<span class="op">()</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a> serveApp<span class="op">()</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>By breaking the <code class="verbatim">serveApp</code> and <code class="verbatim">serveDebug</code> handlers out into their own functions we’ve decoupled them from <code class="verbatim">main.main</code>. We’ve also followed the advice from above and make sure that <code class="verbatim">serveApp</code> and <code class="verbatim">serveDebug</code> leave their concurrency to the caller.</p>
<p>But there are some operability problems with this program. If <code class="verbatim">serveApp</code> returns then <code class="verbatim">main.main</code> will return causing the program to shutdown and be restarted by whatever process manager you’re using.</p>
<p>Just as functions in Go leave concurrency to the caller, applications should leave the job of monitoring their status and restarting them if they fail to the program that invoked them. Do not make your applications responsible for restarting themselves, this is a procedure best handled from outside the application.</p>
<p>However, <code class="verbatim">serveDebug</code> is run in a separate goroutine and if it returns just that goroutine will exit while the rest of the program continues on. Your operations staff will not be happy to find that they cannot get the statistics out of your application when they want too because the <code class="verbatim">/debug</code> handler stopped working a long time ago.</p>
<p>What we want to ensure is that if any of the goroutines responsible for serving this application stop, we shut down the application.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveApp<span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a> mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a> mux<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>resp http<span class="op">.</span>ResponseWriter<span class="op">,</span> req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>resp<span class="op">,</span> <span class="st">&quot;Hello, QCon!&quot;</span><span class="op">)</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveDebug<span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">:=</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;127.0.0.1:8001&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">);</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>  log<span class="op">.</span>Fatal<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> serveDebug<span class="op">()</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> serveApp<span class="op">()</span></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a> <span class="kw">select</span> <span class="op">{}</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now <code class="verbatim">serverApp</code> and <code class="verbatim">serveDebug</code> check the error returned from <code class="verbatim">ListenAndServe</code> and call <code class="verbatim">log.Fatal</code> if required. Because both handlers are running in goroutines, we park the main goroutine in a <code class="verbatim">select{}</code>.</p>
<p>This approach has a number of problems:</p>
<ul>
<li>If <code class="verbatim">ListenAndServer</code> returns with a <code class="verbatim">nil</code> error, <code class="verbatim">log.Fatal</code> won’t be called and the HTTP service on that port will shut down without stopping the application.</li>
<li><code class="verbatim">log.Fatal</code> calls <code class="verbatim">os.Exit</code> which will unconditionally exit the program; defers won’t be called, other goroutines won’t be notified to shut down, the program will just stop. This makes it difficult to write tests for those functions.</li>
</ul>
<p>Only use <code class="verbatim">log.Fatal</code> from <code class="verbatim">main.main</code>.</p>
<p>What we’d really like is to pass any error that occurs back to the originator of the goroutine so that it can know why the goroutine stopped, can shut down the process cleanly.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveApp<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a> mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a> mux<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>resp http<span class="op">.</span>ResponseWriter<span class="op">,</span> req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>resp<span class="op">,</span> <span class="st">&quot;Hello, QCon!&quot;</span><span class="op">)</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">)</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveDebug<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;127.0.0.1:8001&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">)</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a> done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">error</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>  done <span class="op">&lt;-</span> serveDebug<span class="op">()</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>  done <span class="op">&lt;-</span> serveApp<span class="op">()</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="bu">cap</span><span class="op">(</span>done<span class="op">);</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> <span class="op">&lt;-</span>done<span class="op">;</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>   fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;error: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We can use a channel to collect the return status of the goroutine. The size of the channel is equal to the number of goroutines we want to manage so that sending to the <code class="verbatim">done</code> channel will not block, as this will block the shutdown the of goroutine, causing it to leak.</p>
<p>As there is no way to safely close the <code class="verbatim">done</code> channel we cannot use the <code class="verbatim">for range</code> idiom to loop of the channel until all goroutines have reported in, instead we loop for as many goroutines we started, which is equal to the capacity of the channel.</p>
<p>Now we have a way to wait for each goroutine to exit cleanly and log any error they encounter. All that is needed is a way to forward the shutdown signal from the first goroutine that exits to the others.</p>
<p>It turns out that asking a <code class="verbatim">http.Server</code> to shut down is a little involved, so I’ve spun that logic out into a helper function. The <code class="verbatim">serve</code> helper takes an address and <code class="verbatim">http.Handler</code>, similar to <code class="verbatim">http.ListenAndServe</code>, and also a stop channel which we use to trigger the <code class="verbatim">Shutdown</code> method.</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serve<span class="op">(</span>addr <span class="dt">string</span><span class="op">,</span> handler http<span class="op">.</span>Handler<span class="op">,</span> stop <span class="op">&lt;-</span><span class="kw">chan</span> <span class="kw">struct</span><span class="op">{})</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a> s <span class="op">:=</span> http<span class="op">.</span>Server<span class="op">{</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  Addr<span class="op">:</span>    addr<span class="op">,</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  Handler<span class="op">:</span> handler<span class="op">,</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;-</span>stop <span class="co">// wait for stop signal</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  s<span class="op">.</span>Shutdown<span class="op">(</span>context<span class="op">.</span>Background<span class="op">())</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> s<span class="op">.</span>ListenAndServe<span class="op">()</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveApp<span class="op">(</span>stop <span class="op">&lt;-</span><span class="kw">chan</span> <span class="kw">struct</span><span class="op">{})</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a> mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a> mux<span class="op">.</span>HandleFunc<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> <span class="kw">func</span><span class="op">(</span>resp http<span class="op">.</span>ResponseWriter<span class="op">,</span> req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Fprintln<span class="op">(</span>resp<span class="op">,</span> <span class="st">&quot;Hello, QCon!&quot;</span><span class="op">)</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a> <span class="op">})</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> serve<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">,</span> stop<span class="op">)</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> serveDebug<span class="op">(</span>stop <span class="op">&lt;-</span><span class="kw">chan</span> <span class="kw">struct</span><span class="op">{})</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> serve<span class="op">(</span><span class="st">&quot;127.0.0.1:8001&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">,</span> stop<span class="op">)</span></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a> done <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="dt">error</span><span class="op">,</span> <span class="dv">2</span><span class="op">)</span></span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a> stop <span class="op">:=</span> <span class="bu">make</span><span class="op">(</span><span class="kw">chan</span> <span class="kw">struct</span><span class="op">{})</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>  done <span class="op">&lt;-</span> serveDebug<span class="op">(</span>stop<span class="op">)</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a> <span class="kw">go</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a>  done <span class="op">&lt;-</span> serveApp<span class="op">(</span>stop<span class="op">)</span></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> stopped <span class="dt">bool</span></span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="bu">cap</span><span class="op">(</span>done<span class="op">);</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">:=</span> <span class="op">&lt;-</span>done<span class="op">;</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>   fmt<span class="op">.</span>Println<span class="op">(</span><span class="st">&quot;error: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="op">!</span>stopped <span class="op">{</span></span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>   stopped <span class="op">=</span> <span class="ot">true</span></span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>   <span class="bu">close</span><span class="op">(</span>stop<span class="op">)</span></span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now, each time we receive a value on the <code class="verbatim">done</code> channel, we close the stop channel which causes all the goroutines waiting on that channel to shut down their <code class="verbatim">http.Server</code>. This in turn will cause all the remaining <code class="verbatim">ListenAndServe</code> goroutines to return. Once all the goroutines we started have stopped, <code class="verbatim">main.main</code> returns and the process stops cleanly.</p>
</section>
</section>
<section id="logging" class="level2" data-number="4.4">
<h2 data-number="4.4"><span class="header-section-number">4.4</span> Logging</h2>
<p>Logging is important. It can provide critical context clues when trying to understand why an application isn't working properly.</p>
<p>At the same time, they should be the last place we look when debugging something. Scrolling through logs trying to understand what happened is never fun, and often you don't find what you need anyways.</p>
<p>How do we make logs good?</p>
<p><a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging">https://dave.cheney.net/2015/11/05/lets-talk-about-logging</a></p>
<section id="log-levels" class="level3" data-number="4.4.1">
<h3 data-number="4.4.1"><span class="header-section-number">4.4.1</span> Log Levels</h3>
<p>Let's start talking about log levels – and how we don't need many.</p>
<section id="info" class="level4" data-number="4.4.1.1">
<h4 data-number="4.4.1.1"><span class="header-section-number">4.4.1.1</span> Info</h4>
<p>The most common log level.</p>
<p>How should we be using it?</p>
<p>We should be using the <code class="verbatim">info</code> log level for high level things that help us understand the current state of the system.</p>
<p>Writing a service that accepts requests ( HTTP, GRPC, or otherwise )? Log each request. You don't have to log everything that happens in the request, or all the parameters. At minimum we should be logging timestamp, route, and method. For HTTP that's the path and the HTTP method ( get, post, etc ). For GRPC that's the method &amp; whether it's unary or streaming. At the very least, this log will let you know that your service has started handling requests. That log should also contain one more piece of information: whether it succeeded or failed.</p>
<p>That last piece of information is key. Without it, the logs are just noise; requests are happening but we don't know if they're working or just returning error messages. Logs are a quick and easy smoke test for "is everything okay?".</p>
<p>Are all the requests in the log showing they returned successfully? Everything's good!</p>
<p>Now, if things aren't going good we should be notified via other means. We don't want to end up having to tail all the logs to keep an eye on them and investigate any <code class="verbatim">500 Internal Server Error</code>'s.</p>
<p>Isn't that a bit contradictory though? Not really. Our systems live inside another system: AWS. Our systems may have things like load balancers or proxies sitting in front of them. So in production, logs are the quickest and easiest way to check something like "is this error coming from the service or something between the service and the user". Make a request, does the server spit out a request log line? If the answer is yes, dive into the code and figure out why. If the answer is no, well then you know the problem isn't in your code.</p>
<p>So is that a good answer?</p>
<p>"Use the <code class="verbatim">info</code> log level to act as a high-level observability tool for our systems."</p>
<p>It sounds pretty good! Probably worth discussing more but for now that's probably enough.</p>
</section>
<section id="debug" class="level4" data-number="4.4.1.2">
<h4 data-number="4.4.1.2"><span class="header-section-number">4.4.1.2</span> Debug</h4>
<p>The debug log level can be very handy. However, it should be turned off in all environments until you explicitly enable it somehow.</p>
<p>This is because debug logs are the only logs that <em>should</em> be incredibly noisy. They should have too much information, and there should be a lot of them.</p>
<p>Why?</p>
<p>If you're turning on debug logs, you're trying to get a much better picture of how the system is working, of the state of the system and how that changes.</p>
<p>You probably also don't know exactly <em>what</em> information you need, so they should have a lot of information so you can more easily search and filter your logs for what you need.</p>
<p>So the <code class="verbatim">debug</code> log level is one we should hold on to. Also, if you felt that debug logging was handy while you were working on something, you should probably leave most of them in. They won't show up as soon as you go back to development mode. And if they were useful to you, they might be useful to someone else.</p>
<p>Does that mean every other line should be a debug log? Nope!</p>
<p>Rather, the <code class="verbatim">debug</code> log level should help you understand how the state of the system changes as you touch it and interact with it.</p>
<p>Yes, debuggers are a much more useful tool for this kind of thing. But not everybody knows how to use a debugger, or is comfortable using one all the time. Until we can guarantee that everybody has the same skill level with debuggers then the <code class="verbatim">debug</code> log level should stick around.</p>
</section>
<section id="warning" class="level4" data-number="4.4.1.3">
<h4 data-number="4.4.1.3"><span class="header-section-number">4.4.1.3</span> Warning</h4>
<p>Easiest place to start: nobody needs a warning log level.</p>
<p>What do warnings represent?</p>
<p>That something <em>might</em> go wrong in the future. If you look in the logs and see a bunch of warnings, do you think "oh no! a bunch of stuff we need to fix!"? Or do you think "oh crap, I have to pull those warning logs out".</p>
<p>Or do you think "everything is fine, warnings don't matter"?</p>
<p>So what do we use instead?</p>
<p>Well, if it's an informational message, use the <code class="verbatim">info</code> log level. Otherwise, keep reading.</p>
</section>
<section id="fatal" class="level4" data-number="4.4.1.4">
<h4 data-number="4.4.1.4"><span class="header-section-number">4.4.1.4</span> Fatal</h4>
<p>The <code class="verbatim">fatal</code> log level is effectively logging the message, then calling <code class="verbatim">os.Exit(1)</code>. In principal this means:</p>
<ul>
<li>defer statements in other goroutines don’t run.</li>
<li>buffers aren’t flushed.</li>
<li>temporary files and directories aren’t removed.</li>
</ul>
<p>In effect, <code class="verbatim">log.Fatal</code> is a less verbose than, but semantically equivalent to, <code class="verbatim">panic</code>.</p>
<p>It is commonly accepted that libraries should not use <code class="verbatim">panic</code>, but if calling <code class="verbatim">log.Fatal</code> has the same effect, surely this should also be outlawed.</p>
<p>Suggestions that this cleanup problem can be solved by registering shutdown handlers with the logging system introduces tight coupling between your logging system and every place where cleanup operations happen; its also violates the separation of concerns.</p>
<p>Don’t log at fatal level, prefer instead to return an error to the caller. If the error bubbles all the way up to <code class="verbatim">main.main</code> then that is the right place to handle any cleanup actions before exiting.</p>
</section>
<section id="error" class="level4" data-number="4.4.1.5">
<h4 data-number="4.4.1.5"><span class="header-section-number">4.4.1.5</span> Error</h4>
<p>Error handling and logging are closely related, so on the face of it, logging at error level should be easily justifiable. <a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging">Dave Cheney disagrees</a>.</p>
<p>In Go, if a function or method call returns an error value, realistically you have two options:</p>
<ul>
<li>handle the error.</li>
<li>return the error to your caller. You may choose to gift wrap the error, but that is not important to this discussion.</li>
</ul>
<p>If you choose to handle the error by logging it, by definition it’s not an error any more — you handled it. The act of logging an error handles the error, hence it is no longer appropriate to log it as an error.</p>
<p>Let me try to convince you with this code fragment:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>err <span class="op">:=</span> somethingHard<span class="op">()</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span>Error<span class="op">(</span><span class="st">&quot;oops, something was too hard&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">return</span> err <span class="co">// what is this, Java ?</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>You should never be logging anything at error level because you should either handle the error, or pass it back to the caller.</p>
<p>To be clear, I am not saying you should not log that a condition occurred,</p>
<div class="sourceCode" id="cb106"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">:=</span> planA<span class="op">();</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span>Infof<span class="op">(</span><span class="st">&quot;could&#39;t open the foo file, continuing with plan b: %v&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>        planB<span class="op">()</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>…but in effect <code class="verbatim">log.Info</code> and <code class="verbatim">log.Error</code> have the same purpose.</p>
<p>We are not saying "<strong>DO NOT LOG ERRORS!</strong>".</p>
<p>Instead the question is, what is the smallest possible logging API? And when it comes to errors, does logging something as with an 'error' log level actually help us in any way?</p>
<p>If our application encounters an error, but we don't want to return it: we handle it. That handling can include:</p>
<ul>
<li>log a message (at the <code class="verbatim">info</code> level) and continue</li>
<li>send the error to an error collection service such as Rollbar</li>
<li>solve the problem the error tells us about</li>
</ul>
<p>If you can't handle the error, return it.</p>
<p>Do not do both.</p>
</section>
<section id="logging-an-error-is-handling-it" class="level4" data-number="4.4.1.6">
<h4 data-number="4.4.1.6"><span class="header-section-number">4.4.1.6</span> Logging An Error Is Handling It</h4>
<p>We've covered this twice now; previously back in "<a href="id:0372bf73-a8e4-4eb4-823f-0dcf1564163b">Only Handle An Error Once</a>". This time we've come at it from a different direction. Previously we were talking about why we shouldn't handle an error <strong>and</strong> return it. Then our argument was that by handling an error ( which <em>includes logging it</em> ) AND returning it we either make the error less useful or potentially creating situations where we think we've handled an error but forget to return it.</p>
<p>Now we're coming at it from a different angle. Now we have a case for why logging <em>is</em> handling an error. That case is: the error isn't fatal and we think we can recover from it, so we log that our initial attempt failed and are trying to recover.</p>
<p>Now error logs are useful, because we've made it clear that errors show up in logs to tell us something went wrong but we tried to recover from it. If we continue to handle errors properly then either the error gets solved, or we get a notification from Rollbar that some operation failed. If we're doing everything correctly, that error has a request ID that we can use to filter the logs so that we can see what happened <em>before</em> the error.</p>
<p>How do we know we've handled the error? We passed it into a function. That function happened to be <code class="verbatim">log.Infof</code>, but that still counts. Notice how we don't pass <code class="verbatim">err</code> into <code class="verbatim">planB</code>. If we did, that would be trying to handle the error twice.</p>
<div class="NOTE">
<p><code class="verbatim">planB</code> shouldn't care that it's being called because <code class="verbatim">planA</code> failed. What if we want to be able to call <code class="verbatim">planB</code> first in some situations?</p>
</div>
<p>Think of it this way: a function that wraps an error is <em>the only kind of function</em> that you can pass an error into that doesn't count as handling it. Therefore, passing an error into <em>any other kind of</em> <em>function</em> counts as handling it.</p>
</section>
</section>
<section id="why-log" class="level3" data-number="4.4.2">
<h3 data-number="4.4.2"><span class="header-section-number">4.4.2</span> Why Log?</h3>
<p>So we know some of the things we shouldn't be doing with logs.</p>
<p>For one, they're <em>not</em> a way of annotating an error before you return them. Rather, errors that show up in the logs are ones that have been handled – the log is just there to say "hey, caught this error, trying something else". These are actually good, as they can highlight areas that might need to be re-thought.</p>
<p>If <code class="verbatim">planA</code> fails 90% of the time, don't remove the handling of the error ( in this case, by logging it ); fix the problem.</p>
<p>We can probably also agree on some other things:</p>
<ul>
<li>don't put anything in the logs that doesn't help you understand the state of the system</li>
<li>if logs are noisy, fix the source of the noise rather than removing the logs</li>
<li>logs should contain data that helps filter, such as request ID</li>
</ul>
<p>So where does this leave us? How do we log and follow these rules?</p>
<p>Well, for one, no package-scoped loggers. No more stuff like this:</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> foo</span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> “mylogger”</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> log <span class="op">=</span> mylogger<span class="op">.</span>GetLogger<span class="op">(</span>“github<span class="op">.</span>com<span class="op">/</span>project<span class="op">/</span>foo”<span class="op">)</span></span></code></pre></div>
<p>There are some other problems with this solution. First, our <code class="verbatim">foo</code> package now has a <em>compile-time</em> dependency on the <code class="verbatim">mylogger</code> package. Second is that this tight coupling means that any package that consumes <code class="verbatim">foo</code> is also consuming <code class="verbatim">mylogger</code>. These both lead to a third problem: Go projects composed of packages using multiple logging libraries, <em>or</em> fiefdoms of projects who can only consume packages that use their particular logging library.</p>
<p>How do we solve this?</p>
<p>At the risk of sounding like a broken record: the SOLID principles.</p>
<p>Let's think about what we want to do:</p>
<ul>
<li>when things in <code class="verbatim">foo</code> happen, we want to be able to log them</li>
<li>we don't want <code class="verbatim">foo</code> to be directly coupled to a specific <code class="verbatim">package</code> or logging implementation</li>
<li>we want to tell <code class="verbatim">foo</code> about what to use for logging at <strong>runtime</strong></li>
</ul>
<p>How do we get this?</p>
<p>Well, for one, we need to refactor <code class="verbatim">foo</code> a bit. <code class="verbatim">foo</code> shouldn't be importing a specific logger, and especially should not be creating it's own logger. <code class="verbatim">foo</code> should have a single purpose, and that purpose doesn't involve "knowing specific things about logging".</p>
<p>Rather, all <code class="verbatim">foo</code> needs is something that lets it accomplish a behavior; in this case <code class="verbatim">foo</code> needs something that can do logging.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> foo</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> logger <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>  Printf<span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="op">...</span>any<span class="op">)</span></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Baz <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>  log logger</span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other fields</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> NewBaz<span class="op">(</span>l logger<span class="op">)</span> <span class="op">(*</span>Baz<span class="op">,</span> <span class="dt">error</span><span class="op">){</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// a bunch of other lines</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="op">&amp;</span>Baz<span class="op">{</span>log<span class="op">:</span> l<span class="op">},</span> <span class="ot">nil</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So what does this mean for how we write code?</p>
<p>Well, at the most basic level: if a package wants to do its own logging, it needs to define the logging behavior it wants in an interface and then ask for something that fulfills that interface when creating the types that need to be able to log.</p>
<p>In other words: we have functions on <code class="verbatim">Baz</code> that need to be able to write logs. So we define what we want that logging interface to look like, in this case it's an interface with just <code class="verbatim">Printf</code>. Why just <code class="verbatim">Printf</code>? We don't need methods for <code class="verbatim">Error</code>, <code class="verbatim">Fatal</code>, <code class="verbatim">Panic</code>, or <code class="verbatim">Warning</code>, as we discussed above. We only need a method for logging to the 'info' log level – why not <code class="verbatim">Info</code> or <code class="verbatim">Infof</code>?</p>
<p>Because there are <a href="https://pkg.go.dev/search?q=Printf&amp;m=symbol">way more methods named Printf</a>.</p>
<p>Wait, hold on, that won't work with the code we've got. You can't pass a package as a type; so we can't do this:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;log&quot;</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;github.com/janetechinc/foo</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">(){</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>  b<span class="op">,</span> err <span class="op">:=</span> NewBaz<span class="op">(</span>log<span class="op">)</span></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>So what do we do? Wrap every log package we want to use so that the functions are attached to a type so we can pass it in?</p>
<p>That sounds like too much work.</p>
<p>Let's do this instead:</p>
<div class="sourceCode" id="cb110"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> foo</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> logFn <span class="kw">func</span><span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="op">...</span>any<span class="op">)</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Baz <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>  log logFn</span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// other fields</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> NewBaz<span class="op">(</span>l logFn<span class="op">)</span> <span class="op">(*</span>Baz<span class="op">,</span> <span class="dt">error</span><span class="op">){</span></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// a bunch of other lines</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="op">&amp;</span>Baz<span class="op">{</span>log<span class="op">:</span> l<span class="op">},</span> <span class="ot">nil</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Huzzah! Now we can do this:</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;log&quot;</span></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;github.com/janetechinc/foo</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">(){</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>  b<span class="op">,</span> err <span class="op">:=</span> NewBaz<span class="op">(</span>log<span class="op">.</span>Printf<span class="op">)</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span></code></pre></div>
<p>Of course, this solution doesn't work if you want to use a logging package like <a href="https://pkg.go.dev/go.uber.org/zap">zap</a>, which helpfully has plenty of types that <em>could</em> fit an interface. Unfortunately none of the types defined by <code class="verbatim">zap</code> have a <code class="verbatim">Printf</code>. It does have <code class="verbatim">Infof</code> on the sugared logger though: <code class="verbatim">zap.S().Infof(string, ...any)</code>.</p>
<p>So which do you use? The function type or the interface?</p>
<p>This is something better covered later on, but prefer logging packages like <code class="verbatim">zap</code> over ones that use package-level functions like the standard library <code class="verbatim">log</code>.</p>
<p>Why? How does a package handle logging with only exported functions?</p>
<p>Ponder these questions, and how you have to solve them when you're exporting functions:</p>
<ul>
<li>How do you define your log format?</li>
<li>How do you change the log level?</li>
<li>How do you create sub-loggers?</li>
</ul>
<p>If you said package-level variables, you'd be right. We'll go over why this is a bad idea later on, but for now we'll end with this:</p>
<p>Logging isn't a static thing. You want to pass your logger around so that you can create sub-loggers, add fields for things like request IDs – and not have those things impact how logging works in other packages.</p>
</section>
</section>
</section>
<section id="architecture" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Architecture</h1>
<p>This section we're going to be diving into the most prescriptive set of guidelines around writing Go code. If you choose to ignore these guidelines, expect your code to get stuck in review.</p>
<section id="package-design" class="level2" data-number="5.1">
<h2 data-number="5.1"><span class="header-section-number">5.1</span> Package Design</h2>
<blockquote>
<p>Write shy code - modules that don’t reveal anything unnecessary to other modules and that don’t rely on other modules' implementations.</p>
<p>— <a href="https://twitter.com/codewisdom/status/1045305561317888000?s=12">Dave Thomas</a></p>
</blockquote>
<p>In his book, <em>Test Driven Design and Development</em>, Kent Beck describes the idea of a unit of software. In software, the unit is atomic, indivisible.</p>
<p>In the physical world atoms are composed of quarks, mesons, bosons, and gluons. We cannot observe them directly, only infer them from their <em>behaviour</em>–mass, charge, gravitational attraction. In the software world, if a unit is composed of smaller subatomic particles, as a user—​a caller of that software—​we are unable to directly observe the imlementation details of the unit. Instead we rely on the <em>behaviour</em> of a unit.</p>
<p>The size of a unit of software differs by language. In C the unit is a function, as C offers little else. In Java, the unit of software is commonly <em>mis-believed</em> to be the <em>class</em>. In Go, the unit of software is not the function, or the type, or the method, but instead the <em>package</em>.</p>
<p>Just as the implementation of a function or method is unimportant to the caller, the implementation of the functions, methods and types that comprise your package’s public API—​its behaviour—​is unimportant for the caller. The public API of a package describes <em>what</em> it does not <em>how</em> it does it. Moreover, when designed well, the <em>implementation</em> of your package is obscured from the caller</p>
<p>In this section we’ll talk about designing a package around its behaviour as exposed via its public API.</p>
<section id="high-level-package-design" class="level3" data-number="5.1.1">
<h3 data-number="5.1.1"><span class="header-section-number">5.1.1</span> High-Level Package Design</h3>
<section id="a-good-package-starts-with-its-name" class="level4" data-number="5.1.1.1">
<h4 data-number="5.1.1.1"><span class="header-section-number">5.1.1.1</span> A Good Package Starts With Its Name</h4>
<p>If the goal of a well designed Go package is to provide a set of related behaviours, writing a good package starts with choosing a good name. Think of your package’s name as a one world elevator pitch to describe what your package can do for you elevator companion.</p>
<p>Just as we talked earlier about naming variables, the name of a package is very important. You should start by asking questions like, "what is the purpose of this package" or "what does service does package provide?". Hopefully the answer to that question is "this package lets you speak HTTP", not "this package provides the X type", otherwise its time to go back to the drawing board.</p>
<p>As a tip: name your package for what it <em>provides</em>, not what it <em>contains</em>.</p>
</section>
<section id="good-package-names-should-be-unique" class="level4" data-number="5.1.1.2">
<h4 data-number="5.1.1.2"><span class="header-section-number">5.1.1.2</span> Good Package Names Should Be Unique</h4>
<p>Within your project, each package name should be unique. This should pretty easy to if you’ve followed the previous advice that a package’s name should derive from its purpose. If you find you have two packages which need the same name, it is likely either;</p>
<ul>
<li>The name of the package is too generic – <code class="verbatim">client</code>, <code class="verbatim">worker</code>, <code class="verbatim">shared</code>, etc.</li>
<li>The package overlaps another package of a similar name. In this case either you should review your design, or consider merging the packages, or renaming the conflicting packages to make their purpose more specific. Consdider the <code class="verbatim">io/ioutil</code> and <code class="verbatim">net/http/httputil</code> packages as weak supporting evidence.</li>
</ul>
</section>
<section id="avoid-package-names-like-base-common-or-util" class="level4" data-number="5.1.1.3">
<h4 data-number="5.1.1.3"><span class="header-section-number">5.1.1.3</span> Avoid Package Names Like <code class="verbatim">base</code>, <code class="verbatim">common</code>, Or <code class="verbatim">util</code></h4>
<p>A common cause of poor package names is what are often called <em>utility packages</em>. These are packages where helpers and utility code congeals over time. As these packages contain an assortment of unrelated functions, their utility is hard to describe in terms of what the package provides. This often leads to the package’s name being derived from what the package <em>contains</em>–utilities.</p>
<p>Package names like <code class="verbatim">utils</code> or <code class="verbatim">helpers</code> are commonly found in larger projects which have developed deep package hierarchies and want to share helper functions without encountering import loops. By extracting utility functions to new package the import loop is broken, but because the package stems from a design problem in the project its name doesn’t reflect its purpose, only its function of breaking the import cycle.</p>
<p>My recommendation to improve the name of <code class="verbatim">utils</code> or <code class="verbatim">helpers</code> packages is to analyse where they are called and if possible move the relevant functions into their caller’s package. Even if this involves duplicating some helper code this is better than introducing an import dependency between two packages.</p>
<p>In the case where utility functions are used in many places – prefer multiple packages, each focused on a single aspect, to a single monolithic package.</p>
<p>Naming tip: Use plurals for naming utility packages. For example: the <code class="verbatim">strings</code> package for string handling utilities.</p>
<p>Packages with names like <code class="verbatim">base</code> or <code class="verbatim">common</code> are often found when functionality common to two or more implementations, or common types for a client and server, has been refactored into a separate package. Their names also represent design holdovers from languages like Java and C++ where the relationship between packages followed similar rules to those of inheretence. I believe the solution to packeges like <code class="verbatim">base</code> or <code class="verbatim">common</code> is to reduce the number of packages, combine the client, server, and common code into a single package named after the behaviour delivered from the previously fractured packages.</p>
</section>
<section id="a-public-identifier-includes-its-package-name" class="level4" data-number="5.1.1.4">
<h4 data-number="5.1.1.4"><span class="header-section-number">5.1.1.4</span> A Public Identifier Includes Its Package Name</h4>
<p>It’s important to remember that the name of an identifier includes the name of its package.</p>
<ul>
<li>The <code class="verbatim">Get</code> function from the <code class="verbatim">net/http</code> package becomes <code class="verbatim">http.Get</code> when referenced by another package.</li>
<li>The <code class="verbatim">Reader</code> type from the <code class="verbatim">strings</code> package becomes <code class="verbatim">strings.Reader</code> when imported into other packages.</li>
<li>The <code class="verbatim">Error</code> interface from the <code class="verbatim">net</code> package is clearly related to network errors.</li>
</ul>
</section>
<section id="return-early-rather-than-nesting-deeply" class="level4" data-number="5.1.1.5">
<h4 data-number="5.1.1.5"><span class="header-section-number">5.1.1.5</span> Return Early Rather Than Nesting Deeply</h4>
<p>As Go does not use exceptions for control flow there is no requirement to deeply indent your code just to provide a top level structure for the <code class="verbatim">try</code> and <code class="verbatim">catch</code> blocks. Rather than the successful path nesting deeper and deeper to the right, Go code is written in a style where the success path continues down the screen as the function progresses. My friend Mat Ryer <a href="https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88">calls this practice 'line of sight' coding</a>.</p>
<p>This is achieved by using <em>guard clauses</em>; conditional blocks with assert preconditions upon entering a function. Here is an example from the bytes package,</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>b <span class="op">*</span>Buffer<span class="op">)</span> UnreadRune<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> b<span class="op">.</span>lastRead <span class="op">&lt;=</span> opInvalid <span class="op">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> errors<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune&quot;</span><span class="op">)</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> b<span class="op">.</span>off <span class="op">&gt;=</span> <span class="dt">int</span><span class="op">(</span>b<span class="op">.</span>lastRead<span class="op">)</span> <span class="op">{</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>  b<span class="op">.</span>off <span class="op">-=</span> <span class="dt">int</span><span class="op">(</span>b<span class="op">.</span>lastRead<span class="op">)</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a> b<span class="op">.</span>lastRead <span class="op">=</span> opInvalid</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Upon entering <code class="verbatim">UnreadRune</code> the state of <code class="verbatim">b.lastRead</code> is checked and if the previous operation was not <code class="verbatim">ReadRune</code> an error is returned immediately. From there the rest of the function proceeds with the assertion that <code class="verbatim">b.lastRead</code> is greater than <code class="verbatim">opInvalid</code>.</p>
<p>Compare this to the same function written without a guard clause,</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>b <span class="op">*</span>Buffer<span class="op">)</span> UnreadRune<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> b<span class="op">.</span>lastRead <span class="op">&gt;</span> opInvalid <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> b<span class="op">.</span>off <span class="op">&gt;=</span> <span class="dt">int</span><span class="op">(</span>b<span class="op">.</span>lastRead<span class="op">)</span> <span class="op">{</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>   b<span class="op">.</span>off <span class="op">-=</span> <span class="dt">int</span><span class="op">(</span>b<span class="op">.</span>lastRead<span class="op">)</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>  b<span class="op">.</span>lastRead <span class="op">=</span> opInvalid</span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> errors<span class="op">.</span>New<span class="op">(</span><span class="st">&quot;bytes.Buffer: UnreadRune: previous operation was not a successful ReadRune&quot;</span><span class="op">)</span></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The body of the successful case, the most common, is nested inside the first <code class="verbatim">if</code> condition and the successful exit condition, <code class="verbatim">return nil</code>, has to be discovered by careful matching of <em>closing</em> braces. The final line of the function now returns an error, and the reader must trace the execution of the function back to the matching <em>opening</em> brace to know when control will reach this point.</p>
<p>This is more error prone for the reader, and the maintenance programmer, hence why Go prefer to use guard clauses and returning early on errors.</p>
</section>
<section id="make-the-zero-value-useful" class="level4" data-number="5.1.1.6">
<h4 data-number="5.1.1.6"><span class="header-section-number">5.1.1.6</span> Make The Zero Value Useful</h4>
<p>Every variable declaration, assuming no explicit initialiser is provided, will be automatically initialised to a value that matches the contents of zeroed memory. This is the value’s <em>zero value</em>. The type of the value determines it’s zero value; for numeric types it is zero, for string types it is <code class="verbatim">""</code>, for pointer types <code class="verbatim">nil</code>, the same for slices, maps, and channels.</p>
<p>This property of always setting a value to a known default is important for safety and correctness of your program and can make your Go programs simpler and more compact. This is what Go programmers talk about when they say "give your structs a useful zero value".</p>
<p>Consider the <code class="verbatim">sync.Mutex</code> type. <code class="verbatim">sync.Mutex</code> contains two unexported integer fields, representing the mutex’s internal state. Thanks to the zero value those fields will be set to will be set to <code class="verbatim">0</code> whenever a <code class="verbatim">sync.Mutex</code> is declared. <code class="verbatim">sync.Mutex</code> has been deliberately coded to take advantage of this property, making the type usable without explicit initialisation.</p>
<div class="sourceCode" id="cb114"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> m sync<span class="op">.</span>Mutex</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  val <span class="op">:=</span> <span class="dv">1</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// m is usable without explicit initialisation.</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span>Lock<span class="op">()</span></span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>  val<span class="op">++</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>  m<span class="op">.</span>Unlock<span class="op">()</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="NOTE">
<p>Be aware that some values ( such as <code class="verbatim">sync.Mutex</code> ) should never be copied, only passed by reference – initialized or not.</p>
</div>
<p>Another example of a type with a useful zero value is <code class="verbatim">bytes.Buffer</code>. You can declare a <code class="verbatim">bytes.Buffer</code> and start writing to it without explicit initialisation.</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> b bytes<span class="op">.</span>Buffer</span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a> b<span class="op">.</span>WriteString<span class="op">(</span><span class="st">&quot;Hello, world!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a> io<span class="op">.</span>Copy<span class="op">(</span>os<span class="op">.</span>Stdout<span class="op">,</span> <span class="op">&amp;</span>b<span class="op">)</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A useful property of slices is their zero value is <code class="verbatim">nil</code>. This makes sense if we look at the runtime’s (pseudo) definition of a slice header.</p>
<div class="sourceCode" id="cb116"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> slice <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>        array <span class="op">*[...]</span>T <span class="co">// pointer to the underlying array</span></span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">len</span>   <span class="dt">int</span></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">cap</span>   <span class="dt">int</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The zero value of this struct would imply <code class="verbatim">len</code> and <code class="verbatim">cap</code> have the value <code class="verbatim">0</code>, and <code class="verbatim">array</code>, the pointer to memory holding the contents of the slice’s backing array, would be <code class="verbatim">nil</code>. This means unless you need to specify a size you don’t need to explicitly make a slice, you can just declare it.</p>
<div class="sourceCode" id="cb117"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// s := make([]string, 0)</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a> <span class="co">// s := []string{}</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> s <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a> s <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>s<span class="op">,</span> <span class="st">&quot;Hello&quot;</span><span class="op">)</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a> s <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>s<span class="op">,</span> <span class="st">&quot;world&quot;</span><span class="op">)</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Println<span class="op">(</span>strings<span class="op">.</span>Join<span class="op">(</span>s<span class="op">,</span> <span class="st">&quot; &quot;</span><span class="op">))</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As a quick note, <code class="verbatim">var s []string</code> is similar to the two commented lines above it, but not identical. It is possible to detect the difference between a slice value that is nil and a slice value that has zero length.</p>
<div class="sourceCode" id="cb118"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> s1 <span class="op">=</span> <span class="op">[]</span><span class="dt">string</span><span class="op">{}</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> s2 <span class="op">[]</span><span class="dt">string</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Println<span class="op">(</span>reflect<span class="op">.</span>DeepEqual<span class="op">(</span>s1<span class="op">,</span> s2<span class="op">))</span> <span class="co">// false</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A useful, albeit surprising, property of uninitialised pointer variables—​nil pointers—​is you can call methods on types that have a nil value. This can be used to provide default values simply.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Config <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a> path <span class="dt">string</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>c <span class="op">*</span>Config<span class="op">)</span> Path<span class="op">()</span> <span class="dt">string</span> <span class="op">{</span></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> c <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="st">&quot;/usr/home&quot;</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> c<span class="op">.</span>path</span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> c1 <span class="op">*</span>Config</span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> c2 <span class="op">=</span> <span class="op">&amp;</span>Config<span class="op">{</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a>  path<span class="op">:</span> <span class="st">&quot;/export&quot;</span><span class="op">,</span></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a> fmt<span class="op">.</span>Println<span class="op">(</span>c1<span class="op">.</span>Path<span class="op">(),</span> c2<span class="op">.</span>Path<span class="op">())</span></span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</section>
<section id="avoid-package-level-state" class="level4" data-number="5.1.1.7">
<h4 data-number="5.1.1.7"><span class="header-section-number">5.1.1.7</span> Avoid Package Level State</h4>
<p>The key to writing maintainable programs is that they should be loosely coupled. A change to one package should have a low probability of affecting another.</p>
<p>There are two excellent ways to achieve loose coupling in Go:</p>
<ol>
<li>Use interfaces to describe the behaviour your functions or methods require.</li>
<li>Avoid the use of global state.</li>
</ol>
<p>In Go we can declare variables at the block, function, or method scope, and also at the package scope. When the variable is public, given a identifier starting with a capital letter, then its scope is effectively global to the entire program—​any package may observe the type and contents of that variable at <em>any time</em>.</p>
<p>Mutable global state introduces tight coupling between independent parts of your program as global variables become an invisible parameter to every function in your program! Any function that relies on a global variable can be broken if that variable’s type changes. Any function that relies on the state of a global variable can be broken if another part of the program changes that variable.</p>
<p>If you want to reduce the coupling a global variable creates,</p>
<ol>
<li>Move the relevant variables as fields on structs that need them.</li>
<li>Use interfaces to reduce the coupling between the behaviour and the implementation of that behaviour.</li>
</ol>
<p>For a more in-depth reason on why we should avoid package-level state ( aka: global variables ), <a href="https://dave.cheney.net/2017/06/11/go-without-package-scoped-variables">Dave Cheny has an excellent write-up that goes into this in depth</a>.</p>
</section>
</section>
<section id="interfaces" class="level3" data-number="5.1.2">
<h3 data-number="5.1.2"><span class="header-section-number">5.1.2</span> Interfaces</h3>
<p>For folks coming from other languages, interfaces can be hard to wrap your head around. They're used in a number of ways that make really understanding them a tricky prospect.</p>
<p>At their core, though, this is what interfaces are:</p>
<div class="HIGHLIGHT">
<p>A way to specify the expected behaviour of an object; if it can do <em>this</em>, then it can be used <em>here</em>.</p>
</div>
<section id="the-empty-interface-aka-any" class="level4" data-number="5.1.2.1">
<h4 data-number="5.1.2.1"><span class="header-section-number">5.1.2.1</span> The Empty <code class="verbatim">interface{}</code> ( AKA: <code class="verbatim">any</code> )</h4>
<p>So the empty interface is a side effect of the way interfaces and the type system interact. An interface is a way of disregarding type so that code can specify behaviour. What this means is that if you have an interface like so:</p>
<div class="sourceCode" id="cb120"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Higher <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  GetHigh<span class="op">()</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>…and then define two types:</p>
<div class="sourceCode" id="cb121"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> SimpleHigh <span class="dt">string</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="co">// GetHigh ...</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>s <span class="op">*</span>SimpleHigh<span class="op">)</span> GetHigh<span class="op">()</span> <span class="op">{</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>s <span class="op">=</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;🍍%v🍍&quot;</span><span class="op">,</span> s<span class="op">)</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ComplexHigh <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>ch <span class="op">*</span>ComplexHigh<span class="op">)</span> GetHigh<span class="op">()</span> <span class="op">{</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// imagine like 100 lines of code</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>A function can be written to accept anything that implements the <code class="verbatim">Higher</code> interface without having to care about what type it is. The function doesn't care if it's a string, an in, an empty struct, or a struct with hundreds of fields – all it cares about is "can I call <code class="verbatim">GetHigh()</code> on what I've been passed?".</p>
<p>So it should be clear at this point that interfaces are a way of sidestepping the type system to allow developers to focus on behaviour rather than concrete hierarchies.</p>
<p>What does this have to do with the empty interface?</p>
<p>Well, think about what the empty interface <em>is</em>. It's an interface that defines no functions. Therefore, <code class="verbatim">interface{}</code> is an interface that every type in Go fits into. Now, this doesn't mean you should use <code class="verbatim">interface{}</code> to get around types – very much the opposite, in fact.</p>
<p>The combination of types and interfaces means that Go code can focus on type when important, and behaviour when that's important.</p>
<p>So given everything we've gone over, where should interfaces get defined?</p>
<p>Going back to the core reason for interfaces ( defining accepted behaviour ), then it seems pretty clear that the thing accepting the interface is what should be defining the interface. In other words, define interfaces within the packages where they are used. A corollary to this is that for the most part, interfaces should be private, not exported.</p>
</section>
<section id="keep-interfaces-as-small-as-possible" class="level4" data-number="5.1.2.2">
<h4 data-number="5.1.2.2"><span class="header-section-number">5.1.2.2</span> Keep Interfaces As Small As Possible</h4>
<p>Every method you define in an interface is one more method you have to write on every type if you want to use it where the code is expecting that interface. Most interfaces should be only a single function, and three is about as many as you should have – preferably. These rules also apply when composing an interface from other interfaces.</p>
<p>For example, <code class="verbatim">io.ReadWriterSeeker</code> is composed of three interfaces: <code class="verbatim">Reader</code>, <code class="verbatim">Writer</code>, and <code class="verbatim">Seeker</code>. However, each of those interfaces only defines a single function.</p>
<p>Interfaces are meant to be as general as possible. Your interfaces should define the smallest number of functions required to do something. If you need more than three functions in an interface, think about why that is – and if there's a better way to solve the problem.</p>
</section>
</section>
<section id="functions" class="level3" data-number="5.1.3">
<h3 data-number="5.1.3"><span class="header-section-number">5.1.3</span> Functions</h3>
<p>So Go has functions and methods. The first are these:</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Something<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Methods are these:</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>m <span class="op">*</span>MyStruct<span class="op">)</span> Something<span class="op">()</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For clarity: if I say 'function' I mean functions or methods. When I say 'method' I mean just methods.</p>
<section id="prefer-shorter-functions" class="level4" data-number="5.1.3.1">
<h4 data-number="5.1.3.1"><span class="header-section-number">5.1.3.1</span> Prefer Shorter Functions</h4>
<blockquote>
<p>The maximum length of a function is inversely proportional to the complexity and indentation level of that function.</p>
<p>— Linux Kernel style guide[linux]</p>
</blockquote>
<p>Each function should be written in terms of a single level of abstraction. Ideally a function should do one, and only one, thing.</p>
<blockquote>
<p>Naive programmers think that design means “don’t make functions or classes too long”. However, the real problem is writing code that mixes unrelated ideas.</p>
<p>— Justin Meiners[meiners2019]</p>
</blockquote>
<p>This should place an upper limit on the length of a function which is beneficial because, besides longer functions being harder to read, longer functions are more likely to mix more than one idea. The required disentanglement must then be performed by the reader.</p>
</section>
<section id="avoid-named-return-values" class="level4" data-number="5.1.3.2">
<h4 data-number="5.1.3.2"><span class="header-section-number">5.1.3.2</span> Avoid Named Return Values</h4>
<p>Named return values permit the function’s author to;</p>
<ul>
<li>Increase separation between declaration and use. Which runs contrary to the previous suggestion, and decreases readability, especially when the function or method is long.</li>
<li>Increase the risk of shadowing.</li>
<li>Enable the use of naked returns.</li>
</ul>
<p>Each of which are a net negative on the readability of the function.</p>
<ul>
<li>Named returned arguments introduce a discontinuity in the declaration of variables.</li>
<li>Named returns move the declaration to an unexpected location.</li>
<li>Named returns force you to declare all return parameters, or worse declare them _.</li>
</ul>
<p>In short, named return values are a symptom of a clever piece of code which should be reviewed with suspicion. If the method is infact simple, then named returns values are playing the short game of brevity over readability.</p>
<p>Its’s my opinion that names return arguments should not be used unless required to provide something that could not reasonably be done another way. For example, to modify the return arguments in a defer block, where it is required to name return arguments to capture them.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ReadFile<span class="op">(</span>name <span class="dt">string</span><span class="op">)</span> <span class="op">(</span>output <span class="dt">string</span><span class="op">,</span> err <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">defer</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>   err <span class="op">=</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;could not read %q: %v&quot;</span><span class="op">,</span> name<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a> f<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>Open<span class="op">(</span>name<span class="op">)</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> err</span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a> <span class="co">// ...</span></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>What is clear is that this function is complex, and named return values are part of that complexity.</p>
<p>All things being equal, you should aim to write simple code, not clever code. And so should avoid designs that require named return values.</p>
<p>There is nothing you can do with named return values that you cannot do with a few more lines of code. Avoid them if possible.</p>
</section>
<section id="avoid-naked-returns" class="level4" data-number="5.1.3.3">
<h4 data-number="5.1.3.3"><span class="header-section-number">5.1.3.3</span> Avoid Naked Returns</h4>
<p>Naked returns combine the declaration of a return value in the function declaration with an unspecified assignment somewhere in the body of the function. Everything about the use of naked returns admits a set of actions that hides bugs, in even small functions.</p>
<p>Naked returns are inconsistent; they make it look like the function or method returns no values, when infact it does, as they were declared in the function signature.</p>
<p>Naked returns are often used inconsistently, especially in an error path where nil is returned explicitly, or the zero value of a named return value is used. Combined with early returns this results in multiple, sometimes conflicting, return statements Use naked return consistently or not at all.</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>f <span class="op">*</span>Filter<span class="op">)</span> Open<span class="op">(</span>name <span class="dt">string</span><span class="op">)</span> <span class="op">(</span>file File<span class="op">,</span> err <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> c <span class="op">:=</span> <span class="kw">range</span> f<span class="op">.</span>chain <span class="op">{</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>  file<span class="op">,</span> err <span class="op">=</span> c<span class="op">.</span>Open<span class="op">(</span>name<span class="op">)</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">return</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> f<span class="op">.</span>source<span class="op">.</span>Open<span class="op">(</span>name<span class="op">)</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>If you must use naked returns; use only naked returns in a function  —  don’t mix and match.</p>
</section>
<section id="method-receivers" class="level4" data-number="5.1.3.4">
<h4 data-number="5.1.3.4"><span class="header-section-number">5.1.3.4</span> Method Receivers</h4>
<p>So that we're all on the same page:</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a> <span class="kw">func</span> <span class="op">(</span>t Thing<span class="op">)</span> Do<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="co">//    ^--- this thing</span></span></code></pre></div>
<p>That thing being pointed to is the method receiver. Think of it as a special 0th argument passed into the <code class="verbatim">Do</code> function that you never have to implicitly pass in.</p>
<p>So what about method receivers?</p>
<p>Well, like all types in Go they can be values or pointers. This means that when you call a method that has a non-pointer receiver the entire type is copied and passed into the function. This is why non-pointer receivers can't change the struct or type they're attached to – for the most part. There are some types that don't require an implicit pointer that can modify the receiver; however these are types that usually already pointers, like slices. Additionally, trying to be "clever" about this usually ends up with hard-to-parse code – so try to avoid it when you can.</p>
<p>So which should we use: pointer receivers or value receivers?</p>
<p>At first you might want to use value receivers as much as possible, to ensure a method doesn't "accidentally" change the receiver when it shouldn't.</p>
<p>But the truth is that outside of some specific situations, it's pretty much safer to always use a pointer receiver.</p>
<p>From the <a href="https://github.com/golang/go/wiki/CodeReviewComments#receiver-type">GitHub wiki on the 'go' repository</a>:</p>
<blockquote>
<p>Choosing whether to use a value or pointer receiver on methods can be difficult, especially to new Go programmers. If in doubt, use a pointer, but there are times when a value receiver makes sense, usually for reasons of efficiency, such as for small unchanging structs or values of basic type. Some useful guidelines:</p>
<ul>
<li>If the receiver is a map, func or chan, don't use a pointer to them. If the receiver is a slice and the method doesn't reslice or reallocate the slice, don't use a pointer to it.</li>
<li>If the method needs to mutate the receiver, the receiver must be a pointer.</li>
<li>If the receiver is a struct that contains a sync.Mutex or similar synchronizing field, the receiver must be a pointer to avoid copying.</li>
<li>If the receiver is a large struct or array, a pointer receiver is more efficient. How large is large? Assume it's equivalent to passing all its elements as arguments to the method. If that feels too large, it's also too large for the receiver.</li>
<li>Can function or methods, either concurrently or when called from this method, be mutating the receiver? A value type creates a copy of the receiver when the method is invoked, so outside updates will not be applied to this receiver. If changes must be visible in the original receiver, the receiver must be a pointer.</li>
<li>If the receiver is a struct, array or slice and any of its elements is a pointer to something that might be mutating, prefer a pointer receiver, as it will make the intention clearer to the reader.</li>
<li>If the receiver is a small array or struct that is naturally a value type (for instance, something like the time.Time type), with no mutable fields and no pointers, or is just a simple basic type such as int or string, a value receiver makes sense. A value receiver can reduce the amount of garbage that can be generated; if a value is passed to a value method, an on-stack copy can be used instead of allocating on the heap. (The compiler tries to be smart about avoiding this allocation, but it can't always succeed.) Don't choose a value receiver type for this reason without profiling first.</li>
<li>Don't mix receiver types. Choose either pointers or struct types for all available methods.</li>
<li>Finally, when in doubt, use a pointer receiver.</li>
</ul>
</blockquote>
<p>So how do we find out if we need to make like the standard library in <a href="https://github.com/golang/go/blob/a1053ed6107a8301a62be9d1f2da8fa387bfefea/src/net/http/server.go#L713-L718">net/http/server.go#Write()</a>?</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Write writes the headers described in h to w.</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a><span class="co">// This method has a value receiver, despite the somewhat large size</span></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="co">// of h, because it prevents an allocation. The escape analysis isn&#39;t</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="co">// smart enough to realize this function doesn&#39;t mutate h.</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>h extraHeader<span class="op">)</span> Write<span class="op">(</span>w <span class="op">*</span>bufio<span class="op">.</span>Writer<span class="op">)</span> <span class="op">{</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">//...</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is one of those situations where the answer boils down to: when your benchmarks and profiling tells you to.</p>
<p>For even more on this, <a href="https://stackoverflow.com/a/27775558/62225">check out this great StackOverflow answer</a>.</p>
</section>
<section id="nil-receivers-are-programming-errors-not-runtime-errors" class="level4" data-number="5.1.3.5">
<h4 data-number="5.1.3.5"><span class="header-section-number">5.1.3.5</span> Nil Receivers Are Programming Errors, Not Runtime Errors</h4>
<p>There are four things you can do when writing a method on a pointer receiver, and the receiver is nil at the time of the function call:</p>
<ul>
<li>panic</li>
<li>return an error</li>
<li>silently return</li>
<li>do nothing</li>
</ul>
<p>And as strange as it sounds, the best option is "do nothing".</p>
<p>Why?</p>
<p>Well for panicing: the code will panic anyways if the receiver is nil and you try to access a field. So the only thing you get out of panicing early is being able to set the panic message; not that handy as panics come with a stack trace.</p>
<p>Returning an error means: <em>every</em> <strong>single</strong> method has to return an error. Callers <em>have</em> to check the error after <em>every</em> call. Every interface method has to return an error.</p>
<p>Silently returning isn't great. Can you imagine trying to debug a complex failure in an application because a <code class="verbatim">nil</code> receiver caused some logic not to get fired?</p>
<p>Given there is no reasonable way for the method executed on a nil receiver to protected against this, the remaining option is to simply not worry about it. After all a nil receiver is a symptom of a bug that happened elsewhere in your code. The most likely cause was a failure to check the error from a previous call. That is the place where you should spend your efforts, not defensively trying to code around a failure to follow proper error handling.</p>
<p>Don’t check for a nil receiver. Employ high test coverage and vet/lint tools to spot unhandled error conditions resulting in nil receivers.</p>
</section>
</section>
</section>
<section id="project-structure" class="level2" data-number="5.2">
<h2 data-number="5.2"><span class="header-section-number">5.2</span> Project Structure</h2>
<p>As you've probably noticed, Go doesn't have any kind of recommended folder structure – and anyone who tells you otherwise is lying.</p>
<p>Go doesn't work like Ruby on Rails, with a somewhat rigid folder structure that defines where stuff like models or views or controllers go.</p>
<p>However, that doesn't mean Go projects have <em>no</em> structure. Far from it! At the very least, we need folders in order to logically separate packages. You can't have two files with different <code class="verbatim">package</code> declarations in the same folder, the compiler will complain. So Go has <em>some</em> structure: packages.</p>
<p>So far we've talked about what goes into good package design, but haven't touched on package layout – how the folders and everything should be laid out. That's because they are mostly separate topics.</p>
<p>The overlap has mostly do with with naming and ensuring you're organizing your packages in a way that makes sense. For example, putting packages that implement a different version of a "parent" package – such as the <code class="verbatim">encoding</code> package from the standard library. <code class="verbatim">encoding</code> defines four interfaces, and then there are eleven sub-packages that do various kinds of encoding. These include <code class="verbatim">encoding/json</code>, <code class="verbatim">encoding/base64</code>, and <code class="verbatim">encoding/csv</code>. If you look closely though, not all the sub-packages define types that fulfill the interfaces defined in <code class="verbatim">encoding</code>.</p>
<p>Why is that? Well, all the sub-packages do deal with encoding. Additionally, there's nothing that states sub-packages <em>have</em> to use what's defined in the "parent" package. Think of it from the perspective from naming; <code class="verbatim">encoding/base64</code> is pretty clear what it does: encode and decode base64 encoded data. If <code class="verbatim">base64</code> was just a top-level standard library package, is that as clear? Would the name maybe have to change to <code class="verbatim">base64Encoding</code> to make it clear what the package is for? But going back to our guiding principles, which is simpler; <code class="verbatim">encoding/base64</code> or <code class="verbatim">base64Encoding</code>. Well, if you've only got one encoder and it's the base64 version, you could make an argument for <code class="verbatim">base64Encoding</code>. Maybe.</p>
<p>Anyways, let's talk about some other things related to project structure.</p>
<section id="internal-not-pkg" class="level3" data-number="5.2.1">
<h3 data-number="5.2.1"><span class="header-section-number">5.2.1</span> <code class="verbatim">internal</code>, Not <code class="verbatim">pkg</code></h3>
<p>As <a href="https://dave.cheney.net/2019/10/06/use-internal-packages-to-reduce-your-public-api-surface">Dave Cheney explains</a>, the <code class="verbatim">pkg</code> folder is a holdover from the early days of Go:</p>
<blockquote>
<p>In the beginning, before the go tool, before Go 1.0, the Go distribution stored the standard library in a subdirectory called pkg/ and the commands which built upon it in cmd/. This wasn’t so much a deliberate taxonomy but a by product of the original make based build system. In September 2014, the Go distribution dropped the pkg/ subdirectory, but then this tribal knowledge had set root in large Go projects and continues to this day.</p>
</blockquote>
<p>So rather than a choice, it was a constraint. And it's <a href="https://dave.cheney.net/practical-go/presentations/gophercon-singapore-2019.html#_project_structure">not even recommended any more</a>:</p>
<blockquote>
<p>Possibly because of the early use of a pkg/ directory to hold package—​and the corresponding cmd/ directory to hold commands (package main) this practice of putting your packages in an empty pkg/ directory has spread to other Go projects. This practice was never a recommendation, just a result of the original Makefile based build system.</p>
<p>In September 2014, the stdlib moved away from storing package code in an otherwise empty pkg/ directory, and you should follow their lead. Other than a superficial symetary with cmd/ putting packages in a pkg/ directory is needless boilerplate and distracts from the potentially more useful internal/ directory.</p>
</blockquote>
<p>Side note: ignore both the repositories owned by <a href="https://github.com/golang-standards">golang-standards</a>. That organization has no official standing, and in some cases actively recommend anti-patterns like the <code class="verbatim">pkg</code> folder.</p>
<p>However, there is something better that we can use instead, which Dave mentioned at the end of that last quote: <code class="verbatim">internal</code>.</p>
<p>Like <code class="verbatim">testdata</code>, <code class="verbatim">internal</code> has a special meaning within the Go compiler.</p>
<p>For <code class="verbatim">testdata</code>, it's one of the names the compiler will just straight-up ignore when <a href="https://dave.cheney.net/2016/05/10/test-fixtures-in-go">looking for code</a>, along with folders starting with a period or an underscore. This is because <code class="verbatim">testdata</code> is a pretty handy way to have files you want to ensure the compiler doesn't attempt to compile; particularly handy when testing stuff like ASTs!</p>
<p>However, we're talking about <code class="verbatim">interna</code> here, not <code class="verbatim">testdata</code>.</p>
<p>So what does <code class="verbatim">internal</code> do? Basically: it's how to prevent your packages from being imported inside a package that doesn't share a common ancestor.</p>
<p>To quote a bit more from Dave:</p>
<blockquote>
<p>To create an internal package, place it within a directory named internal/. When the go command sees an import of a package with internal/ in the import path, it verifies that the importing package is within the tree rooted at the parent of the internal/ directory.</p>
<p>For example, a package /a/b/c/internal/d/e/f can only be imported by code in the directory tree rooted at /a/b/c. It cannot be imported by code in /a/b/g or in any other repository.</p>
</blockquote>
<p>This is a <em>very</em> good thing. Think about separation of responsibilities and all that fun stuff. How do you enforce something like "only the Ads service should ever import package <code class="verbatim">x</code>"? Without an <code class="verbatim">internal</code> folder, you can't. So code that should only be used by the Ads service could potentially be imported and used by another project. Which means you have to treat every package that exports any symbols as part of your public API.</p>
<p>And that sounds like a support nightmare.</p>
<p>So by using <code class="verbatim">internal</code> we create a very simple way to separate the public API of a module from the private API.</p>
<p>One last thing on folder layout: every package, with the exception of <code class="verbatim">cmd/</code> and <code class="verbatim">internal/</code>, should contain some source code. That's not to say <code class="verbatim">internal</code> <em>can't</em> have any source code, just that it's one of the two folders it's not <em>required</em>.</p>
</section>
<section id="consider-fewer-larger-packages" class="level3" data-number="5.2.2">
<h3 data-number="5.2.2"><span class="header-section-number">5.2.2</span> Consider Fewer, Larger Packages</h3>
<p>Go does not provide elaborate ways of establishing visibility. Go lacks Java’s <code class="verbatim">public</code>, <code class="verbatim">protected</code>, <code class="verbatim">private</code>, and implicit <code class="verbatim">default</code> access modifiers. There is no equivalent of C++'s notion of a <code class="verbatim">friend</code> classes.</p>
<p>In Go we have only two access modifiers, public and private, the former indicated by the capitalisation of the first letter of the identifier. If an identifier is public, it’s name starts with a capital letter, that identifier can be referenced by any other Go package.</p>
<p>You may hear people say exported and not exported as synonyms for public and private.</p>
<p>Given the limited controls available to control access to a package’s symbols, what practices should Go programmers follow to avoid creating over-complicated package hierarchies?</p>
<p>The advice we've found repeated often elsewhere online is this: prefer fewer, larger packages. Your default position should be to not create a new package. That will lead to too many types being made public creating a wide, shallow, API surface for your package.</p>
<p>If you’re coming from a Java or C# background, consider this rule of thumb.</p>
<ul>
<li>A Java package is equivalent to a single <code class="verbatim">.go</code> source file.</li>
<li>A Go package is equivalent to a whole Maven module or .NET assembly.</li>
</ul>
<p>This is worth going into more detail, so that's exactly what we're going to do!</p>
<section id="arrange-code-into-files-by-import-statements" class="level4" data-number="5.2.2.1">
<h4 data-number="5.2.2.1"><span class="header-section-number">5.2.2.1</span> Arrange code into files by import statements</h4>
<p>If you’re arranging your packages by what they provide to callers, should you do the same for files within a Go package? How do you know when you should break up a .go file into multiple ones? How do you know when you’ve gone to far and should instead consolidate several .go files together?</p>
<p>Here are some basic guidelines:</p>
<ul>
<li>Start each package with one <code class="verbatim">.go</code> file. Give that file the same name as the name of the folder. For example the source for <code class="verbatim">package http</code> should be placed in a file called <code class="verbatim">http.go</code> in a directory named <code class="verbatim">http</code>.</li>
<li>As your package grows you may decide to split apart the various responsibilities into different files. eg, <code class="verbatim">messages.go</code> contains the <code class="verbatim">Request</code> and <code class="verbatim">Response</code> types, <code class="verbatim">client.go</code> contains the <code class="verbatim">Client</code> type, <code class="verbatim">server.go</code> contains the <code class="verbatim">Server</code> type.</li>
<li>If you find your files have similar <code class="verbatim">import</code> declarations, consider combining them. Alternatively, identify the differences between the import sets and move those types/functions/methods into their own file.</li>
<li>Different files should be responsible for different areas of the package. <code class="verbatim">messages.go</code> may be responsible for marshalling of HTTP requests and responses on and off the network, <code class="verbatim">http.go</code> may contain the low level network handling logic, <code class="verbatim">client.go</code> and <code class="verbatim">server.go</code> implement the HTTP business logic of request construction or routing, and so on.</li>
</ul>
<p>Prefer nouns for source file names. They are containers for source code after all.</p>
<p>And as a note: the Go compiler compiles each package in parallel. Within a package the compiler compiles each function (methods are just fancy functions in Go) in parallel. Changing the layout of your code within a package should not affect compilation time.</p>
</section>
<section id="keep-package-main-as-small-as-possible" class="level4" data-number="5.2.2.2">
<h4 data-number="5.2.2.2"><span class="header-section-number">5.2.2.2</span> Keep <code class="verbatim">package main</code> as small as possible</h4>
<p>Your <code class="verbatim">main</code> function, and <code class="verbatim">main</code> package should do as little as possible. This is because <code class="verbatim">main.main</code> acts as a singleton; there can only be one main function in a program.</p>
<p>Because <code class="verbatim">main.main</code> is a singleton there are a lot of assumptions built into the things that <code class="verbatim">main.main</code> will call, that they will only be called during <code class="verbatim">main.main</code> or <code class="verbatim">main.init</code>, and only called once. This makes it hard to write tests for code written in <code class="verbatim">main.main</code>. Main packages often invoke singletons, parse command line flags, expect files to be on disk in a certain place, and never expect to be executed concurrently. You can’t even reference <code class="verbatim">main.main</code> from a test.</p>
<p>Thus you should aim to move as much of your business logic out of your main function and ideally out of your main package. <code class="verbatim">func main()</code> should parse flags, open connections to databases, loggers, and such, then hand off execution to a high level object.</p>
</section>
<section id="prefer-internal-tests-to-external-tests" class="level4" data-number="5.2.2.3">
<h4 data-number="5.2.2.3"><span class="header-section-number">5.2.2.3</span> Prefer internal tests to external tests</h4>
<p>The <code class="verbatim">go</code> tool supports writing your testing package tests in two places. Assuming your package is called <code class="verbatim">http2</code>, you can write a <code class="verbatim">http2_test.go</code> file and use the <code class="verbatim">package http2</code> declaration. Doing so will compile the code in <code class="verbatim">http2_test.go</code> as if it were part of the <code class="verbatim">http2</code> package. This is known colloquially as an internal test.</p>
<p>The <code class="verbatim">go</code> tool also supports a special package declaration, ending in test, ie., <code class="verbatim">package http_test</code>. This allows your test files to live alongside your code in the same package, however when those tests are compiled they are not part of your package’s code, they live in their own package. This allows you to write your tests as if you were another package calling into your code. This is known as an external test.</p>
<p>We recommend using internal tests when writing unit tests for your package. This allows you to test each function or method directly, avoiding the bureaucracy of external testing.</p>
<p>However, you should place your <code class="verbatim">Example</code> test functions in an external test file. This ensures that when viewed in godoc, the examples have the appropriate package prefix and can be easily copy pasted.</p>
</section>
</section>
</section>
<section id="api-design" class="level2" data-number="5.3">
<h2 data-number="5.3"><span class="header-section-number">5.3</span> API Design</h2>
<p>So far everything we've talked about are definitely more "guidelines" than "rules". They are meant to help guide our code into a state that is clean and maintainable. Missing one or two guidelines shouldn't cause a code review to fail – while at the same time, it shouldn't be that hard to implement the guideline anyways.</p>
<p>Pretty much everything above are things that can be changed without breaking backwards compatibility. Changes like renaming variables, renaming packages, etc – there are refactoring tools which make these changes easy and simple to implement.</p>
<p>However, when it comes to API design we need to be less forgiving.</p>
<p>When it comes to the public API of a package, it pays to put considerable thought into the initial design, because changing that design later is going to be disruptive for people who are already using your API. Changing your public API forces the existing user base to have to dedicate engineering resources to upgrading across your API break. The larger the break, the more likely this task will be considered low impact, but high risk, and likely to be pushed off in light of other business priorities.</p>
<p>This is the same whether you're changing function names and arguments in your code, or changing the routes your services provide.</p>
<p>So let's talk about Go code APIs, and some guidelines on how we can write good APIs.</p>
<section id="high-level" class="level3" data-number="5.3.1">
<h3 data-number="5.3.1"><span class="header-section-number">5.3.1</span> High Level</h3>
<section id="design-apis-that-are-hard-to-misuse" class="level4" data-number="5.3.1.1">
<h4 data-number="5.3.1.1"><span class="header-section-number">5.3.1.1</span> Design APIs That Are Hard To Misuse</h4>
<blockquote>
<p>APIs should be easy to use and hard to misuse.</p>
<p>— <a href="https://www.infoq.com/articles/API-Design-Joshua-Bloch/">Josh Bloch</a></p>
</blockquote>
<p>If you take anything away from this section, it should be this advice from Josh Bloch. If an API is hard to use for simple things, then every invocation will look complicated. When the actual invocation of the API is complicated it will be less obvious and more likely to be overlooked.</p>
<section id="be-wary-of-functions-with-several-parameters-of-the-same-type" class="level5" data-number="5.3.1.1.1">
<h5 data-number="5.3.1.1.1"><span class="header-section-number">5.3.1.1.1</span> Be wary of functions with several parameters of the same type</h5>
<p>A good example of a simple looking, but hard to use correctly, API is one which takes two or more parameters of the same type. Let’s compare two function signatures:</p>
<div class="sourceCode" id="cb128"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Max<span class="op">(</span>a<span class="op">,</span> b <span class="dt">int</span><span class="op">)</span> <span class="dt">int</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> CopyFile<span class="op">(</span>to<span class="op">,</span> from <span class="dt">string</span><span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>What’s the difference between these two functions? Obviously one returns the maximum of two numbers, the other copies a file, but that’s not the important thing.</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>Max<span class="op">(</span><span class="dv">8</span><span class="op">,</span> <span class="dv">10</span><span class="op">)</span> <span class="co">// 10</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>Max<span class="op">(</span><span class="dv">10</span><span class="op">,</span> <span class="dv">8</span><span class="op">)</span> <span class="co">// 10</span></span></code></pre></div>
<p>Max is commutative; the order of its parameters does not matter. The maximum of eight and ten is ten regardless of if I compare eight and ten or ten and eight.</p>
<p>However, this property does not hold true for <code class="verbatim">CopyFile</code>.</p>
<div class="sourceCode" id="cb130"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>CopyFile<span class="op">(</span><span class="st">&quot;/tmp/backup&quot;</span><span class="op">,</span> <span class="st">&quot;presentation.md&quot;</span><span class="op">)</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>CopyFile<span class="op">(</span><span class="st">&quot;presentation.md&quot;</span><span class="op">,</span> <span class="st">&quot;/tmp/backup&quot;</span><span class="op">)</span></span></code></pre></div>
<p>Which one of these statements made a backup of your presentation and which one overwrite your presentation with last week’s version? You can’t tell without consulting the documentation. A code reviewer cannot know if you’ve got the order correct without consulting the documentation.</p>
<p>The general advice is to try to avoid this situation. Just like long parameter lists, indistinct parameter lists are a design smell.</p>
<p>However, a possible solution to this class of problem is to introduce a helper type which will be responsible for calling <code class="verbatim">CopyFile</code> correctly.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Source <span class="dt">string</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>src Source<span class="op">)</span> CopyTo<span class="op">(</span>dest <span class="dt">string</span><span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> CopyFile<span class="op">(</span>dest<span class="op">,</span> <span class="dt">string</span><span class="op">(</span>src<span class="op">))</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb131-7"><a href="#cb131-7" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb131-8"><a href="#cb131-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">var</span> from Source <span class="op">=</span> <span class="st">&quot;presentation.md&quot;</span></span>
<span id="cb131-9"><a href="#cb131-9" aria-hidden="true" tabindex="-1"></a> from<span class="op">.</span>CopyTo<span class="op">(</span><span class="st">&quot;/tmp/backup&quot;</span><span class="op">)</span></span>
<span id="cb131-10"><a href="#cb131-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In this way <code class="verbatim">CopyFile</code> is always called correctly and, given its poor API can possibly be made private, further reducing the likelihood of misuse.</p>
</section>
</section>
<section id="design-apis-for-their-default-use-case" class="level4" data-number="5.3.1.2">
<h4 data-number="5.3.1.2"><span class="header-section-number">5.3.1.2</span> Design APIs For Their Default Use Case</h4>
<p>Quite a few years ago now, <a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis">Dave Cheney gave a talk on using functional options</a> to make APIs easier to use for their default case.</p>
<p>The gist of this talk was you should design your APIs for the common, or default, use case. Said another way, your API should not require the caller to provide parameters which they don’t care about. More than being hard to use, you place the user in the position of guessing reasonable values. If they are lucky, the values they YOLO’d have no impact. That’s if they are lucky.</p>
<p>However! This isn't to say that every function should be designed this way. Rather, save this for functions that do have a lot of potential options that would otherwise require huge config structs or way too many arguments.</p>
<p>Typically, the functions that benefit from this the most are constructors or initializes. In other words, setup functions that you want to be able to call with anywhere from zero to many configuration options. These are functions used to do all the setup for something like an API or database client.</p>
<p>Remember though, the zero value of a struct should be usable!</p>
<p>As these types of functions tend to require a lot of extra code to get working, first consider a the following:</p>
<ul>
<li>would a small 4-6 field configuration struct be simpler?</li>
<li>how many of the options can't be used at the same time; would it make more sense to break this function up into smaller more purpose-driven functions?</li>
<li>can it wait until after the function is called?</li>
</ul>
<p>That last one is where you may usually find yourself; rather than a parameter in a function that 99% of callers pass the zero value, have a method on the type returned that handles the functionality needed by that 1% of the code.</p>
</section>
<section id="discourage-the-use-of-nil-as-a-valid-parameter-value" class="level4" data-number="5.3.1.3">
<h4 data-number="5.3.1.3"><span class="header-section-number">5.3.1.3</span> Discourage The Use Of <code class="verbatim">nil</code> As A Valid Parameter Value</h4>
<p>So this section opened with the suggestion that you shouldn’t force the caller of your API into providing you parameters when they don’t really care what those parameters mean. This is what we mean when we say you should design APIs for their default use case.</p>
<p>Note: Dave Cheney picks on the <code class="verbatim">net/http</code> package a lot. In his words:</p>
<blockquote>
<p>I don’t mean to imply it, or the engineers who contributed to it, are bad. On the contrary, <code class="verbatim">net/http</code> has been tremendously successful and with that success has come a process of extension via accretion which makes it a great candidate for case studies.</p>
</blockquote>
<p>Anyways, code!</p>
<div class="sourceCode" id="cb132"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> http</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ListenAndServe listens on the TCP network address addr and then calls</span></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Serve with handler to handle requests on incoming connections.</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Accepted connections are configured to enable TCP keep-alives.</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co">// The handler is typically nil, in which case the DefaultServeMux is used.</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ListenAndServe always returns a non-nil error.</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ListenAndServe<span class="op">(</span>addr <span class="dt">string</span><span class="op">,</span> handler Handler<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span></code></pre></div>
<p><code class="verbatim">ListenAndServe</code> takes two parameters, a TCP address to listen for incoming connections, and <code class="verbatim">http.Handler</code> to handle the incoming HTTP request. <code class="verbatim">Serve</code> allows the second parameter to be <code class="verbatim">nil</code>, and notes that usually the caller <em>will</em> pass <code class="verbatim">nil</code> indicating that they want to use <code class="verbatim">http.DefaultServeMux</code> as the implicit parameter.</p>
<p>Now the caller of Serve has this:</p>
<div class="sourceCode" id="cb133"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">)</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">)</span></span></code></pre></div>
<p>Both do exactly the same thing.</p>
<p>This <code class="verbatim">nil</code> behaviour is viral. The <code class="verbatim">http</code> package also has a <code class="verbatim">http.Serve</code> helper, which you can reasonably imagine that <code class="verbatim">ListenAndServe</code> builds upon like this</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ListenAndServe<span class="op">(</span>addr <span class="dt">string</span><span class="op">,</span> handler Handler<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a> l<span class="op">,</span> err <span class="op">:=</span> net<span class="op">.</span>Listen<span class="op">(</span><span class="st">&quot;tcp&quot;</span><span class="op">,</span> addr<span class="op">)</span></span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">defer</span> l<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> Serve<span class="op">(</span>l<span class="op">,</span> handler<span class="op">)</span></span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Because <code class="verbatim">ListenAndServe</code> permits the caller to pass <code class="verbatim">nil</code> for the second parameter, <code class="verbatim">http.Serve</code> also supports this behaviour. In fact, <code class="verbatim">http.Serve</code> is the one that implements the "if <code class="verbatim">handler</code> is <code class="verbatim">nil</code>, use <code class="verbatim">DefaultServeMux</code>" logic. Accepting <code class="verbatim">nil</code> for one parameter may lead the caller into thinking they can pass <code class="verbatim">nil</code> for both parameters. However calling Serve like this,</p>
<div class="sourceCode" id="cb135"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>Serve<span class="op">(</span><span class="ot">nil</span><span class="op">,</span> <span class="ot">nil</span><span class="op">)</span></span></code></pre></div>
<p>results in an ugly panic.</p>
<p>The author of <code class="verbatim">http.ListenAndServe</code> was trying to make the API user’s life easier in the common case, but possibly made the package harder to use safely.</p>
<p>There is no difference in line count between using <code class="verbatim">DefaultServeMux</code> explicitly, or implicitly via <code class="verbatim">nil</code>.</p>
<div class="sourceCode" id="cb136"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> root <span class="op">=</span> http<span class="op">.</span>Dir<span class="op">(</span><span class="st">&quot;/htdocs&quot;</span><span class="op">)</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>Handle<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> http<span class="op">.</span>FileServer<span class="op">(</span>root<span class="op">))</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> <span class="ot">nil</span><span class="op">)</span></span></code></pre></div>
<p>verses</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> root <span class="op">=</span> http<span class="op">.</span>Dir<span class="op">(</span><span class="st">&quot;/htdocs&quot;</span><span class="op">)</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>Handle<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> http<span class="op">.</span>FileServer<span class="op">(</span>root<span class="op">))</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> http<span class="op">.</span>DefaultServeMux<span class="op">)</span></span></code></pre></div>
<p>and a was this confusion really worth saving one line?</p>
<div class="sourceCode" id="cb138"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> root <span class="op">=</span> http<span class="op">.</span>Dir<span class="op">(</span><span class="st">&quot;/htdocs&quot;</span><span class="op">)</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>mux <span class="op">:=</span> http<span class="op">.</span>NewServeMux<span class="op">()</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>mux<span class="op">.</span>Handle<span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">,</span> http<span class="op">.</span>FileServer<span class="op">(</span>root<span class="op">))</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>http<span class="op">.</span>ListenAndServe<span class="op">(</span><span class="st">&quot;0.0.0.0:8080&quot;</span><span class="op">,</span> mux<span class="op">)</span></span></code></pre></div>
<p>Give serious consideration to how much time helper functions will save the programmer. Clear is better than concise.</p>
<p>Related to this guideline: avoid public APIs with test-only parameters. Avoid exposing APIs with values which only differ in test scope. Instead, use public wrappers to hide those parameters, use test scoped helpers to set the property in test scope.</p>
</section>
<section id="prefer-variable-arguments-to-t-parameters" class="level4" data-number="5.3.1.4">
<h4 data-number="5.3.1.4"><span class="header-section-number">5.3.1.4</span> Prefer Variable Arguments to <code class="verbatim">[]T</code> Parameters</h4>
<p>It’s very common to write a function or method that takes a slice of values.</p>
<div class="sourceCode" id="cb139"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ShutdownVMs<span class="op">(</span>ids <span class="op">[]</span><span class="dt">string</span><span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>This is just an example we just made up, but its common to a lot of code we've all worked on. The problem with signatures like these is they presume that they will be called with more than one entry. However, what often happens is that many times these type of functions are called with only one argument, which has to be "boxed" inside a slice just to meet the requirements of the functions signature.</p>
<p>Additionally, because the ids parameter is a slice, you can pass an empty slice or nil to the function and the compiler will be happy. This adds extra testing load because you should cover these cases in your testing.</p>
<p>To give an example of this class of API, Dave Cheney was refactoring a piece of logic that required him to set some extra fields if at least one of a set of parameters was non zero. The logic looked like this:</p>
<div class="sourceCode" id="cb140"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> svc<span class="op">.</span>MaxConnections <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> svc<span class="op">.</span>MaxPendingRequests <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> svc<span class="op">.</span>MaxRequests <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">||</span> svc<span class="op">.</span>MaxRetries <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a> <span class="co">// apply the non zero parameters</span></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>As the if statement was getting very long, he wanted to pull the logic of the check out into its own function. This is what he came up with:</p>
<div class="sourceCode" id="cb141"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">// anyPostive indicates if any value is greater than zero.</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> anyPositive<span class="op">(</span>values <span class="op">...</span><span class="dt">int</span><span class="op">)</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> v <span class="op">:=</span> <span class="kw">range</span> values <span class="op">{</span></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> v <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a>   <span class="kw">return</span> <span class="ot">true</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">false</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This enabled him to make the condition where the inner block will be executed clear to the reader:</p>
<div class="sourceCode" id="cb142"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> anyPositive<span class="op">(</span>svc<span class="op">.</span>MaxConnections<span class="op">,</span> svc<span class="op">.</span>MaxPendingRequests<span class="op">,</span> svc<span class="op">.</span>MaxRequests<span class="op">,</span> svc<span class="op">.</span>MaxRetries<span class="op">)</span> <span class="op">{</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>        <span class="co">// apply the non zero parameters</span></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>However there is a problem with <code class="verbatim">anyPositive</code>, someone could accidentally invoke it like this</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> anyPositive<span class="op">()</span> <span class="op">{</span> <span class="op">...</span> <span class="op">}</span></span></code></pre></div>
<p>In this case <code class="verbatim">anyPositive</code> would return false because it would execute zero iterations and immediately return false. This isn’t the worst thing in the world — that would be if <code class="verbatim">anyPositive</code> returned true when passed no arguments.</p>
<p>Nevertheless it would be be better if we could change the signature of <code class="verbatim">anyPositive</code> to enforce that the caller should pass at least one argument. We can do that by combining normal and vararg parameters like this:</p>
<div class="sourceCode" id="cb144"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co">// anyPostive indicates if any value is greater than zero.</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> anyPositive<span class="op">(</span>first <span class="dt">int</span><span class="op">,</span> rest <span class="op">...</span><span class="dt">int</span><span class="op">)</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a> <span class="kw">if</span> first <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="ot">true</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a> <span class="kw">for</span> _<span class="op">,</span> v <span class="op">:=</span> <span class="kw">range</span> rest <span class="op">{</span></span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> v <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>   <span class="kw">return</span> <span class="ot">true</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a> <span class="op">}</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a> <span class="kw">return</span> <span class="ot">false</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now <code class="verbatim">anyPositive</code> cannot be called with less than one argument.</p>
</section>
<section id="let-functions-define-the-behaviour-they-require" class="level4" data-number="5.3.1.5">
<h4 data-number="5.3.1.5"><span class="header-section-number">5.3.1.5</span> Let Functions Define The Behaviour They Require</h4>
<p>Let’s say you've been given a task to write a method that persists a Document structure to disk.</p>
<div class="sourceCode" id="cb145"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Document <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// mo&#39; state</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Save writes the contents of the Document to the file f.</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>d <span class="op">*</span>Document<span class="op">)</span> Save<span class="op">(</span>f <span class="op">*</span>os<span class="op">.</span>File<span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>You could specify this method, <code class="verbatim">Save</code>, which takes an <code class="verbatim">*os.File</code> as the destination to write the <code class="verbatim">Document</code>. But this has a few problems.</p>
<p>The signature of <code class="verbatim">Save</code> precludes the option to write the data to a network location. Assuming that in the new world of lambda functions and microservices, network storage is likely to become requirement, the signature of this function would have to change, impacting all its callers.</p>
<p><code class="verbatim">Save</code> is also unpleasant to test, because it operates directly with files on disk. To verify its operation the test would have to read the contents of the file after being written. You would also have to ensure that <code class="verbatim">f</code> was written to a temporary location and always removed afterwards.</p>
<p>Moreover <code class="verbatim">*os.File</code> defines a lot of methods which are not relevant to <code class="verbatim">Save</code>, like reading directories and checking to see if a path is a symlink. It would be useful if the signature of <code class="verbatim">Save</code> could describe only the parts of <code class="verbatim">*os.File</code> that were relevant.</p>
<div class="sourceCode" id="cb146"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Save writes the contents of d to the supplied ReadWriterCloser.</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>d <span class="op">*</span>Document<span class="op">)</span> Save<span class="op">(</span>rwc io<span class="op">.</span>ReadWriteCloser<span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>Using <code class="verbatim">io.ReadWriteCloser</code> we can apply the interface segregation principle to redefine <code class="verbatim">Save</code> to take an interface that describes more general file shaped things. With this change, any type that implements the <code class="verbatim">io.ReadWriteCloser</code> interface can be substituted for the previous <code class="verbatim">*os.File</code>. This makes <code class="verbatim">Save</code> both broader in its application, and clarifies to the caller of <code class="verbatim">Save</code> which methods of the <code class="verbatim">*os.File</code> type are relevant to its operation. As the author of <code class="verbatim">Save</code> I no longer have the option to call those unrelated methods on <code class="verbatim">*os.File</code> as it is hidden behind the <code class="verbatim">io.ReadWriteCloser</code> interface. But we can take the interface segregation principle a bit further.</p>
<p>Firstly, it is unlikely that if <code class="verbatim">Save</code> follows the single responsibility principle, it will read the file it just wrote to verify its contents—​that should be responsibility of another piece of code.</p>
<div class="sourceCode" id="cb147"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Save writes the contents of d to the supplied WriteCloser.</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>d <span class="op">*</span>Document<span class="op">)</span> Save<span class="op">(</span>wc io<span class="op">.</span>WriteCloser<span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>We can narrow the specification for the interface we pass to <code class="verbatim">Save</code> to just writing and closing.</p>
<p>Secondly, by providing <code class="verbatim">Save</code> with a mechanism to close its stream, which we inherited in this desire to make it still look like a file, this raises the question of under what circumstances will <code class="verbatim">wc</code> be closed. Possibly <code class="verbatim">Save</code> will call <code class="verbatim">Close</code> unconditionally, or perhaps <code class="verbatim">Close</code> will be called in the case of success. Neither of these is a good option. Unconditionally closing <code class="verbatim">wc</code> after the call to <code class="verbatim">Save</code> precludes the caller from writing additional data after the document is written. Conditionally closing the <code class="verbatim">WriteCloser</code>  —  it doesn’t matter if its on success, or failure—​means the caller must grow intricate knowledge of the operation of <code class="verbatim">Save</code>.</p>
<div class="sourceCode" id="cb148"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Save writes the contents of d to the supplied Writer.</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>d <span class="op">*</span>Document<span class="op">)</span> Save<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
<p>A better solution would be to redefine <code class="verbatim">Save</code> to take only an io.Writer, stripping it completely of the responsibility to do anything but write data to a stream.</p>
<p>By applying the interface segregation principle to our <code class="verbatim">Save</code> function, the results has simultaneously been a function which is the most specific in terms of its requirements—​it only needs a thing that is writable—​and the most general in its function, we can now use <code class="verbatim">Save</code> to save our data to anything which implements <code class="verbatim">io.Writer</code>.</p>
<p>As a side effect it is clear that the name of the method is no longer accurate. A better name may be</p>
<div class="sourceCode" id="cb149"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>d <span class="op">*</span>Document<span class="op">)</span> WriteTo<span class="op">(</span>w io<span class="op">.</span>Writer<span class="op">)</span> <span class="dt">error</span></span></code></pre></div>
</section>
<section id="export-as-little-as-possible" class="level4" data-number="5.3.1.6">
<h4 data-number="5.3.1.6"><span class="header-section-number">5.3.1.6</span> Export As Little As Possible</h4>
<blockquote>
<p>If you have a function which takes five parameters, you probably missed some.</p>
<p>— Alan Perlis</p>
</blockquote>
<p>In this document, we've presented many of the existing configuration patterns, those considered idiomatic and commonly in use today, and at every stage asked questions like:</p>
<ul>
<li>Can this be made simpler?</li>
<li>Is that parameter necessary?</li>
<li>Does the signature of this function make it easy for it to be used safely?</li>
<li>Does the API contain traps or confusing misdirection that will frustrate?</li>
</ul>
<p>Declarations provide the groundwork for a straightforward design, but it is the active elements of a Go program; the functions, the methods and it’s interfaces which bear the weight of the design of a Go program.</p>
<p>If a function is public and does not have anything to do with the package or uses none of the packages symbols, remove it. If it's used within the package, un-export the function – or better, move it to a package where it makes sense.</p>
</section>
<section id="dont-force-allocations-on-the-callers-of-your-api" class="level4" data-number="5.3.1.7">
<h4 data-number="5.3.1.7"><span class="header-section-number">5.3.1.7</span> Don't Force Allocations On The Callers Of Your API</h4>
<p>This section deals with performance. Most of the time when worrying about the performance of a piece of code the overwhelming advice should be (with apologies to Brendan Gregg) <em>don’t worry about it, yet</em>. However there is one area where I counsel developers to think about the performance implications of a design, and that is API design.</p>
<p>Because of the high cost of retrofitting a change to an API’s signature to address performance concerns, it’s worthwhile considering the performance implications of your API’s design on its caller.</p>
</section>
<section id="a-tale-of-two-api-designs" class="level4" data-number="5.3.1.8">
<h4 data-number="5.3.1.8"><span class="header-section-number">5.3.1.8</span> A Tale Of Two API designs</h4>
<p>Consider these two Read methods:</p>
<div class="sourceCode" id="cb150"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>r <span class="op">*</span>Reader<span class="op">)</span> Read<span class="op">(</span>buf <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span><span class="dt">int</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>r <span class="op">*</span>Reader<span class="op">)</span> Read<span class="op">()</span> <span class="op">([]</span><span class="dt">byte</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span></span></code></pre></div>
<p>The first method takes a <code class="verbatim">[]byte</code> buffer and returns the number of bytes read into that buffer and possibly an error that occurred while reading. The second takes no arguments and returns some data as a <code class="verbatim">[]byte</code> or an error.</p>
<p>This first method should be familiar to any Go programmer, it’s <code class="verbatim">io.Reader.Read</code>. As ubiquitous as <code class="verbatim">io.Reader</code> is, it’s not the most convenient API to use. Consider for a moment that <code class="verbatim">io.Reader</code> is the only Go interface in widespread use that returns <em>both</em> a result <em>and</em> an error.</p>
<p>Meditate on this for a moment.</p>
<p>The standard Go idiom, checking the error and if and only if it is <code class="verbatim">nil</code> is it safe to consult the other return values, does not apply to <code class="verbatim">Read</code>. In fact the caller must do the opposite. First they must record the number of bytes read into the buffer, reslice the buffer, process that data, and only then, consult the error. This is an unusual API for such a common operation and one that frequently catches out newcomers.</p>
<p>Is this a trap for new developers?</p>
<p>Why is it so? Why is one of the central APIs in Go's standard library written like this? A superficial answer might be <code class="verbatim">io.Reader</code>'s signature is a reflection of the underlying <a href="http://man7.org/linux/man-pages/man2/read.2.html">read(2)</a> syscall, which is indeed true, but misses the point of what we're trying to understand here.</p>
<p>If we compare the API of <code class="verbatim">io.Reader</code> to our alternative, <code class="verbatim">func Read() ([]byte,</code> <code class="verbatim">error)</code>, this API seems easier to use. Each call to <code class="verbatim">Read()</code> will return the data that was read, no need to reslice buffers, no need to remember the special case to do this before checking the error. Yet this is not the signature of <code class="verbatim">io.Reader.Read</code>. Why would one of Go’s most pervasive interfaces choose such an awkward API? The answer, we believe, lies in the performance implications of the APIs signature on the caller.</p>
<p>Consider again our alternative <code class="verbatim">Read</code> function, <code class="verbatim">func Read() ([]byte, error)</code>. On each call <code class="verbatim">Read</code> will read some data into a buffer and return the buffer to the caller. Where does this buffer come from? Who allocates it? The answer is the buffer is allocated inside <code class="verbatim">Read</code>. Therefore each call to <code class="verbatim">Read</code> is guaranteed to allocate a buffer which would escape to the heap. The more the program reads, the faster it reads data, the more streams of data it reads concurrently, the more pressure it places on the garbage collector.</p>
<p>The standard libraries’ <code class="verbatim">io.Reader.Read</code> forces the caller to supply a buffer because if the caller is concerned with the number of allocations their program is making this is precisely the kind of thing they want to control. Passing a buffer into <code class="verbatim">Read</code> puts the control of the allocations into the caller’s hands. If they aren’t concerned about allocations they can use higher level helpers like <a href="https://golang.org/pkg/io/ioutil/#ReadAll">ioutil.ReadAll</a> to read the contents into a <code class="verbatim">[]byte</code>, or <a href="https://golang.org/pkg/bufio/#Scanner">bufio.Scanner</a> to stream the contents instead.</p>
<p>The opposite, starting with a method like our alternative <code class="verbatim">func Read() ([]byte,</code> <code class="verbatim">error)</code> API, prevents callers from pooling or reusing allocations–no amount of helper methods can fix this. As an API author, if the API cannot be changed you’ll be forced to add a second form to your API taking a supplied buffer and reimplementing your original API in terms of the newer form. Consider, for example, <a href="https://golang.org/src/io/io.go?s=13136:13214#L378">io.CopyBuffer</a>. Other examples of retrofitting APIs for performance reasons are the fmt package and the <code class="verbatim">net/http</code> package which drove the introduction of the <code class="verbatim">sync.Pool</code> type precisely because the Go 1 guarantee prevented the APIs of those packages from changing.</p>
<p>If you want to commit to an API for the long run, consider how its design will impact the size and frequency of allocations the caller will have to make to use it.</p>
</section>
</section>
<section id="context" class="level3" data-number="5.3.2" id="6f31c55d-4d30-49f2-b311-52888942088e">
<h3 data-number="5.3.2" id="6f31c55d-4d30-49f2-b311-52888942088e"><span class="header-section-number">5.3.2</span> Context</h3>
<p>One of the packages everybody learns about really early on in Go is the <code class="verbatim">context</code> package and it's main star: <code class="verbatim">context.Context</code>. However, it's also kind of an odd duck when you take a closer look at it. It's also one of the first implementation details that you should consider as you design your API.</p>
<p>As of right now the <code class="verbatim">context</code> package does three things:</p>
<ul>
<li>Cancellation via <code class="verbatim">context.WithCancel</code></li>
<li>Timeout via <code class="verbatim">context.WithDeadline</code> or <code class="verbatim">context.WithTimeout</code></li>
<li>A bag of values via <code class="verbatim">context.WithValue</code></li>
</ul>
<p>All three of these things are useful on their own, but why do we have three different types of things in a single package?</p>
<p>We don't know the full story behind how <code class="verbatim">context</code> ended up this way, but the reason we still have this strange package is the Go 1 API compatibility guarantee. If you're not familiar, it's basically this sentence from the <a href="https://go.dev/doc/go1compat">Go 1 compatibility guarantee</a>:</p>
<blockquote>
<p>It is intended that programs written to the Go 1 specification will continue to compile and run correctly, unchanged, over the lifetime of that specification.</p>
</blockquote>
<p>Basically, outside of some very specific circumstances detailed on that compatibility page, we're stuck with the <code class="verbatim">context</code> package as it is today. And that's not the worst thing in the world, either! What it does mean though, is that for some packages from the standard library we need to have not only a better understanding of how they work, but also a clear understanding on the best practices around using them.</p>
<p>A good example of this is the <code class="verbatim">sync.WaitGroup</code> struct. Because Go passes by value ( via copy ), you can't pass a non-pointer <code class="verbatim">sync.WaitGroup</code> into a function; it has to be a pointer otherwise it won't work – and you'll be left with a program that hangs forever because you copied a mutex and can't unlock.</p>
<p>So why is the context package one of these? Well, it has some gotchas that have to be made clear before you really understand how to use it. Go has <em>fewer</em> <a href="https://news.ycombinator.com/item?id=17393292">footguns</a> than say, C++ – but it still has a few laying about.</p>
<p>Let's dive into what <code class="verbatim">context.Context</code> can be used for then, and see how to best make use of this strange little duck.</p>
<p>The best place to start is probably by taking a step back and taking a look at the interface defined for us by the <code class="verbatim">context</code> package:</p>
<div class="sourceCode" id="cb151"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Context <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a>  Deadline<span class="op">()</span> <span class="op">(</span>deadline time<span class="op">.</span>Time<span class="op">,</span> ok <span class="dt">bool</span><span class="op">)</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a>  Done<span class="op">()</span> <span class="op">&lt;-</span><span class="kw">chan</span> <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a>  Err<span class="op">()</span> <span class="dt">error</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a>  Value<span class="op">(</span>key any<span class="op">)</span> any</span>
<span id="cb151-6"><a href="#cb151-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So we've got a nice handy little interface here. What can we do with it?</p>
<p>Well, <code class="verbatim">Deadline()</code> will let us know if there is a deadline at all, <code class="verbatim">ok</code> will be <code class="verbatim">false</code> if there's no deadline – or when the deadline <em>is</em>.</p>
<p><code class="verbatim">Done</code> returns a channel that's closed when the work being done on behalf of this context should be canceled/finished.</p>
<p><code class="verbatim">Err()</code> returns an error if the context has been canceled or the deadline has been exceeded.</p>
<p>And <code class="verbatim">Value(any)</code> returns <code class="verbatim">any</code> – which can be nil if no matching key was found.</p>
<p>Handy, right?</p>
<p>So what should we be watching out for?</p>
<section id="grab-bag-of-values" class="level4" data-number="5.3.2.1">
<h4 data-number="5.3.2.1"><span class="header-section-number">5.3.2.1</span> Grab Bag Of Values</h4>
<p>The very first thing that you should drill into your brain is this: <code class="verbatim">context.Context</code> should <strong>only ever hold request-local values</strong>. Don't put in stuff like loggers, database clients, API clients, or anything else that needs to be shared across requests.</p>
<p>I'd even take it a bit further than others might, and say that you should only store the following in a <code class="verbatim">context.Context</code> using <code class="verbatim">context.WithValue</code>:</p>
<ul>
<li><code class="verbatim">int</code> values</li>
<li><code class="verbatim">float</code> values</li>
<li><code class="verbatim">string</code> values</li>
<li><code class="verbatim">map[string]string</code> values</li>
<li><code class="verbatim">map[string]any</code> values</li>
</ul>
<p>This list is less about type safety, and more about trying to prevent a <code class="verbatim">context.Context</code> from getting too bloated by saying "put whatever you want in it!". You can put other things into a <code class="verbatim">context.Context</code>, but if you try and stick to only the types above you'll probably encounter fewer problems overall.</p>
<section id="contexts-and-keys" class="level5" data-number="5.3.2.1.1">
<h5 data-number="5.3.2.1.1"><span class="header-section-number">5.3.2.1.1</span> Contexts And Keys</h5>
<p>So what about the keys? You can use any type you want, as the key is type <code class="verbatim">any</code>. But what types are better – or rather, what types should you prefer?</p>
<p>If you look around, some of the most common types you'll see are <code class="verbatim">string</code> and <code class="verbatim">int</code> keys. Or rather, custom types based on <code class="verbatim">string</code> or <code class="verbatim">int</code>:</p>
<div class="sourceCode" id="cb152"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> keyForMetadata <span class="dt">string</span> <span class="op">=</span> <span class="st">&quot;boop&quot;</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="co">// later, in side a function within the package:</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">:=</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> keyForMeatadata<span class="op">,</span> metadata<span class="op">)</span></span></code></pre></div>
<p>Let's first take a look at what this example is doing <em>right</em>. Right off the bat, using a constant is a good idea, because then you don't have to worry about some piece of code changing the key in-between when you set a value and when you later wish to fetch it. Additionally, by using an unexported value, it means that users can't use the key to get the value when we don't want.</p>
<p>Right?</p>
<div class="sourceCode" id="cb153"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ex/ex.go</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> ex</span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="st">&quot;context&quot;</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> key <span class="dt">string</span> <span class="op">=</span> <span class="st">&quot;what&quot;</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> PutIntoCtx<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> context<span class="op">.</span>Context <span class="op">{</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> key<span class="op">,</span> <span class="st">&quot;some value&quot;</span><span class="op">)</span></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a><span class="co">// main.go</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;context&quot;</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;fmt&quot;</span></span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;github.com/seanhagen/playground/ex&quot;</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-22"><a href="#cb153-22" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb153-23"><a href="#cb153-23" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">:=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb153-24"><a href="#cb153-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-25"><a href="#cb153-25" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">=</span> ex<span class="op">.</span>PutIntoCtx<span class="op">(</span>ctx<span class="op">)</span></span>
<span id="cb153-26"><a href="#cb153-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-27"><a href="#cb153-27" aria-hidden="true" tabindex="-1"></a>  out <span class="op">:=</span> ctx<span class="op">.</span>Value<span class="op">(</span><span class="st">&quot;what&quot;</span><span class="op">)</span></span>
<span id="cb153-28"><a href="#cb153-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-29"><a href="#cb153-29" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;got: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> out<span class="op">)</span></span>
<span id="cb153-30"><a href="#cb153-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This prints out <code class="verbatim">got: some value</code> – probably not what the package author intended, right? If the data stored in that key is not meant to change, allowing users to get their hands on it is not great.</p>
<p>So how do we fix this?</p>
<p>Well, the simplest way is to make this change to <code class="verbatim">ex/ex.go</code>:</p>
<div class="sourceCode" id="cb154"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ctxkey <span class="dt">string</span> </span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> key ctxkey <span class="op">=</span> <span class="st">&quot;what&quot;</span></span></code></pre></div>
<p>Because checking equality on <code class="verbatim">any</code> requires checking the <em>type</em> as well as the value we don't have to worry about users getting to our data.</p>
<p>Is there anything we could do to make this better?</p>
<p>Yup!</p>
<div class="sourceCode" id="cb155"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ctxkey <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> key <span class="op">=</span> ctxkey<span class="op">{}</span></span></code></pre></div>
<p>This is useful for at least two reasons.</p>
<p>One is that if you forget to use <code class="verbatim">key</code> and instead put <code class="verbatim">ctxkey{}</code> everything still works; <code>ctxkey{} == ctxkey{}</code> is true. That's pretty great; it means we could probably even just get rid of the <code>var key = ctxkey{}</code>.</p>
<p>The other is that standardizing on <code class="verbatim">struct{}</code> as the type used for context keys means one less potential allocation to worry about! This is one of those things that isn't a big deal until it is; sticking with <code class="verbatim">struct{}</code> may or may not save you some pain down the road.</p>
<p>However, as "use <code class="verbatim">struct{}</code> for context keys" is pretty easy to remember, we think it's a good practice for us to put in place.</p>
</section>
<section id="when-to-put-something-in-a-context" class="level5" data-number="5.3.2.1.2">
<h5 data-number="5.3.2.1.2"><span class="header-section-number">5.3.2.1.2</span> When To Put Something In A Context</h5>
<p>So now that we've covered how to put stuff in a context, and what type to use for the keys, let's talk about <em>when</em> and <em>why</em> to put stuff <strong>into</strong> a <code class="verbatim">context.Context</code>.</p>
<p>As the most common use of contexts is withing handlers for HTTP ( or GRPC ) requests, that's what we'll be talking about for the most part. There are some other use-cases, but this document is already huge and you probably won't encounter those cases very often.</p>
<p>Let's think about some things that you might put into a <code class="verbatim">context.Context</code> that you want to be able to pull out at any point during the request. Stuff like:</p>
<ul>
<li>request ID</li>
<li>trace or span ID</li>
<li>user ID, and maybe one or two other user details</li>
<li><em>maybe</em>, <strong>maybe</strong>, MAYBE….. maybe some request parameters?</li>
</ul>
<p>Those seem pretty reasonable – but why the hesitation around request parameters? Well, it has to do with how contexts work.</p>
<p>If you were asked to guess how the unexported concrete type or types that fulfill the <code class="verbatim">context.Context</code> interface work, what would you say?</p>
<p>A good first guess is there's an unexported struct, with unexported fields, that does all the work of managing timeouts or deadlines. There's something to manage the channel for the <code class="verbatim">Done()</code> method. Some code for setting an <code class="verbatim">error</code> value on an internal field when the context is canceled or times out that gets returned by <code class="verbatim">Err()</code>. Lastly, some kind of map or other data store for the values added by <code class="verbatim">WithValue</code>.</p>
<p>If you guessed that, you'd be as wrong as one of the authors of this was!</p>
<div class="NOTE">
<p>It was Hagen.</p>
</div>
<p>Turns out, each <code class="verbatim">WithDeadline</code>, <code class="verbatim">WithTimeout</code>, <code class="verbatim">WithCancel</code>, and <code class="verbatim">WithValue</code> call pushes the new context onto the head of a linked list, and returns the head.</p>
<p>Now, you should never ever <strong>ever</strong> store this many values shoved into a context, but here's an example to show why keeping the number of values you put into a context low is a good idea:</p>
<div class="sourceCode" id="cb156"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;context&quot;</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;fmt&quot;</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;time&quot;</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;github.com/davecgh/go-spew/spew&quot;</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">:=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">=</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> <span class="st">&quot;what&quot;</span><span class="op">,</span> <span class="st">&quot;boop&quot;</span><span class="op">)</span></span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> 1_000_000<span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>    ctx <span class="op">=</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> fmt<span class="op">.</span>Sprintf<span class="op">(</span><span class="st">&quot;key %v&quot;</span><span class="op">,</span> i<span class="op">),</span> i<span class="op">*</span>i<span class="op">)</span></span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a>  now <span class="op">:=</span> time<span class="op">.</span>Now<span class="op">()</span></span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  v <span class="op">:=</span> ctx<span class="op">.</span>Value<span class="op">(</span><span class="st">&quot;what&quot;</span><span class="op">)</span></span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>  diff <span class="op">:=</span> time<span class="op">.</span>Now<span class="op">().</span>Sub<span class="op">(</span>now<span class="op">)</span></span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;took: %v</span><span class="ch">\n</span><span class="st">got: %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> diff<span class="op">,</span> v<span class="op">)</span></span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This is what gets printed out:</p>
<pre><code>took: 86.201678ms
got: boop
</code></pre>
<p>Ouch.</p>
<p>We should never end up in a position where we need to put that much stuff into a context, but it's good to keep the fact that <code class="verbatim">context.Context</code> is really a linked list in your head. Add to the fact that the context you get from a <code class="verbatim">*http.Request</code> ( or passed into your GRPC handler ) may already have a bunch of nodes in the list, and you should be starting to see why we advise against putting too much into a context with <code class="verbatim">context.WithValue</code>.</p>
<p>This is also why we advocate using a <code class="verbatim">map[string]string</code> if you want to put multiple values at once into a context.</p>
<p>All that was basically a long-winded way to say: try to store as little as possible in the request <code class="verbatim">context.Context</code>.</p>
<p>What's a good rule of thumb?</p>
<p>For now, you should only store values in a context inside of middleware. In other words, never store values inside a context inside your handler. Additionally, don't ever call <code class="verbatim">Value</code> yourself in your handler – there should be a helper function that gets the value out of the context and does the nil &amp; type check for you.</p>
</section>
<section id="how-to-put-something-in-a-context" class="level5" data-number="5.3.2.1.3">
<h5 data-number="5.3.2.1.3"><span class="header-section-number">5.3.2.1.3</span> How To Put Something In A Context</h5>
<p>Okay, so we've established the following:</p>
<ul>
<li>use <code class="verbatim">struct{}</code> for context keys</li>
<li>store basic types, <code class="verbatim">map[string]string</code>, or <code class="verbatim">map[string]any</code></li>
<li>store as little as you can get away with</li>
</ul>
<p>Now let's talk about <em>how</em> to store something in a context.</p>
<p>This is not how:</p>
<div class="sourceCode" id="cb158"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">=</span> context<span class="op">.</span>WithValue<span class="op">(</span>r<span class="op">.</span>Context<span class="op">(),</span> requests<span class="op">.</span>CtxKey<span class="op">,</span> requests<span class="op">.</span>GenerateID<span class="op">(</span>r<span class="op">))</span></span></code></pre></div>
<p>How can we tell – from one line of code – that this isn't the right way?</p>
<p>Because we have to use two exported values from the <code class="verbatim">requests</code> package to set the value. We've already spoken about exporting as little as possible and why that's important. Another thing to consider is that by exporting the key and a method to generate a request ID, we're leaving the actual <em>implementation</em> of <em>putting</em> <em>the ID into the context</em> up to the user.</p>
<p>So let's think about <em>how</em> we can put stuff into a context while still following all the guidelines we've established so far.</p>
<p>Right off the bat we know that we don't want to export the context key, constant or not. In most cases I'd argue users don't need to know the specifics of getting a value out of a context – they just want the value. And that's just in the cases where they actually want the value, and not because they need the value to do something else our package should be handling.</p>
<p>Rather than pontificate, let's look at an example: request ID!</p>
<p>Let's say there was a requirement that all our logs contain a 'request-id' field ( we're using structured logging in this example ).</p>
<p>If you're using a structured logging library like <a href="https://pkg.go.dev/go.uber.org/zap">zap</a> your first thought might be to use something like <code class="verbatim">With(...zap.Field)</code>:</p>
<div class="sourceCode" id="cb159"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a>requestLogger <span class="op">:=</span> zap<span class="op">.</span>With<span class="op">(</span>zap<span class="op">.</span>String<span class="op">(</span><span class="st">&quot;request-id&quot;</span><span class="op">,</span> requests<span class="op">.</span>GenerateID<span class="op">(</span>r<span class="op">)))</span></span></code></pre></div>
<p>If your next thought is to do this:</p>
<div class="sourceCode" id="cb160"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">=</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> requests<span class="op">.</span>LoggerCtxKey<span class="op">,</span> requestLogger<span class="op">)</span></span></code></pre></div>
<p>Then you need to re-read the entire <a href="#6f31c55d-4d30-49f2-b311-52888942088e">Context</a> section.</p>
<p>What else could we do? Well we could pass the logger down into any function that might need to write something to the logs. That's fine if you are A) creating the logger in your handler and not middleware, and B) your handler doesn't call many functions.</p>
<p>If you can get away with every handler not ever needing to pass the logger down then huzzah! However, as I'd argue that generating the request ID should in middleware and not your handler, that's no good. So that's both points A &amp; B shot down, so passing the logger down into each function is not a great solution.</p>
<p>What if inverted things a bit? Let's look at two alternate solutions.</p>
<p>However, both start in the same place:</p>
<div class="sourceCode" id="cb161"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> request</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> requestIdKey <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> IdInCtx<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> context<span class="op">.</span>Context <span class="op">{</span></span>
<span id="cb161-6"><a href="#cb161-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> requestIdKey<span class="op">{},</span> generateID<span class="op">(</span>r<span class="op">))</span></span>
<span id="cb161-7"><a href="#cb161-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>From our middleware or handler this is called as <code class="verbatim">request.IdInCtx(ctx, r)</code>, so that's nice. Also, our context key is a <code class="verbatim">struct{}</code> and un-exported, also good. Lastly, all the implementation details stay inside the <code class="verbatim">request</code> package – the key, as well as function for generating the request ID are all un-exported.</p>
<p>So how do we <em>use</em> the request ID?</p>
<p>Well, for our logging example there are two potential ways. Here's the first:</p>
<div class="sourceCode" id="cb162"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> request</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> RequestLogger <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>  Info<span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="op">...</span>any<span class="op">)</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>  With<span class="op">(</span>args <span class="op">...</span>any<span class="op">)</span> RequestLogger</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> Logger<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> log RequestLogger<span class="op">)</span> <span class="op">(</span>RequestLogger<span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>  v <span class="op">:=</span> ctx<span class="op">.</span>Value<span class="op">(</span>requestIdKey<span class="op">)</span></span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> v <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb162-11"><a href="#cb162-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="ot">nil</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;no request ID in context&quot;</span><span class="op">)</span></span>
<span id="cb162-12"><a href="#cb162-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb162-13"><a href="#cb162-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-14"><a href="#cb162-14" aria-hidden="true" tabindex="-1"></a>  id<span class="op">,</span> ok <span class="op">:=</span> v<span class="op">.(</span>requestID<span class="op">)</span></span>
<span id="cb162-15"><a href="#cb162-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="op">!</span>ok <span class="op">{</span></span>
<span id="cb162-16"><a href="#cb162-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="ot">nil</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;invalid type stored in context&quot;</span><span class="op">)</span></span>
<span id="cb162-17"><a href="#cb162-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb162-18"><a href="#cb162-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-19"><a href="#cb162-19" aria-hidden="true" tabindex="-1"></a>  nl <span class="op">:=</span> log<span class="op">.</span>With<span class="op">(</span><span class="st">&quot;request-id&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb162-20"><a href="#cb162-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb162-21"><a href="#cb162-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-22"><a href="#cb162-22" aria-hidden="true" tabindex="-1"></a><span class="co">// in some function somewhere</span></span>
<span id="cb162-23"><a href="#cb162-23" aria-hidden="true" tabindex="-1"></a>l <span class="op">:=</span> request<span class="op">.</span>Logger<span class="op">(</span>ctx<span class="op">,</span> zap<span class="op">.</span>L<span class="op">())</span></span>
<span id="cb162-24"><a href="#cb162-24" aria-hidden="true" tabindex="-1"></a>l<span class="op">.</span>Info<span class="op">(</span><span class="st">&quot;did thing to foobar&quot;</span><span class="op">)</span></span></code></pre></div>
<p>You've probably noticed already that this doesn't work, <code class="verbatim">zap.L().Info</code> has a signature of <code class="verbatim">(string, ...zap.Field)</code>, which we don't have in our interface. We don't want to put <code class="verbatim">zap.Field</code> in the interface, as that's way too specific.</p>
<p>But we want some kind of interface, right? We don't want our <code class="verbatim">request</code> package to know or care <em>what</em> logging library we use, it just wants to add a field.</p>
<p>What if we change it up to this:</p>
<div class="sourceCode" id="cb163"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> request</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> AddFieldToLoggerFn <span class="kw">func</span><span class="op">(</span>key<span class="op">,</span> value <span class="dt">string</span><span class="op">)</span></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> AddIDToLogger<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> fn AddFieldToLoggerFn<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>  v <span class="op">:=</span> ctx<span class="op">.</span>Value<span class="op">(</span>requestIdKey<span class="op">)</span></span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> v <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;no request ID in context&quot;</span><span class="op">)</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-11"><a href="#cb163-11" aria-hidden="true" tabindex="-1"></a>  id<span class="op">,</span> ok <span class="op">:=</span> v<span class="op">.(</span>requestID<span class="op">)</span></span>
<span id="cb163-12"><a href="#cb163-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="op">!</span>ok <span class="op">{</span></span>
<span id="cb163-13"><a href="#cb163-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;invalid type stored in context&quot;</span><span class="op">)</span></span>
<span id="cb163-14"><a href="#cb163-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb163-15"><a href="#cb163-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-16"><a href="#cb163-16" aria-hidden="true" tabindex="-1"></a>  fn<span class="op">(</span><span class="st">&quot;request-id&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb163-17"><a href="#cb163-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-18"><a href="#cb163-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> <span class="ot">nil</span></span>
<span id="cb163-19"><a href="#cb163-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Better, but still not great. How do we ensure that the user uses <code class="verbatim">key</code> and <code class="verbatim">value</code> in the function properly? Well, we can't. Still, better than the interface version, right?</p>
<p>However, before we go further down this road, let's take a step back – maybe we need to think to our foundations; maybe there's something in the SOLID principles that will guide us.</p>
<p>Turns out, there is! Fancy that.</p>
<p>In this case, it's the Single Responsibility Principle.</p>
<p>Think about what it is we're trying to do here: we want to have the <code class="verbatim">request-id</code> included as a field in every log message generated inside a handler. So far, the way we've been going about this is to add more to our <code class="verbatim">request</code> package – specifically, trying to get it to be able to add a field to a logger without knowing too much about the logger.</p>
<p>We haven't looked at the rest of the requests package, but adding "know how to add a field to a structured logger" doesn't really <em>feel</em> like it belongs in a <code class="verbatim">request</code> package. It actually feels like "add a field to a structured logger" belongs inside the handler; it is probably adding other fields like user ids, or even trace &amp; span ids.</p>
<p>So with that in mind, let's try something else instead.</p>
<div class="sourceCode" id="cb164"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> foobar</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> <span class="op">(</span></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>  invalidRequestID RequestID <span class="op">=</span> <span class="st">&quot;invalid-ctx-no-request-id&quot;</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>  requestIDKey     <span class="dt">string</span>    <span class="op">=</span> <span class="st">&quot;request-id&quot;</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="co">// AddRequestIdTo is passed into RequestID.WithRequestID so that</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="co">// the key and ID can be used to annotate whatever is required; adding</span></span>
<span id="cb164-10"><a href="#cb164-10" aria-hidden="true" tabindex="-1"></a><span class="co">// a field to a structured log, or an error, or whatever you want.</span></span>
<span id="cb164-11"><a href="#cb164-11" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> AddRequestIdTo <span class="kw">func</span><span class="op">(</span>key <span class="dt">string</span><span class="op">,</span> id RequestID<span class="op">)</span></span>
<span id="cb164-12"><a href="#cb164-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-13"><a href="#cb164-13" aria-hidden="true" tabindex="-1"></a><span class="co">// RequestID is the custom type for our request ID so we can</span></span>
<span id="cb164-14"><a href="#cb164-14" aria-hidden="true" tabindex="-1"></a><span class="co">// hang some handy methods off it.</span></span>
<span id="cb164-15"><a href="#cb164-15" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> RequestID <span class="dt">string</span></span>
<span id="cb164-16"><a href="#cb164-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-17"><a href="#cb164-17" aria-hidden="true" tabindex="-1"></a><span class="co">// WithRequestID uses the function to pass in the proper key for</span></span>
<span id="cb164-18"><a href="#cb164-18" aria-hidden="true" tabindex="-1"></a><span class="co">// request IDs, along with the current request ID.</span></span>
<span id="cb164-19"><a href="#cb164-19" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>rid RequestID<span class="op">)</span> WithRequestID<span class="op">(</span>fn AddRequestIdTo<span class="op">)</span> <span class="op">{</span></span>
<span id="cb164-20"><a href="#cb164-20" aria-hidden="true" tabindex="-1"></a>  fn<span class="op">(</span>requestIDKey<span class="op">,</span> rid<span class="op">)</span></span>
<span id="cb164-21"><a href="#cb164-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb164-22"><a href="#cb164-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-23"><a href="#cb164-23" aria-hidden="true" tabindex="-1"></a><span class="co">// InCtx puts the request ID into the context, creating a new</span></span>
<span id="cb164-24"><a href="#cb164-24" aria-hidden="true" tabindex="-1"></a><span class="co">// context if passed a nil context.</span></span>
<span id="cb164-25"><a href="#cb164-25" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>rid RequestID<span class="op">)</span> InCtx<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> context<span class="op">.</span>Context <span class="op">{</span></span>
<span id="cb164-26"><a href="#cb164-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> ctx <span class="op">==</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb164-27"><a href="#cb164-27" aria-hidden="true" tabindex="-1"></a>    ctx <span class="op">=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb164-28"><a href="#cb164-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb164-29"><a href="#cb164-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> context<span class="op">.</span>WithValue<span class="op">(</span>ctx<span class="op">,</span> reqCtx<span class="op">,</span> rid<span class="op">)</span></span>
<span id="cb164-30"><a href="#cb164-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb164-31"><a href="#cb164-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-32"><a href="#cb164-32" aria-hidden="true" tabindex="-1"></a><span class="co">// our struct context key type</span></span>
<span id="cb164-33"><a href="#cb164-33" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> contextKeyType <span class="kw">struct</span><span class="op">{}</span></span>
<span id="cb164-34"><a href="#cb164-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-35"><a href="#cb164-35" aria-hidden="true" tabindex="-1"></a><span class="co">// our context key for storing/fetching the request ID</span></span>
<span id="cb164-36"><a href="#cb164-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> reqCtx <span class="op">=</span> contextKeyType<span class="op">{}</span></span>
<span id="cb164-37"><a href="#cb164-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-38"><a href="#cb164-38" aria-hidden="true" tabindex="-1"></a><span class="co">// RequestIdFromCtx returns either the request ID that was stored</span></span>
<span id="cb164-39"><a href="#cb164-39" aria-hidden="true" tabindex="-1"></a><span class="co">// in the context previously, or an &#39;invalid&#39; request ID</span></span>
<span id="cb164-40"><a href="#cb164-40" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> RequestIdFromCtx<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">)</span> RequestID <span class="op">{</span></span>
<span id="cb164-41"><a href="#cb164-41" aria-hidden="true" tabindex="-1"></a>  v <span class="op">:=</span> ctx<span class="op">.</span>Value<span class="op">(</span>reqCtx<span class="op">)</span></span>
<span id="cb164-42"><a href="#cb164-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-43"><a href="#cb164-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> id<span class="op">,</span> ok <span class="op">:=</span> v<span class="op">.(</span>RequestID<span class="op">);</span> ok <span class="op">{</span></span>
<span id="cb164-44"><a href="#cb164-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> id</span>
<span id="cb164-45"><a href="#cb164-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb164-46"><a href="#cb164-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-47"><a href="#cb164-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> invalidRequestID</span>
<span id="cb164-48"><a href="#cb164-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Hey hey! This is looking pretty handy. The only thing left to figure out is if we want to define our own middleware so we don't have to expose <code class="verbatim">generateID</code>, or just expose <code class="verbatim">generateID</code> so we don't have to build some middleware.</p>
<p>The quicker option is to export <code class="verbatim">generateID</code>, the safer option is to build some middleware. Or at least, so long as generating the ID is a separate step. Can we update <code class="verbatim">generateID</code> so that we can make things simpler?</p>
<div class="sourceCode" id="cb165"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> GenerateID<span class="op">(</span>req <span class="op">*</span>http<span class="op">.</span>Request<span class="op">)</span> <span class="op">(</span>context<span class="op">.</span>Context<span class="op">,</span> RequestID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb165-2"><a href="#cb165-2" aria-hidden="true" tabindex="-1"></a>  id <span class="op">:=</span> buildIDFromHttpRequest<span class="op">(</span>req<span class="op">)</span></span>
<span id="cb165-3"><a href="#cb165-3" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">:=</span> id<span class="op">.</span>InCtx<span class="op">(</span>req<span class="op">.</span>Context<span class="op">())</span></span>
<span id="cb165-4"><a href="#cb165-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> ctx<span class="op">,</span> id</span>
<span id="cb165-5"><a href="#cb165-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>🎉 Huzzah! 🎉</p>
<p>We've now got a method we can use in middleware that properly sets up both the context and the request ID, and returns both.</p>
<p>We've got a function that lets you get the request ID out of the context.</p>
<p>We've got a method on the request ID type that allows anybody to use the request ID to annotate a logger.</p>
<p>Doing it this way has another additional benefit, though: we now have a defined way to annotate <em>anything</em> with a request ID.</p>
<p>Want to annotate an outgoing request with the ID?</p>
<div class="sourceCode" id="cb166"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb166-1"><a href="#cb166-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">:=</span> http<span class="op">.</span>NewRequest<span class="op">(</span>http<span class="op">.</span>MethodPost<span class="op">,</span> <span class="st">&quot;http://example.com/an/api/route&quot;</span><span class="op">,</span> http<span class="op">.</span>NoBody<span class="op">)</span></span>
<span id="cb166-2"><a href="#cb166-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb166-3"><a href="#cb166-3" aria-hidden="true" tabindex="-1"></a>id<span class="op">.</span>WithRequestID<span class="op">(</span><span class="kw">func</span><span class="op">(</span>key <span class="dt">string</span><span class="op">,</span> id RequestID<span class="op">)</span> <span class="op">{</span></span>
<span id="cb166-4"><a href="#cb166-4" aria-hidden="true" tabindex="-1"></a>  r<span class="op">.</span>Header<span class="op">.</span>Add<span class="op">(</span>key<span class="op">,</span> <span class="dt">string</span><span class="op">(</span>id<span class="op">))</span></span>
<span id="cb166-5"><a href="#cb166-5" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p>Now we've got a function that can pull the request ID out of a context for when:</p>
<ul>
<li>we're reporting an error to an external service</li>
<li>we're sending an event to a service like Mixpanel</li>
<li>we're annotating a trace with request info</li>
<li>we're adding some values to a header before returning from middleware</li>
</ul>
<p>Oh, and we can use it when writing a log, of course.</p>
<p>So by focusing on the behaviour, we found our way to a solution that can be used for lots of stuff, not just getting a request logger.</p>
</section>
</section>
<section id="to-cancel-or-not-to-cancel" class="level4" data-number="5.3.2.2">
<h4 data-number="5.3.2.2"><span class="header-section-number">5.3.2.2</span> To Cancel, Or Not To Cancel</h4>
<p>Now let's talk about the other use of contexts: cancellation.</p>
<p>A good place to start is this: why do we even care about being able to cancel something before it's finished?</p>
<p>For folks coming from languages like Ruby, the idea of something like being able to cancel a function from running might sound a bit odd. However, even if you're brand-new to Go, you've probably heard about <a href="https://golangbot.com/goroutines/">goroutines</a> and how goroutines are key to Go's magical "easy concurrency". All this hullabaloo about cancellation has to do with the fact that goroutines need some way to be told "hey, I need to you stop doing what you're doing and exit promptly".</p>
<p>Folks coming from languages with threads ( or some equivalent ) probably wonder why we can't just stop or kill goroutines directly, via a handle or some built-in thread management functions. Unfortunately, unlike threads, goroutines are a "launch and forget" kind of thing. The only way you have to tell a goroutine to stop without also killing your entire program is through a context ( or a channel, but we're not going over those right now ).</p>
<p>We went over this in the concurrency section but it's worth stating again: DO NOT launch a goroutine without having some way of telling the goroutine to stop.</p>
<p>So we're all on the same page, here's what launching a goroutine looks like:</p>
<div class="sourceCode" id="cb167"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> boop<span class="op">()</span> <span class="op">{</span></span>
<span id="cb167-2"><a href="#cb167-2" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;-</span>time<span class="op">.</span>After<span class="op">(</span>time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb167-3"><a href="#cb167-3" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;boop!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb167-4"><a href="#cb167-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb167-5"><a href="#cb167-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-6"><a href="#cb167-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb167-7"><a href="#cb167-7" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Launching goroutine!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb167-8"><a href="#cb167-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">go</span> boop<span class="op">()</span></span>
<span id="cb167-9"><a href="#cb167-9" aria-hidden="true" tabindex="-1"></a>  time<span class="op">.</span>Sleep<span class="op">(</span>time<span class="op">.</span>Millisecond <span class="op">*</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb167-10"><a href="#cb167-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-11"><a href="#cb167-11" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Launching another goroutine!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb167-12"><a href="#cb167-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">go</span> boop<span class="op">()</span></span>
<span id="cb167-13"><a href="#cb167-13" aria-hidden="true" tabindex="-1"></a>  time<span class="op">.</span>Sleep<span class="op">(</span>time<span class="op">.</span>Millisecond <span class="op">*</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb167-14"><a href="#cb167-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb167-15"><a href="#cb167-15" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Launching one last goroutine!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb167-16"><a href="#cb167-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">go</span> boop<span class="op">()</span></span>
<span id="cb167-17"><a href="#cb167-17" aria-hidden="true" tabindex="-1"></a>  time<span class="op">.</span>Sleep<span class="op">(</span>time<span class="op">.</span>Millisecond <span class="op">*</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb167-18"><a href="#cb167-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Real quick, what do you think this program prints out?</p>
<p>If you guessed this:</p>
<pre><code>Launching goroutine!
Launching another goroutine!
boop!
Launching one last goroutine!
</code></pre>
<p>Then you're either real smart, or real lucky. Maybe go buy a lottery ticket to test that.</p>
<p>However, if you didn't guess that, you're probably wondering where the two other missing <code class="verbatim">boop!</code> lines are.</p>
<p>Well, this is the first thing we've got to deal with when using goroutines. When we get to the end of <code class="verbatim">main.main</code> <em>all running goroutines stop</em>. So that's one way to cancel a goroutine: call <code class="verbatim">os.Exit(1)</code>!</p>
<p>We're guessing you don't want to have to cause your program to exit every time you want to stop a goroutine. For one thing, it means you could never have more than one goroutine running at a time. As incoming requests for both HTTP and GRPC services are handed off to goroutines, this is less than ideal.</p>
<p>So what other options do we have for stopping a goroutine?</p>
<p>Well, as we're still talking about contexts, you can probably guess what the answer is.</p>
<div class="sourceCode" id="cb169"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="op">(</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;context&quot;</span></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;fmt&quot;</span></span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;time&quot;</span></span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a><span class="op">)</span></span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-9"><a href="#cb169-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> boop<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb169-10"><a href="#cb169-10" aria-hidden="true" tabindex="-1"></a>  tick <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span>time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb169-11"><a href="#cb169-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-12"><a href="#cb169-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb169-13"><a href="#cb169-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="op">{</span></span>
<span id="cb169-14"><a href="#cb169-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">():</span></span>
<span id="cb169-15"><a href="#cb169-15" aria-hidden="true" tabindex="-1"></a>      fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Context cancelled, quitting goroutine %v!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb169-16"><a href="#cb169-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-17"><a href="#cb169-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>tick<span class="op">.</span>C<span class="op">:</span></span>
<span id="cb169-18"><a href="#cb169-18" aria-hidden="true" tabindex="-1"></a>      fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Boop from goroutine %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb169-19"><a href="#cb169-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb169-20"><a href="#cb169-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb169-21"><a href="#cb169-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb169-22"><a href="#cb169-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-23"><a href="#cb169-23" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb169-24"><a href="#cb169-24" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">:=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb169-25"><a href="#cb169-25" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">=</span> context<span class="op">.</span>WithTimeout<span class="op">(</span>ctx<span class="op">,</span> time<span class="op">.</span>Second <span class="op">*</span> <span class="dv">3</span><span class="op">)</span></span>
<span id="cb169-26"><a href="#cb169-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-27"><a href="#cb169-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> i<span class="op">:=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;=</span><span class="dv">3</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb169-28"><a href="#cb169-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> boop<span class="op">(</span>ctx<span class="op">,</span> i<span class="op">)</span></span>
<span id="cb169-29"><a href="#cb169-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb169-30"><a href="#cb169-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-31"><a href="#cb169-31" aria-hidden="true" tabindex="-1"></a>  time<span class="op">.</span>Sleep<span class="op">(</span>time<span class="op">.</span>Second <span class="op">*</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb169-32"><a href="#cb169-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-33"><a href="#cb169-33" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;exiting!&quot;</span><span class="op">)</span></span>
<span id="cb169-34"><a href="#cb169-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>That code prints out the following:</p>
<pre><code>Boop from goroutine 2
Boop from goroutine 3
Boop from goroutine 1
Boop from goroutine 2
Boop from goroutine 3
Boop from goroutine 1
Boop from goroutine 2
Boop from goroutine 1
Context cancelled, quitting goroutine 2!
Boop from goroutine 3
Context cancelled, quitting goroutine 1!
Context cancelled, quitting goroutine 3!
exiting!
</code></pre>
<p>Two things to note. First, the code actually has a bug, see if you can find it. Second, in between the second line and the last line was a ~8 second pause, because of the <code class="verbatim">time.Sleep</code>. What if we waited on the context, instead?</p>
<div class="sourceCode" id="cb171"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">()</span></span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a><span class="co">//time.Sleep(time.Second * 10)</span></span></code></pre></div>
<p>What do we get now?</p>
<pre><code>Boop from goroutine 2
Boop from goroutine 3
Boop from goroutine 1
Boop from goroutine 2
Boop from goroutine 1
Boop from goroutine 3
Boop from goroutine 2
Context cancelled, quitting goroutine 2!
Boop from goroutine 1
Boop from goroutine 3
Context cancelled, quitting goroutine 3!
exiting!
</code></pre>
<p>Oops! One of our <code class="verbatim">goroutines</code> didn't get a chance to clean up! This is because as soon as the scheduler goes back to <code class="verbatim">main.main</code>, the program prints 'exiting!' and, well, exits. What if we need to make sure the <code class="verbatim">goroutine</code> cleans up after itself?</p>
<p>Maybe <code class="verbatim">defer</code> is what we want.</p>
<div class="sourceCode" id="cb173"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> boop<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a> <span class="kw">defer</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;goroutine %v defer!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">)</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a> <span class="op">}()</span></span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a> tick <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span>time<span class="op">.</span>Second<span class="op">)</span></span></code></pre></div>
<p>And the output now is:</p>
<pre><code>Boop from goroutine 2
Boop from goroutine 3
Boop from goroutine 1
Boop from goroutine 3
Boop from goroutine 2
Boop from goroutine 1
Boop from goroutine 2
Boop from goroutine 1
Boop from goroutine 3
Context cancelled, quitting goroutine 2!
Context cancelled, quitting goroutine 3!
Context cancelled, quitting goroutine 1!
goroutine 1 defer!
goroutine 2 defer!
exiting!
</code></pre>
<p>Well…. drat. The <code class="verbatim">defer</code> added enough time for all the <code class="verbatim">goroutines</code> to hit the cancellation bit – but <code class="verbatim">goroutine</code> 3 failed to execute it's <code class="verbatim">defer</code>! This problem is only going to get worse as we add more and more <code class="verbatim">goroutines</code>. So what can we do?</p>
<p>Well, if you need to wait for a bunch of <code class="verbatim">goroutines</code> to finish, use <code class="verbatim">sync.WaitGroup</code>.</p>
<div class="sourceCode" id="cb175"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> boop<span class="op">(</span>ctx context<span class="op">.</span>Context<span class="op">,</span> wg <span class="op">*</span>sync<span class="op">.</span>WaitGroup<span class="op">,</span> id <span class="dt">int</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb175-2"><a href="#cb175-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defer</span> <span class="kw">func</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb175-3"><a href="#cb175-3" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;goroutine %v defer!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb175-4"><a href="#cb175-4" aria-hidden="true" tabindex="-1"></a>    wg<span class="op">.</span>Done<span class="op">()</span></span>
<span id="cb175-5"><a href="#cb175-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}()</span></span>
<span id="cb175-6"><a href="#cb175-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-7"><a href="#cb175-7" aria-hidden="true" tabindex="-1"></a>  tick <span class="op">:=</span> time<span class="op">.</span>NewTicker<span class="op">(</span>time<span class="op">.</span>Second<span class="op">)</span></span>
<span id="cb175-8"><a href="#cb175-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-9"><a href="#cb175-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb175-10"><a href="#cb175-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">select</span> <span class="op">{</span></span>
<span id="cb175-11"><a href="#cb175-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>ctx<span class="op">.</span>Done<span class="op">():</span></span>
<span id="cb175-12"><a href="#cb175-12" aria-hidden="true" tabindex="-1"></a>      fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Context cancelled, quitting goroutine %v!</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb175-13"><a href="#cb175-13" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span></span>
<span id="cb175-14"><a href="#cb175-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-15"><a href="#cb175-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">case</span> <span class="op">&lt;-</span>tick<span class="op">.</span>C<span class="op">:</span></span>
<span id="cb175-16"><a href="#cb175-16" aria-hidden="true" tabindex="-1"></a>      fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;Boop from goroutine %v</span><span class="ch">\n</span><span class="st">&quot;</span><span class="op">,</span> id<span class="op">)</span></span>
<span id="cb175-17"><a href="#cb175-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb175-18"><a href="#cb175-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb175-19"><a href="#cb175-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb175-20"><a href="#cb175-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-21"><a href="#cb175-21" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb175-22"><a href="#cb175-22" aria-hidden="true" tabindex="-1"></a>  ctx <span class="op">:=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb175-23"><a href="#cb175-23" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">,</span> cancel <span class="op">:=</span> context<span class="op">.</span>WithTimeout<span class="op">(</span>ctx<span class="op">,</span> time<span class="op">.</span>Second<span class="op">*</span><span class="dv">3</span><span class="op">)</span></span>
<span id="cb175-24"><a href="#cb175-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defer</span> cancel<span class="op">()</span></span>
<span id="cb175-25"><a href="#cb175-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-26"><a href="#cb175-26" aria-hidden="true" tabindex="-1"></a>  wg <span class="op">:=</span> <span class="op">&amp;</span>sync<span class="op">.</span>WaitGroup<span class="op">{}</span></span>
<span id="cb175-27"><a href="#cb175-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-28"><a href="#cb175-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> i <span class="op">:=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++</span> <span class="op">{</span></span>
<span id="cb175-29"><a href="#cb175-29" aria-hidden="true" tabindex="-1"></a>    wg<span class="op">.</span>Add<span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb175-30"><a href="#cb175-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">go</span> boop<span class="op">(</span>ctx<span class="op">,</span> wg<span class="op">,</span> i<span class="op">)</span></span>
<span id="cb175-31"><a href="#cb175-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb175-32"><a href="#cb175-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-33"><a href="#cb175-33" aria-hidden="true" tabindex="-1"></a>  wg<span class="op">.</span>Wait<span class="op">()</span></span>
<span id="cb175-34"><a href="#cb175-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb175-35"><a href="#cb175-35" aria-hidden="true" tabindex="-1"></a>  fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;exiting!&quot;</span><span class="op">)</span></span>
<span id="cb175-36"><a href="#cb175-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So why did we go through all this?</p>
<p>To show that <code class="verbatim">context.Context</code> is for <em>cancellation</em>. It does not help when you need to wait for something to finish.</p>
</section>
<section id="final-thoughts" class="level4" data-number="5.3.2.3">
<h4 data-number="5.3.2.3"><span class="header-section-number">5.3.2.3</span> Final Thoughts</h4>
<p>Let's take a step back for a moment and consider the purpose of a <code class="verbatim">context.Context</code>. It's a way to store values that <em>may</em> be needed later on during a request; whether that request is a function call or an HTTP request doesn't really matter. It's also a way to pass into a function a way of saying "hey, just stop, I don't need you to do any more work".</p>
<p>Both of these behaviours are valuable. We don't want a database call to continue when the request was canceled by the user. At the same time, we need a single way to handle passing values down the call stack that <em>might</em> be required.</p>
<p>One thing you're probably wondering is why we're saying "might" and "may" or "maybe" when talking about the values shoved into a <code class="verbatim">context.Context</code> using <code class="verbatim">context.WithValue</code>. Well, the reason is the untyped nature of what gets stored in a context. While this isn't correct, you can think of the data being shoved into a <code class="verbatim">map[any]any</code>. So not only are the keys untyped, but so are the values that are saved. Additionally, <code class="verbatim">context.WithValue</code> is copy-on-write, meaning no storing stuff like <code class="verbatim">sync.Mutex</code>.</p>
<p>So what kinds of things <em>should</em> we put in a <code class="verbatim">context.Context</code>?</p>
<p>A good place to start is this:</p>
<div class="NOTE">
<p>Only data that isn't needed to handle the request can be stored in a <code class="verbatim">context.Context</code>.</p>
</div>
<p>Not bad, but still needs some work. The word "data" can mean too many things here. Let's narrow that down a bit.</p>
<div class="NOTE">
<p>Only <em>concrete types</em> that aren't needed to handle the request can be stored in a <code class="verbatim">context.Context</code>.</p>
</div>
<p>Still to vague; <code class="verbatim">http.Request</code> is a concrete type but you should <strong>never</strong> put it into a <code class="verbatim">context.Context</code>.</p>
<div class="NOTE">
<p>Only <em>built-in types</em> holding data that isn't needed to handle the request can be stored in a <code class="verbatim">context.Context</code></p>
</div>
<p>Whoops, now our whole <code class="verbatim">RequestID</code> example is invalid. Let's open it up a tiny bit.</p>
<div class="NOTE">
<p>Only <em>built-in types or user types that extend built-in types</em> that are holding data that isn't needed to handle the request can be stored in a <code class="verbatim">context.Context</code></p>
</div>
<p>Hrmmm. <code class="verbatim">struct{}</code> is a built in type. What we want are <em>basic</em> types. However, we don't want to say 'basic' here, that's still confusing. We're also trying to define what we <em>don't</em> want. We don't want types based on <code class="verbatim">struct</code> because those can get way too big. What about slices or maps? Well, because those can be <code class="verbatim">[]any</code> or <code class="verbatim">map[any][any]</code> we don't want those. What do structs, slices, and maps all have in common? They're composite types!</p>
<div class="NOTE">
<p>Only <em>built-in, non-composite types or user types that extend such types</em> that are holding data that isn't needed to handle the request can be stored in a <code class="verbatim">context.Context</code></p>
</div>
<p>Okay! Let's do a quick sniff test.</p>
<ul>
<li><code class="verbatim">http.Request</code>? composite type, not allowed</li>
<li><code class="verbatim">*zap.SugaredLogger</code>? same, still a composite type</li>
<li>our custom <code class="verbatim">RequestID</code>? it's based on <code class="verbatim">string</code>, so that's fine</li>
</ul>
<p>That sounds pretty reasonable, right? We could probably extend this definition to cover more and more use cases. However, at that point your problem isn't that developers don't understand this rule – it's that they don't think it's a good rule.</p>
<p>This is where we, unfortunately, have to communicate. Yes, sometimes we have to remember we're part of a team, and that means discussing things until a compromise is reached.</p>
<p>Plus, there might be some cases where we want to put a struct into a context – despite just having spent many paragraphs saying why that's probably a bad idea.</p>
<p>So for now, here's a second rule for <em>where</em> you can put stuff into a context:</p>
<div class="NOTE">
<p>The only place data can be placed into a context is in any request-serving middleware.</p>
</div>
<p>That's a pretty good rule, right? The middleware is where most of the data we want to put into the context is, after all. We don't want to have to remember to put the request ID into the context in each handler – so we do it in middleware.</p>
<p>So what makes sense to put in the context, given this additional rule?</p>
<ul>
<li>request ID</li>
<li>trace &amp; span ID</li>
<li>some kind of user ID for routes that have to authenticate the user in the middleware</li>
<li>some kind of tracking ID, which may just be the user ID</li>
</ul>
<p>There may be some other pieces of data that are worth pulling out of the request and putting in the context, but probably not many. Maybe if there are any custom header values for things like feature flags and the like. Otherwise, try to keep the number of things being put into the context <em>as low as possible</em>.</p>
<p>Notice we're not giving a maximum for how many things to put into a <code class="verbatim">context.Context</code>. The reason is one we've already gone over above: the same way that some requests may need to put a <code class="verbatim">struct</code> into the context, some requests may need to store twenty things in the <code class="verbatim">context.Context</code>.</p>
<p>HOWEVER.</p>
<p>Doing so should be a last resort.</p>
<p>Yes, there are times when you don't have any option but stuffing a bunch of stuff into a <code class="verbatim">context.Context</code>. For example, <a href="https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md">metadata for GRPC calls</a> is put into a map… that's then put into a <code class="verbatim">context.Context</code>. This is how GRPC handles what are basically HTTP headers. In such situations though, consider how much metadata is actually required – the other side of the GRPC call has to deal with all that metadata, and if the GRPC service is written in Go all that metadata is being shoved back into a <code class="verbatim">context.Context</code> on the other side. One upside is that it's possible to <em>replace</em> the metadata in a <code class="verbatim">context.Context</code> instead of just appending more, but that's not something we should rely on.</p>
</section>
</section>
</section>
</section>
<section id="apendixes" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Apendixes</h1>
<section id="error-handling-too-many-behaviours" class="level2" data-number="6.1" id="ed34c1e7-7924-49bf-88e4-75763a84ea90">
<h2 data-number="6.1" id="ed34c1e7-7924-49bf-88e4-75763a84ea90"><span class="header-section-number">6.1</span> Error Handling: Too Many Behaviours</h2>
<p>What do we do when we have a function that can return errors that match a number of behaviours?</p>
<p>For example:</p>
<div class="sourceCode" id="cb176"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb176-1"><a href="#cb176-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ProcessData instructs the time sheet it receives to read data from</span></span>
<span id="cb176-2"><a href="#cb176-2" aria-hidden="true" tabindex="-1"></a><span class="co">// a specific file, process the data, and then write the processed data</span></span>
<span id="cb176-3"><a href="#cb176-3" aria-hidden="true" tabindex="-1"></a><span class="co">// to a separate file.</span></span>
<span id="cb176-4"><a href="#cb176-4" aria-hidden="true" tabindex="-1"></a><span class="co">//</span></span>
<span id="cb176-5"><a href="#cb176-5" aria-hidden="true" tabindex="-1"></a><span class="co">// On success, it returns the path to the file. Otherwise returns an error.</span></span>
<span id="cb176-6"><a href="#cb176-6" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessData<span class="op">(</span>r <span class="op">*</span>reporting<span class="op">.</span>TimeSheet<span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span><span class="dt">error</span><span class="op">){</span></span>
<span id="cb176-7"><a href="#cb176-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// do some things to get ready, assume some other code is in here.</span></span>
<span id="cb176-8"><a href="#cb176-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-9"><a href="#cb176-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// readPath &amp; writePath are strings</span></span>
<span id="cb176-10"><a href="#cb176-10" aria-hidden="true" tabindex="-1"></a>  readPath <span class="op">:=</span> getReadFromPath<span class="op">()</span></span>
<span id="cb176-11"><a href="#cb176-11" aria-hidden="true" tabindex="-1"></a>  writePath <span class="op">:=</span> getWriteToPath<span class="op">()</span></span>
<span id="cb176-12"><a href="#cb176-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-13"><a href="#cb176-13" aria-hidden="true" tabindex="-1"></a>  path<span class="op">,</span> err <span class="op">:=</span> r<span class="op">.</span>Process<span class="op">(</span>readPath<span class="op">,</span> writePath<span class="op">)</span></span>
<span id="cb176-14"><a href="#cb176-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb176-15"><a href="#cb176-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// uh-oh! we can get a bunch of different errors from this,</span></span>
<span id="cb176-16"><a href="#cb176-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// so use a type switch to handle them properly</span></span>
<span id="cb176-17"><a href="#cb176-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">switch</span> x <span class="op">:=</span> err<span class="op">.(</span><span class="kw">type</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb176-18"><a href="#cb176-18" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> reporting<span class="op">.</span>ReadError<span class="op">:</span></span>
<span id="cb176-19"><a href="#cb176-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// file doesn&#39;t exist, do something about that</span></span>
<span id="cb176-20"><a href="#cb176-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-21"><a href="#cb176-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> reporting<span class="op">.</span>ProcessingError<span class="op">:</span></span>
<span id="cb176-22"><a href="#cb176-22" aria-hidden="true" tabindex="-1"></a>      <span class="co">// file exists, but has bad data?</span></span>
<span id="cb176-23"><a href="#cb176-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-24"><a href="#cb176-24" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> reporting<span class="op">.</span>WriteError<span class="op">:</span></span>
<span id="cb176-25"><a href="#cb176-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">// whoops, unable to write the output, definitely gotta deal with that</span></span>
<span id="cb176-26"><a href="#cb176-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-27"><a href="#cb176-27" aria-hidden="true" tabindex="-1"></a>      <span class="kw">default</span><span class="op">:</span></span>
<span id="cb176-28"><a href="#cb176-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">// some other error that we probably don&#39;t want to handle?</span></span>
<span id="cb176-29"><a href="#cb176-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb176-30"><a href="#cb176-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb176-31"><a href="#cb176-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb176-32"><a href="#cb176-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// rest of function does it&#39;s thing</span></span>
<span id="cb176-33"><a href="#cb176-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> writePath<span class="op">,</span> <span class="ot">nil</span></span>
<span id="cb176-34"><a href="#cb176-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Oof. Type switching on an error is never a <em>great</em> sign. Hopefully the code to handle each error case is it's own function or this switch statement will quickly become unreadable.</p>
<p>So it's pretty clear here that replacing those sentinel errors from the <code class="verbatim">reporting</code> package with locally defined interfaces won't be all that much better. At least in the case where we have too many behaviours we need to check for.</p>
<p>But we still need to handle these errors; the code calling <code class="verbatim">ProcessData</code> should only get an error if this function completely fails to do it's job.</p>
<p>And if possible, we'd like to remove 3 of our dependencies in the <code class="verbatim">reporting</code> package – the three error types. It would be much nicer if all we relied on was <code class="verbatim">reporting.TimeSheet</code> ( or even better; an interface that describes what we need to be able to do ).</p>
<p>How do we get that?</p>
<p>Well, the first thing is to determine if we <em>can</em> even improve this. If <code class="verbatim">reporting</code> is a third-party package we've imported, this is about as good as we can expect to do.</p>
<p>What if we wrote the <code class="verbatim">reporting</code> package? What can we do then? Maybe we can refactor things to be cleaner and clearer?</p>
<p>Let's give that a shot.</p>
<p>First, let's take a look at the file where the <code class="verbatim">reporting.TimeSheet</code> type is defined:</p>
<div class="sourceCode" id="cb177"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> reporting</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> TimeSheet <span class="kw">struct</span> <span class="op">{</span></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// a whole bunch of unexported fields</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a><span class="co">// a bunch of functions that aren&#39;t relevant</span></span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>ts <span class="op">*</span>TimeSheet<span class="op">)</span> Process<span class="op">(</span>readPath<span class="op">,</span> writePath <span class="dt">string</span><span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span><span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb177-10"><a href="#cb177-10" aria-hidden="true" tabindex="-1"></a>  bits<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>ReadFile<span class="op">(</span>readPath<span class="op">)</span></span>
<span id="cb177-11"><a href="#cb177-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb177-12"><a href="#cb177-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> ReadError<span class="op">{</span>err<span class="op">:</span> err<span class="op">}</span></span>
<span id="cb177-13"><a href="#cb177-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb177-14"><a href="#cb177-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-15"><a href="#cb177-15" aria-hidden="true" tabindex="-1"></a>  output<span class="op">,</span> err <span class="op">=</span> ts<span class="op">.</span>bigProcessingFunction<span class="op">(</span>bits<span class="op">)</span></span>
<span id="cb177-16"><a href="#cb177-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb177-17"><a href="#cb177-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> ProcessingError<span class="op">{</span>err<span class="op">:</span> err<span class="op">}</span></span>
<span id="cb177-18"><a href="#cb177-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb177-19"><a href="#cb177-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-20"><a href="#cb177-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// maybe do some other stuff with the output</span></span>
<span id="cb177-21"><a href="#cb177-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// maybe do lots of stuff</span></span>
<span id="cb177-22"><a href="#cb177-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-23"><a href="#cb177-23" aria-hidden="true" tabindex="-1"></a>  err <span class="op">=</span> os<span class="op">.</span>WriteFile<span class="op">(</span>writePath<span class="op">,</span> output<span class="op">,</span> <span class="dv">0o644</span><span class="op">)</span></span>
<span id="cb177-24"><a href="#cb177-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb177-25"><a href="#cb177-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> WriteError<span class="op">{</span>err<span class="op">:</span> err<span class="op">}</span></span>
<span id="cb177-26"><a href="#cb177-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb177-27"><a href="#cb177-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-28"><a href="#cb177-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> writePath<span class="op">,</span> <span class="ot">nil</span></span>
<span id="cb177-29"><a href="#cb177-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Doesn't look too bad, right?</p>
<p>Can you tell why this code should be refactored? Is this even the right code to refactor?</p>
<p>What if it looked like this instead:</p>
<div class="sourceCode" id="cb178"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb178-1"><a href="#cb178-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-2"><a href="#cb178-2" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> <span class="op">(</span>ts <span class="op">*</span>TimeSheet<span class="op">)</span> Process<span class="op">(</span>input io<span class="op">.</span>Reader<span class="op">)</span> <span class="op">(</span>io<span class="op">.</span>Reader<span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb178-3"><a href="#cb178-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// bigProcessingFunction(input io.Reader) ([]byte, error)</span></span>
<span id="cb178-4"><a href="#cb178-4" aria-hidden="true" tabindex="-1"></a>  output<span class="op">,</span> err <span class="op">:=</span> ts<span class="op">.</span>bigProcessingFunction<span class="op">(</span>input<span class="op">)</span></span>
<span id="cb178-5"><a href="#cb178-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb178-6"><a href="#cb178-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="ot">nil</span><span class="op">,</span> ProcessingError<span class="op">{</span>err<span class="op">:</span> err<span class="op">}</span></span>
<span id="cb178-7"><a href="#cb178-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb178-8"><a href="#cb178-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-9"><a href="#cb178-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// do some other stuff with output here,</span></span>
<span id="cb178-10"><a href="#cb178-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// if there&#39;s an error return ProcessingError{}</span></span>
<span id="cb178-11"><a href="#cb178-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb178-12"><a href="#cb178-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// now return a reader</span></span>
<span id="cb178-13"><a href="#cb178-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> bytes<span class="op">.</span>NewBuffer<span class="op">(</span>output<span class="op">),</span> <span class="ot">nil</span></span>
<span id="cb178-14"><a href="#cb178-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And our <code class="verbatim">ProcessData</code> method looked like this:</p>
<div class="sourceCode" id="cb179"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> processor <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>  Process<span class="op">(</span>io<span class="op">.</span>Reader<span class="op">)</span> <span class="dt">error</span></span>
<span id="cb179-3"><a href="#cb179-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb179-4"><a href="#cb179-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-5"><a href="#cb179-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessData<span class="op">(</span>p processor<span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="dt">error</span><span class="op">){</span></span>
<span id="cb179-6"><a href="#cb179-6" aria-hidden="true" tabindex="-1"></a>  readFrom<span class="op">,</span> err <span class="op">:=</span> getReportInput<span class="op">()</span></span>
<span id="cb179-7"><a href="#cb179-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb179-8"><a href="#cb179-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to get report input: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb179-9"><a href="#cb179-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb179-10"><a href="#cb179-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-11"><a href="#cb179-11" aria-hidden="true" tabindex="-1"></a>  processed<span class="op">,</span> err <span class="op">:=</span> p<span class="op">.</span>Process<span class="op">(</span>readFrom<span class="op">)</span></span>
<span id="cb179-12"><a href="#cb179-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb179-13"><a href="#cb179-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to process report data: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb179-14"><a href="#cb179-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb179-15"><a href="#cb179-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb179-16"><a href="#cb179-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> handleOutput<span class="op">(</span>processed<span class="op">)</span></span>
<span id="cb179-17"><a href="#cb179-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Rather than having a <code class="verbatim">TimeSheet.Process</code> method that has to know how to:</p>
<ul>
<li>open a file
<ul>
<li>and try do the right thing if that fails</li>
</ul></li>
<li>call a function that does the bulk of the processing</li>
<li>do a little bit more processing to the data</li>
<li>write the data to a file
<ul>
<li>and try to do the right thing if <em>that</em> fails</li>
</ul></li>
</ul>
<p>Instead, we've now got a <code class="verbatim">TimeSheet.Process</code> method that does one thing:</p>
<ul>
<li>process the data, returning a <code class="verbatim">ProcessingError</code> if something goes wrong</li>
</ul>
<p>Now, it's our <code class="verbatim">ProcessData</code> that's responsible for preparing an <code class="verbatim">io.Reader</code> for <code class="verbatim">TimeSheet.Process</code> to read from. If something goes wrong trying to get that reader prepared, well, that's the job of <code class="verbatim">getReportInput</code> to deal with. Same for when trying to write the data out to a file – <code class="verbatim">handleOutput</code> deals with that.</p>
<p>This is also more useful code. Now a <code class="verbatim">reporting.TimeSheet</code> can use <em>anything</em> that fulfills the <code class="verbatim">io.Reader</code> interface. Maybe you want to read that data over the network? Or from a gzipped file? Or a tarballed, gzipped file from over the network?</p>
<div class="sourceCode" id="cb180"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb180-1"><a href="#cb180-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataFromURL<span class="op">(</span>url <span class="dt">string</span><span class="op">,</span> p processor<span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="dt">error</span><span class="op">){</span></span>
<span id="cb180-2"><a href="#cb180-2" aria-hidden="true" tabindex="-1"></a>  resp<span class="op">,</span> err <span class="op">:=</span> http<span class="op">.</span>Get<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb180-3"><a href="#cb180-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb180-4"><a href="#cb180-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to retrieve data from endpoint&quot;</span><span class="op">)</span></span>
<span id="cb180-5"><a href="#cb180-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb180-6"><a href="#cb180-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-7"><a href="#cb180-7" aria-hidden="true" tabindex="-1"></a>  readFrom <span class="op">:=</span> zip<span class="op">.</span>Decompressor<span class="op">(</span>tar<span class="op">.</span>NewReader<span class="op">(</span>resp<span class="op">.</span>Body<span class="op">))</span></span>
<span id="cb180-8"><a href="#cb180-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-9"><a href="#cb180-9" aria-hidden="true" tabindex="-1"></a>  processed<span class="op">,</span> err <span class="op">:=</span> p<span class="op">.</span>Process<span class="op">(</span>readFrom<span class="op">)</span></span>
<span id="cb180-10"><a href="#cb180-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb180-11"><a href="#cb180-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to process report data: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb180-12"><a href="#cb180-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb180-13"><a href="#cb180-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb180-14"><a href="#cb180-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> handleOutput<span class="op">(</span>processed<span class="op">)</span></span>
<span id="cb180-15"><a href="#cb180-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>What if the data has to be written to a compressed file?</p>
<div class="sourceCode" id="cb181"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> handleTarballOutput<span class="op">(</span>data io<span class="op">.</span>Reader<span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// returns *os.File</span></span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>  output<span class="op">,</span> err <span class="op">:=</span> determineOutputFile<span class="op">()</span></span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb181-5"><a href="#cb181-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> err</span>
<span id="cb181-6"><a href="#cb181-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb181-7"><a href="#cb181-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-8"><a href="#cb181-8" aria-hidden="true" tabindex="-1"></a>  w <span class="op">:=</span> zip<span class="op">.</span>Compressor<span class="op">(</span>tar<span class="op">.</span>NewWriter<span class="op">(</span>output<span class="op">))</span></span>
<span id="cb181-9"><a href="#cb181-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-10"><a href="#cb181-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// don&#39;t care how many bytes were written, ignore first return value</span></span>
<span id="cb181-11"><a href="#cb181-11" aria-hidden="true" tabindex="-1"></a>  _<span class="op">,</span> err <span class="op">:=</span> io<span class="op">.</span>Copy<span class="op">(</span>w<span class="op">,</span> data<span class="op">)</span></span>
<span id="cb181-12"><a href="#cb181-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-13"><a href="#cb181-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> output<span class="op">.</span>Name<span class="op">(),</span> err</span>
<span id="cb181-14"><a href="#cb181-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb181-15"><a href="#cb181-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-16"><a href="#cb181-16" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataFromURLWriteToTarball<span class="op">(</span>url <span class="dt">string</span><span class="op">,</span> p processor<span class="op">)</span> <span class="op">(</span><span class="dt">string</span><span class="op">,</span> <span class="dt">error</span><span class="op">){</span></span>
<span id="cb181-17"><a href="#cb181-17" aria-hidden="true" tabindex="-1"></a>  resp<span class="op">,</span> err <span class="op">:=</span> http<span class="op">.</span>Get<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb181-18"><a href="#cb181-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb181-19"><a href="#cb181-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to retrieve data from endpoint&quot;</span><span class="op">)</span></span>
<span id="cb181-20"><a href="#cb181-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb181-21"><a href="#cb181-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-22"><a href="#cb181-22" aria-hidden="true" tabindex="-1"></a>  readFrom <span class="op">:=</span> zip<span class="op">.</span>Decompressor<span class="op">(</span>tar<span class="op">.</span>NewReader<span class="op">(</span>resp<span class="op">.</span>Body<span class="op">))</span></span>
<span id="cb181-23"><a href="#cb181-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-24"><a href="#cb181-24" aria-hidden="true" tabindex="-1"></a>  processed<span class="op">,</span> err <span class="op">:=</span> p<span class="op">.</span>Process<span class="op">(</span>readFrom<span class="op">)</span></span>
<span id="cb181-25"><a href="#cb181-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb181-26"><a href="#cb181-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="st">&quot;&quot;</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to process report data: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb181-27"><a href="#cb181-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb181-28"><a href="#cb181-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb181-29"><a href="#cb181-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> handleTarballOutput<span class="op">(</span>processed<span class="op">)</span></span>
<span id="cb181-30"><a href="#cb181-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And <em>yes</em>, these are very simplified examples. However, they still show how using the SOLID principles can help us write code that doesn't depend on type switching or interrogating errors by type or behavior.</p>
<p>But we can take this further, and make our code <em>even more useful</em>.</p>
<div class="sourceCode" id="cb182"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataIntoOutput<span class="op">(</span>input io<span class="op">.</span>Reader<span class="op">,</span> output io<span class="op">.</span>Writer<span class="op">,</span> p processor<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  processed<span class="op">,</span> err <span class="op">:=</span> p<span class="op">.</span>Process<span class="op">(</span>input<span class="op">)</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="ot">nil</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to process data: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-7"><a href="#cb182-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// is there something else that needs to happen here?</span></span>
<span id="cb182-8"><a href="#cb182-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-9"><a href="#cb182-9" aria-hidden="true" tabindex="-1"></a>  _<span class="op">,</span> err <span class="op">=</span> io<span class="op">.</span>Copy<span class="op">(</span>processed<span class="op">,</span> output<span class="op">)</span></span>
<span id="cb182-10"><a href="#cb182-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to copy processed data to output: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb182-11"><a href="#cb182-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This function only cares about one thing: taking the data returned from <code class="verbatim">TimeSheet.Process</code>, and copying that to the output. If it needs to do something to the data before writing it, it gets passed into a function and we get back a new <code class="verbatim">io.Reader</code>. This way, <code class="verbatim">ProcessDataIntoOutput</code> stays clear and easy to understand.</p>
<p>Now all those other processing functions turn into these:</p>
<div class="sourceCode" id="cb183"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb183-1"><a href="#cb183-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataFromURL<span class="op">(</span>url <span class="dt">string</span><span class="op">,</span> output io<span class="op">.</span>Writer<span class="op">,</span> p processor<span class="op">)</span> <span class="op">(</span><span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb183-2"><a href="#cb183-2" aria-hidden="true" tabindex="-1"></a>  resp<span class="op">,</span> err <span class="op">:=</span> http<span class="op">.</span>Get<span class="op">(</span>url<span class="op">)</span></span>
<span id="cb183-3"><a href="#cb183-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb183-4"><a href="#cb183-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to fetch data from &#39;%v&#39;, reason: %w&quot;</span><span class="op">,</span> url<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb183-5"><a href="#cb183-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb183-6"><a href="#cb183-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-7"><a href="#cb183-7" aria-hidden="true" tabindex="-1"></a>  readFrom <span class="op">:=</span> zip<span class="op">.</span>Decompressor<span class="op">(</span>tar<span class="op">.</span>NewReader<span class="op">(</span>resp<span class="op">.</span>Body<span class="op">))</span></span>
<span id="cb183-8"><a href="#cb183-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-9"><a href="#cb183-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> ProcessDataIntoOutput<span class="op">(</span>readFrom<span class="op">,</span> output<span class="op">,</span> p<span class="op">)</span></span>
<span id="cb183-10"><a href="#cb183-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb183-11"><a href="#cb183-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-12"><a href="#cb183-12" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataIntoFileFromURL<span class="op">(</span>url<span class="op">,</span> outputPath <span class="dt">string</span><span class="op">,</span> p processor<span class="op">)</span> <span class="op">(</span><span class="dt">error</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb183-13"><a href="#cb183-13" aria-hidden="true" tabindex="-1"></a>  of<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>OpenFile<span class="op">(</span>outputPath <span class="op">,</span> os<span class="op">.</span>O_CREATE<span class="op">|</span>os<span class="op">.</span>O_TRUNC<span class="op">,</span> <span class="dv">0o644</span><span class="op">)</span></span>
<span id="cb183-14"><a href="#cb183-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb183-15"><a href="#cb183-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to open file: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb183-16"><a href="#cb183-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb183-17"><a href="#cb183-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-18"><a href="#cb183-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> ProcessDataFromURL<span class="op">(</span>url<span class="op">,</span> of<span class="op">,</span> p<span class="op">)</span></span>
<span id="cb183-19"><a href="#cb183-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb183-20"><a href="#cb183-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-21"><a href="#cb183-21" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataFromTarball<span class="op">(</span>path <span class="dt">string</span><span class="op">,</span> output io<span class="op">.</span>Writer<span class="op">,</span> p processor<span class="op">)</span> <span class="op">(</span><span class="dt">error</span><span class="op">){</span></span>
<span id="cb183-22"><a href="#cb183-22" aria-hidden="true" tabindex="-1"></a>  f<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>OpenFile<span class="op">(</span>path<span class="op">,</span> os<span class="op">.</span>O_RDONLY<span class="op">,</span> <span class="dv">0o644</span><span class="op">)</span></span>
<span id="cb183-23"><a href="#cb183-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb183-24"><a href="#cb183-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to open file: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb183-25"><a href="#cb183-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb183-26"><a href="#cb183-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-27"><a href="#cb183-27" aria-hidden="true" tabindex="-1"></a>  readFrom <span class="op">:=</span> tar<span class="op">.</span>NewReader<span class="op">(</span>zip<span class="op">.</span>Decompressor<span class="op">(</span>f<span class="op">))</span></span>
<span id="cb183-28"><a href="#cb183-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb183-29"><a href="#cb183-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> ProcessDataIntoOutput<span class="op">(</span>readFrom<span class="op">,</span> output<span class="op">,</span> p<span class="op">)</span></span>
<span id="cb183-30"><a href="#cb183-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Now every time we want to read or write from anything we don't support – so long as we can turn it into an <code class="verbatim">io.Reader</code> to read from or an <code class="verbatim">io.Writer</code> to write from, we're good!</p>
<p>Also, we can now use these functions to handle other things. Maybe the <code class="verbatim">reporting</code> package has a <code class="verbatim">BudgetSheet</code> method that has the same <code class="verbatim">Process</code> method that <code class="verbatim">TimeSheet</code> does. Or maybe something over in the <code class="verbatim">accounting</code> package, or the <code class="verbatim">analytics</code> package. By flipping the dependencies so that <code class="verbatim">ProcessData</code> isn't trying to do a whole bunch, make it so that all <code class="verbatim">ProcessData</code> cares about is three behaviours.</p>
<p>The arguments for the old <code class="verbatim">ProcessData</code> told you very little. All you could tell is that you passed in a time sheet and… something happened.</p>
<p>Now, it's very clear. The name of the function tells us what it <em>does</em> with the data – it uses a <code class="verbatim">processor</code> to process data from an <code class="verbatim">io.Reader</code>, and writes the data into an <code class="verbatim">io.Writer</code>.</p>
<div class="NOTE">
<p>You might be wondering why the functions take <code class="verbatim">io.Writer</code> or <code class="verbatim">io.Reader</code> instead of <code class="verbatim">io.WriteCloser</code>, <code class="verbatim">io.ReadCloser</code>, or any of the other composite interfaces defined in the <code class="verbatim">io</code> package.</p>
<p>Well that's because we're doing this the SOLID way. Each function should have one responsibility. But this doesn't mean we want to read all the data into a <code class="verbatim">[]byte</code> and pass that in, because then we're dealing with potentially lots of data ( megabytes, gigabytes, potentially even terabytes ). So using the <code class="verbatim">io.Reader</code> interface let's us signal that we want data, but not all at once. For example, what if the processor only cares about the first megabyte of data?</p>
<p>Additionally, <code class="verbatim">ProcessDataIntoOutput</code> doesn't need to care about closing the reader or writer. It doesn't know, or need to know, if we're done reading <em>or</em> writing. This function might get called inside a loop as we process a bunch of input files into a single output file. How much worse would this be if that code had to re-open and <em>seek to the right spot</em> before moving on to the next loop iteration?</p>
<p>Reading data, processing it, and writing it is small enough to be a single responsibility – so long as you're using interfaces that limit your function to <em>just that behaviour</em>.</p>
</div>
</section>
<section id="why-do-some-packages-define-their-own-interfaces" class="level2" data-number="6.2">
<h2 data-number="6.2"><span class="header-section-number">6.2</span> Why <em>Do</em> Some Packages Define Their Own Interfaces?</h2>
<p>There are, of course, some caveats.</p>
<p>A good example is the <code class="verbatim">Reader</code> interface provided by the <code class="verbatim">io</code> package:</p>
<div class="sourceCode" id="cb184"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> Reader <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a> Read<span class="op">(</span>p <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="op">(</span>n <span class="dt">int</span><span class="op">,</span> err <span class="dt">error</span><span class="op">)</span></span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>For those still new to Go: a <code class="verbatim">Reader</code> is an interface that allows users to pass in a slice of bytes that data will be read into (it's assumed you either don't care about what's currently in the slice or that it's empty). It returns how many bytes were written to the slice, as well as an error to signal an error – or an <code class="verbatim">io.EOF</code> error to signal there's nothing more to read.</p>
<p>I'm not going to dive into why this interface was designed this way, there are plenty of other articles that will do so. For example, <a href="https://dave.cheney.net/2019/09/05/dont-force-allocations-on-the-callers-of-your-api">why do you pass in a byte slice instead of <code class="verbatim">Read</code> returning one</a>?</p>
<p>Instead, let's talk about why the <code class="verbatim">io</code> package defines one <strong>at all</strong>.</p>
<p>Well, let's think about all the places in the standard library that accept <code class="verbatim">io.Reader</code> as an argument.</p>
<p>First off, there are <a href="https://cs.opensource.google/search?q=case:y%20func%5Cs%5BA-Z%5D.%2Bio.Reader%5B,)%5D%20&amp;sq=&amp;ss=go">at least 154 functions that accept an io.Reader</a>, across nearly as many packages.</p>
<p>Let's take a look at one of those: <a href="https://pkg.go.dev/golang.org/x/image/webp">the image/webp package</a>. This package defines just two functions: <code class="verbatim">Decode</code> and <code class="verbatim">DecodeConfig</code>. The first one attempts to convert the image into the <code class="verbatim">image.Image</code> struct used by all of the <code class="verbatim">image</code> sub-packages, the second one attempts to read information from the header and return color model &amp; dimension information as a <code class="verbatim">image.Config</code>.</p>
<p>So why <code class="verbatim">io.Reader</code> and not <code class="verbatim">webp.Reader</code> or <code class="verbatim">image.Reader</code>?</p>
<p>Well, the immediately obvious answer is that <code class="verbatim">io.Reader</code> already exists, and code re-use is good, so bing bang boom we're using <code class="verbatim">io.Reader</code>.</p>
<p>…Right?</p>
<p>Well, there's more to it than that. What if the team behind the <code class="verbatim">image</code> package decided they made their own, slightly different interface:</p>
<div class="sourceCode" id="cb185"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb185-1"><a href="#cb185-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ImageReader reads `lim` bytes into `b`. Returns `image.End`</span></span>
<span id="cb185-2"><a href="#cb185-2" aria-hidden="true" tabindex="-1"></a><span class="co">// if no more bytes can be read, nil if there is no error, and</span></span>
<span id="cb185-3"><a href="#cb185-3" aria-hidden="true" tabindex="-1"></a><span class="co">// a non-nil, non-`image.End` for all other cases.</span></span>
<span id="cb185-4"><a href="#cb185-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> ImageReader <span class="kw">interface</span> <span class="op">{</span></span>
<span id="cb185-5"><a href="#cb185-5" aria-hidden="true" tabindex="-1"></a>  Read<span class="op">(</span>b <span class="op">[]</span><span class="dt">byte</span><span class="op">,</span> lim <span class="dt">int</span><span class="op">)</span> <span class="dt">error</span></span>
<span id="cb185-6"><a href="#cb185-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>So what does this mean for code that wants to see how big a .webp is by using <code class="verbatim">DecodeConfig</code>? What if the image is being read over the network? What the image has been compressed? What if…?</p>
<p>Think about how easy it is to compose all those cases because of how ubiquitous <code class="verbatim">io.Reader</code> is:</p>
<div class="sourceCode" id="cb186"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a>conf<span class="op">,</span> err <span class="op">:=</span> webp<span class="op">.</span>DecodeConfig<span class="op">(</span>zip<span class="op">.</span>Decompressor<span class="op">(</span>req<span class="op">.</span>Body<span class="op">))</span></span></code></pre></div>
<p>Now, what if each of those had it's own unique reader? How do you transform a <code class="verbatim">=http.Request#Body</code> into something <code class="verbatim">zip.Decompressor</code> can accept? How do you turn <em>that</em> into something <code class="verbatim">webp.DecodeConfig</code> can accept?</p>
<p>By standardizing on the use of <code class="verbatim">io.Reader</code> as how bytes are read, it opens up thousands of ways to compose readers to accomplish what you're looking for.</p>
An alternative way to think about this is that many packages <em>might have had</em> their own interfaces that looked like or performed the same function as <code class="verbatim">io.Reader</code> – and the Go team standardized on <code class="verbatim">io.Reader</code> as <strong>the</strong> interface defining how to read bytes, and put it in the <code class="verbatim">io</code> package.
</section>
<section id="why-is-io.reader-an-example-of-great-interface-design" class="level2" data-number="6.3">
<h2 data-number="6.3"><span class="header-section-number">6.3</span> Why is <code class="verbatim">io.Reader</code> an example of great interface design?</h2>
<p><code class="verbatim">io.Reader</code> is a great example of an interface, any design weirdness aside.</p>
<p>So, why <strong>is</strong> <code class="verbatim">io.Reader</code> so great?</p>
<p>Let's take a look at two functions that both do the same thing: read some bytes, looking for a specific set of bytes, and returning true as soon as that set of bytes is found.</p>
<div class="sourceCode" id="cb187"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb187-1"><a href="#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> lookFor <span class="op">=</span> <span class="op">[]</span><span class="dt">byte</span><span class="op">{</span><span class="dv">0x68</span><span class="op">,</span> <span class="dv">0x65</span><span class="op">,</span> <span class="dv">0x6C</span><span class="op">,</span> <span class="dv">0x6C</span><span class="op">,</span> <span class="dv">0x6F</span><span class="op">,</span> <span class="dv">0x20</span><span class="op">,</span> <span class="dv">0x77</span><span class="op">,</span> <span class="dv">0x6F</span><span class="op">,</span> <span class="dv">0x72</span><span class="op">,</span> <span class="dv">0x6C</span><span class="op">,</span> <span class="dv">0x64</span><span class="op">}</span></span>
<span id="cb187-2"><a href="#cb187-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-3"><a href="#cb187-3" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> FindInSlice<span class="op">(</span>b <span class="op">[]</span><span class="dt">byte</span><span class="op">)</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb187-4"><a href="#cb187-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// do the check!</span></span>
<span id="cb187-5"><a href="#cb187-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> bytes<span class="op">.</span>Contains<span class="op">(</span>b<span class="op">,</span> lookFor<span class="op">)</span></span>
<span id="cb187-6"><a href="#cb187-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb187-7"><a href="#cb187-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-8"><a href="#cb187-8" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> FindInReader<span class="op">(</span>r io<span class="op">.</span>Reader<span class="op">)</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb187-9"><a href="#cb187-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// create a buffer</span></span>
<span id="cb187-10"><a href="#cb187-10" aria-hidden="true" tabindex="-1"></a>  buf <span class="op">:=</span> <span class="op">[]</span><span class="dt">byte</span><span class="op">{}</span></span>
<span id="cb187-11"><a href="#cb187-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// cache this so we&#39;re not doing each loop iteration</span></span>
<span id="cb187-12"><a href="#cb187-12" aria-hidden="true" tabindex="-1"></a>  l <span class="op">:=</span> <span class="bu">len</span><span class="op">(</span>lookFor<span class="op">)</span></span>
<span id="cb187-13"><a href="#cb187-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-14"><a href="#cb187-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// our temporary buffer</span></span>
<span id="cb187-15"><a href="#cb187-15" aria-hidden="true" tabindex="-1"></a>  t <span class="op">:=</span> <span class="bu">make</span><span class="op">([]</span><span class="dt">byte</span><span class="op">,</span> l<span class="op">*</span><span class="dv">2</span><span class="op">)</span></span>
<span id="cb187-16"><a href="#cb187-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-17"><a href="#cb187-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">for</span> <span class="op">{</span></span>
<span id="cb187-18"><a href="#cb187-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// read some bytes</span></span>
<span id="cb187-19"><a href="#cb187-19" aria-hidden="true" tabindex="-1"></a>    n<span class="op">,</span> err <span class="op">:=</span> r<span class="op">.</span>Read<span class="op">(</span>t<span class="op">)</span></span>
<span id="cb187-20"><a href="#cb187-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> err <span class="op">==</span> io<span class="op">.</span>EOF <span class="op">{</span></span>
<span id="cb187-21"><a href="#cb187-21" aria-hidden="true" tabindex="-1"></a>      buf <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>buf<span class="op">,</span> t<span class="op">...)</span></span>
<span id="cb187-22"><a href="#cb187-22" aria-hidden="true" tabindex="-1"></a>      <span class="kw">break</span></span>
<span id="cb187-23"><a href="#cb187-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-24"><a href="#cb187-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb187-25"><a href="#cb187-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="ot">false</span></span>
<span id="cb187-26"><a href="#cb187-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-27"><a href="#cb187-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-28"><a href="#cb187-28" aria-hidden="true" tabindex="-1"></a>    buf <span class="op">=</span> <span class="bu">append</span><span class="op">(</span>buf<span class="op">,</span> t<span class="op">...)</span></span>
<span id="cb187-29"><a href="#cb187-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-30"><a href="#cb187-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> bytes<span class="op">.</span>Contains<span class="op">(</span>buf<span class="op">,</span> lookFor<span class="op">)</span> <span class="op">{</span></span>
<span id="cb187-31"><a href="#cb187-31" aria-hidden="true" tabindex="-1"></a>      <span class="kw">return</span> <span class="ot">true</span></span>
<span id="cb187-32"><a href="#cb187-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-33"><a href="#cb187-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-34"><a href="#cb187-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">if</span> <span class="bu">len</span><span class="op">(</span>buf<span class="op">)</span> <span class="op">&gt;</span> l<span class="op">+</span>n <span class="op">{</span></span>
<span id="cb187-35"><a href="#cb187-35" aria-hidden="true" tabindex="-1"></a>      buf <span class="op">=</span> buf<span class="op">[</span>l <span class="op">:</span> l<span class="op">+</span>n<span class="op">]</span></span>
<span id="cb187-36"><a href="#cb187-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb187-37"><a href="#cb187-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb187-38"><a href="#cb187-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb187-39"><a href="#cb187-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> bytes<span class="op">.</span>Contains<span class="op">(</span>buf<span class="op">,</span> lookFor<span class="op">)</span></span>
<span id="cb187-40"><a href="#cb187-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>At first the one that takes <code class="verbatim">[]byte</code> is the clear winner, right? But think about how you can use both functions.</p>
<p>For the first one, you have to prepare a slice of all the bytes you want to check before you can make the check. What if you're waiting on bytes from a huge file, or from a network connection?</p>
<p>The second function that takes <code class="verbatim">io.Reader</code> is larger; that's not something anyone could argue and still be considered sane. However, it is a method that won't require many changes to get it to work with other byte sources. Also, it removes some of the responsibility from the caller to get everything in order. Many libraries return structs that fulfill the <code class="verbatim">io.Reader</code> interface; not having to use <code class="verbatim">io.ReadAll</code> first to get the byte slice is less code to write – and more memory efficient.</p>
<p>For example, many object storage libraries provide an <code class="verbatim">io.Reader</code> that lets you read chunks of bytes from an object. If you're reading bytes from an object store, there's a good chance you're paying for that operation ( even if it's only fractions of a penny ). In such cases, wouldn't you want to be able to return as soon as you've found the bytes you want, rather than having to read all of the bytes – no matter how many or how long that takes – using <code class="verbatim">io.ReadAll</code>?</p>
<p>Additionally, the second function works with <em>anything</em> that implements that interface. Want to use a <code class="verbatim">bytes.Buffer</code>? Go nuts. Got a file handle you want to read from? That works too! Maybe you've got an API client that provides a struct that fulfills <code class="verbatim">io.Reader</code> for reading data over the network – just pass that struct into <code class="verbatim">FindInReader</code> and you're good to go! So while using the interface did require writing more code <em>at first</em>, by using an interface you've allowed the code to work with anything that fulfills the interface instead of having to write a new function for each thing you want to see if it contains 'hello world'.</p>
<section id="another-io.readall-example" class="level5" data-number="6.3.0.0.1">
<h5 data-number="6.3.0.0.1"><span class="header-section-number">6.3.0.0.1</span> Another <code class="verbatim">io.ReadAll</code> Example</h5>
<p>If you still like <code class="verbatim">io.ReadAll</code>, think about what's involved in uploading an image.</p>
<p>What's more memory efficient, <code class="verbatim">io.ReadAll</code>:</p>
<div class="sourceCode" id="cb188"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> handle<span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">){</span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defer</span> r<span class="op">.</span>Body<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb188-3"><a href="#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="#cb188-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Imagine there&#39;s code here that gets the output file ready,</span></span>
<span id="cb188-5"><a href="#cb188-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// probably by creating a file handle pointing to an empty file in</span></span>
<span id="cb188-6"><a href="#cb188-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// a temporary directory.</span></span>
<span id="cb188-7"><a href="#cb188-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-8"><a href="#cb188-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...how big is the image?</span></span>
<span id="cb188-9"><a href="#cb188-9" aria-hidden="true" tabindex="-1"></a>  bits<span class="op">,</span> err <span class="op">:=</span> io<span class="op">.</span>ReadAll<span class="op">(</span>r<span class="op">.</span>Body<span class="op">)</span></span>
<span id="cb188-10"><a href="#cb188-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb188-11"><a href="#cb188-11" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb188-12"><a href="#cb188-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span></span>
<span id="cb188-13"><a href="#cb188-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb188-14"><a href="#cb188-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-15"><a href="#cb188-15" aria-hidden="true" tabindex="-1"></a>  err <span class="op">=</span> writeToFile<span class="op">(</span>bits<span class="op">,</span> tmp<span class="op">)</span></span>
<span id="cb188-16"><a href="#cb188-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb188-17"><a href="#cb188-17" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>err<span class="op">)</span></span>
<span id="cb188-18"><a href="#cb188-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb188-19"><a href="#cb188-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-20"><a href="#cb188-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Maybe more stuff happens, sending the name of the file somewhere so it can</span></span>
<span id="cb188-21"><a href="#cb188-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// get processed ( resizing an image, parsing text, whatever )</span></span>
<span id="cb188-22"><a href="#cb188-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>…or this:</p>
<div class="sourceCode" id="cb189"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb189-1"><a href="#cb189-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> handle<span class="op">(</span>w http<span class="op">.</span>ResponseWriter<span class="op">,</span> r <span class="op">*</span>http<span class="op">.</span>Request<span class="op">){</span></span>
<span id="cb189-2"><a href="#cb189-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">defer</span> r<span class="op">.</span>Body<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb189-3"><a href="#cb189-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-4"><a href="#cb189-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// same prep code</span></span>
<span id="cb189-5"><a href="#cb189-5" aria-hidden="true" tabindex="-1"></a>  err <span class="op">=</span> writeToFile<span class="op">(</span>tmp<span class="op">,</span> r<span class="op">.</span>Body<span class="op">)</span></span>
<span id="cb189-6"><a href="#cb189-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb189-7"><a href="#cb189-7" aria-hidden="true" tabindex="-1"></a>    handleError<span class="op">(</span>w<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb189-8"><a href="#cb189-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb189-9"><a href="#cb189-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-10"><a href="#cb189-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// same post-writing code</span></span>
<span id="cb189-11"><a href="#cb189-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Previously, <code class="verbatim">writeToFile</code> took the bytes and put them in a <code class="verbatim">bytes.Buffer</code>, and then used <code class="verbatim">io.Copy</code> to write that buffer to a file. Now it's just using <code class="verbatim">io.Copy</code>.</p>
Whatever is being uploaded spends very little time in memory. Instead, almost as quickly as we read a byte we're writing it.
</section>
</section>
<section id="api-design-google-vs-amazon" class="level2" data-number="6.4">
<h2 data-number="6.4"><span class="header-section-number">6.4</span> API Design, Google vs Amazon</h2>
<p>A good way to show everything we've been talking about is to take a look at something where having <code class="verbatim">io.Reader</code> and <code class="verbatim">io.Writer</code> is very handy.</p>
<p>Object storage APIs. Think AWS S3, or Google Storage. These are things with 'buckets' and 'objects' – no files or directories.</p>
<p>Let's take a look at how you upload some data to object storage for Amazon's S3 using their Go SDK:</p>
<div class="sourceCode" id="cb190"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a><span class="co">// The session the S3 Uploader will use</span></span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>sess <span class="op">:=</span> session<span class="op">.</span>Must<span class="op">(</span>session<span class="op">.</span>NewSession<span class="op">())</span></span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Create an uploader with the session and default options</span></span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a>uploader <span class="op">:=</span> s3manager<span class="op">.</span>NewUploader<span class="op">(</span>sess<span class="op">)</span></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>f<span class="op">,</span> err  <span class="op">:=</span> os<span class="op">.</span>Open<span class="op">(</span>filename<span class="op">)</span></span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>    fmt<span class="op">.</span>Printf<span class="op">(</span><span class="st">&quot;failed to open file %q, %w&quot;</span><span class="op">,</span> filename<span class="op">,</span> err<span class="op">)</span></span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Upload the file to S3.</span></span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a>result<span class="op">,</span> err <span class="op">:=</span> uploader<span class="op">.</span>Upload<span class="op">(&amp;</span>s3manager<span class="op">.</span>UploadInput<span class="op">{</span></span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a>    Bucket<span class="op">:</span> aws<span class="op">.</span>String<span class="op">(</span>myBucket<span class="op">),</span></span>
<span id="cb190-15"><a href="#cb190-15" aria-hidden="true" tabindex="-1"></a>    Key<span class="op">:</span>    aws<span class="op">.</span>String<span class="op">(</span>myString<span class="op">),</span></span>
<span id="cb190-16"><a href="#cb190-16" aria-hidden="true" tabindex="-1"></a>    Body<span class="op">:</span>   f<span class="op">,</span></span>
<span id="cb190-17"><a href="#cb190-17" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span>
<span id="cb190-18"><a href="#cb190-18" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb190-19"><a href="#cb190-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb190-20"><a href="#cb190-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb190-21"><a href="#cb190-21" aria-hidden="true" tabindex="-1"></a><span class="kw">return</span> <span class="ot">nil</span></span></code></pre></div>
<p>Now Google:</p>
<div class="sourceCode" id="cb191"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb191-1"><a href="#cb191-1" aria-hidden="true" tabindex="-1"></a>ctx <span class="op">:=</span> context<span class="op">.</span>Background<span class="op">()</span></span>
<span id="cb191-2"><a href="#cb191-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-3"><a href="#cb191-3" aria-hidden="true" tabindex="-1"></a>client<span class="op">,</span> err <span class="op">:=</span> storage<span class="op">.</span>NewClient<span class="op">(</span>ctx<span class="op">)</span></span>
<span id="cb191-4"><a href="#cb191-4" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb191-5"><a href="#cb191-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb191-6"><a href="#cb191-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-7"><a href="#cb191-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-8"><a href="#cb191-8" aria-hidden="true" tabindex="-1"></a>writer <span class="op">:=</span> client<span class="op">.</span>Bucket<span class="op">(</span>bucketName<span class="op">).</span>Object<span class="op">(</span>objectFullName<span class="op">).</span>NewWriter<span class="op">(</span>ctx<span class="op">)</span></span>
<span id="cb191-9"><a href="#cb191-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-10"><a href="#cb191-10" aria-hidden="true" tabindex="-1"></a>f<span class="op">,</span> err <span class="op">:=</span> os<span class="op">.</span>OpenFile<span class="op">(</span>name <span class="op">,</span> os<span class="op">.</span>O_RDONLY<span class="op">,</span> <span class="dv">0o644</span><span class="op">)</span></span>
<span id="cb191-11"><a href="#cb191-11" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb191-12"><a href="#cb191-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb191-13"><a href="#cb191-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-14"><a href="#cb191-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-15"><a href="#cb191-15" aria-hidden="true" tabindex="-1"></a>_<span class="op">,</span> err <span class="op">=</span> io<span class="op">.</span>Copy<span class="op">(</span>f<span class="op">,</span> writer<span class="op">)</span></span>
<span id="cb191-16"><a href="#cb191-16" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb191-17"><a href="#cb191-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb191-18"><a href="#cb191-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb191-19"><a href="#cb191-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb191-20"><a href="#cb191-20" aria-hidden="true" tabindex="-1"></a>err <span class="op">=</span> writer<span class="op">.</span>Close<span class="op">()</span></span>
<span id="cb191-21"><a href="#cb191-21" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb191-22"><a href="#cb191-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> err</span>
<span id="cb191-23"><a href="#cb191-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>One thing to note really quickly: the type of <code class="verbatim">Body</code> in <code class="verbatim">s3manager.UploadInput</code> is <code class="verbatim">io.Reader</code>.</p>
<p>So Amazon has you pass in an <code class="verbatim">io.Reader</code>, Google gives you an <code class="verbatim">io.Writer</code>.</p>
<p>What change does this have on how you use these packages?</p>
<p>Well, for one: if you want to upload bytes from multiple places to S3, you have to have all those bytes ready beforehand. You also have to do the whole upload all at once.</p>
<p>So one thing you can't do with the S3 version is build a zip file made of multiple files from a multi-part POST without reading in all those bytes and arranging everything.</p>
<p>With Google's API, you could pass that writer around. Hey, remember our <code class="verbatim">ProcessDataIntoOutput</code> function from earlier? This one:</p>
<div class="sourceCode" id="cb192"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> ProcessDataIntoOutput<span class="op">(</span>input io<span class="op">.</span>Reader<span class="op">,</span> output io<span class="op">.</span>Writer<span class="op">,</span> p processor<span class="op">)</span> <span class="dt">error</span> <span class="op">{</span></span>
<span id="cb192-2"><a href="#cb192-2" aria-hidden="true" tabindex="-1"></a>  processed<span class="op">,</span> err <span class="op">:=</span> p<span class="op">.</span>Process<span class="op">(</span>input<span class="op">)</span></span>
<span id="cb192-3"><a href="#cb192-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> err <span class="op">!=</span> <span class="ot">nil</span> <span class="op">{</span></span>
<span id="cb192-4"><a href="#cb192-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">return</span> <span class="ot">nil</span><span class="op">,</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to process data: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb192-5"><a href="#cb192-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb192-6"><a href="#cb192-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-7"><a href="#cb192-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// is there something else that needs to happen here?</span></span>
<span id="cb192-8"><a href="#cb192-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb192-9"><a href="#cb192-9" aria-hidden="true" tabindex="-1"></a>  _<span class="op">,</span> err <span class="op">=</span> io<span class="op">.</span>Copy<span class="op">(</span>processed<span class="op">,</span> output<span class="op">)</span></span>
<span id="cb192-10"><a href="#cb192-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">return</span> fmt<span class="op">.</span>Errorf<span class="op">(</span><span class="st">&quot;unable to copy processed data to output: %w&quot;</span><span class="op">,</span> err<span class="op">)</span></span>
<span id="cb192-11"><a href="#cb192-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Hey, isn't that neat – without any changes to our code, we can write to reports into Google Storage.</p>
<p>This isn't meant to be mean or anything; I'm not saying the developers who built the S3 portion of the Amazon Go SDK are stupid, or bad developers.</p>
<p>What this section is <em>trying</em> to get across is the idea that everything we've been talking about is connected. How we design our APIs matters.</p>
<p>By designing the Amazon S3 API around the concept of "uploading files", the developers made some potentially very useful cases harder to achieve without having to add much more code. This is an API that reads like it kind of doesn't trust developers to Do The Right Thing™.</p>
<p>On the other hand, by designing the Google Storage API around the idea of "writing bytes", Google has put all the power of <code class="verbatim">io.Writer</code> in your hands. Rather than having to do a lot of work that locks you into using the library a specific way, <em>you</em> get to choose how to use it.</p>
<p>Additionally, by trying to ensure that how you <em>use</em> the package is simple, it's allowed Google to make the <em>implementation</em> of the package simpler. Take a look at <a href="https://github.com/googleapis/google-cloud-go/blob/storage/v1.21.0/storage/writer.go#L235">the implementation of Write</a> in the Google Storage package.</p>
<p>Now take a look at the implementation of <a href="https://github.com/aws/aws-sdk-go/blob/v1.43.29/service/s3/s3manager/upload.go#L274">Upload</a> for S3. Whoops, sorry, <a href="https://github.com/aws/aws-sdk-go/blob/360c58a5df49fb4b631396d0ede689ba12179e2d/service/s3/s3manager/upload.go#L296">UploadWithContext</a>. Oh, wait, no, have to go deeper into <a href="https://github.com/aws/aws-sdk-go/blob/360c58a5df49fb4b631396d0ede689ba12179e2d/service/s3/s3manager/upload.go#L376">uploader.upload</a>. Still a bit further to go, though, <a href="https://github.com/aws/aws-sdk-go/blob/360c58a5df49fb4b631396d0ede689ba12179e2d/service/s3/s3manager/upload.go#L576">multiuploader.upload</a> is what we want.</p>
It's fair to say that Amazon has different goals. Obviously that's the case; Amazon has a <a href="https://github.com/aws/aws-sdk-go/blob/360c58a5df49fb4b631396d0ede689ba12179e2d/service/s3/s3manager/upload.go#L26">minimum size on what can be uploaded to S3</a>, Google doesn't. But that's not to say that Google doesn't have some similar logic to Amazon for some cases. But if they do, they've put that logic where it belongs; in their service.
</section>
<section id="tips-tricks-gotchas" class="level2" data-number="6.5">
<h2 data-number="6.5"><span class="header-section-number">6.5</span> Tips, Tricks, &amp; Gotchas</h2>
<a href="https://dave.cheney.net/2019/06/10/constant-time">https://dave.cheney.net/2019/06/10/constant-time</a>
</section>
</section>
<section id="sources" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Sources</h1>
<p>Much of this document comes from articles, presentations, and blog posts from various authors. This content is used under the 'teaching' clause of fair use laws; the content being copied is meant to improve a person's understanding of best practices for writing clean, clear, maintainable Go code.</p>
<p>The content from these sources has been edited so that the whole document has a consistent style &amp; tense.</p>
<p>The main source is Dave Cheney's 'Practical Go: Real world advice for writing maintainable Go programs'. However, as there are multiple versions, I've used parts from all to put this document together.</p>
<ul>
<li><a href="https://dave.cheney.net/practical-go/presentations/gophercon-singapore-2019.html">Practical Go, Gophercon Singapore 2019</a></li>
<li><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html">Practical Go, QCon Shanghai 2018</a></li>
</ul>
<p>Other sources:</p>
<ul>
<li><a href="https://talks.golang.org/2014/go4gophers.slide">Go for gophers</a></li>
<li><a href="https://github.com/golang/go/wiki/CodeReviewComments">Go Code Review Comments</a> ( From the <code class="verbatim">golang/go</code> repo on GitHub )</li>
<li><a href="https://go.dev/doc/effective_go">Effective Go</a></li>
<li><a href="https://github.com/uber-go/guide/blob/master/style.md">Uber's Go Styleguide</a></li>
<li><a href="https://dave.cheney.net/2013/04/30/curious-channels">Curious Channels</a>, Dave Cheney</li>
<li><a href="https://www.calhoun.io/pitfalls-of-context-values-and-how-to-avoid-or-mitigate-them/">Pitfalls of context values and how to avoid or mitigate them in Go</a>, Jon Calhoun</li>
<li><a href="https://dave.cheney.net/2017/08/20/context-isnt-for-cancellation">Context isn't for cancellation</a>, Dave Cheney</li>
</ul>
<section id="other-readingviewing" class="level2" data-number="7.1">
<h2 data-number="7.1"><span class="header-section-number">7.1</span> Other Reading/Viewing</h2>
<p>This are articles or tutorials that aren't useful in defining a set of best practices, but are still worth reading.</p>
<ul>
<li><a href="https://eli.thegreenplace.net/2019/simple-go-project-layout-with-modules/">Simple Go project layout with modules</a> - the only change we'd suggest make is moving <code class="verbatim">clientlib</code> and <code class="verbatim">serverlib</code> into a <code class="verbatim">lib</code> folder so you'd have <code class="verbatim">lib/client</code> and <code class="verbatim">lib/server</code> instead ( ie, clarity &amp; strive for one-word package names )</li>
<li><a href="https://go.dev/blog/pipelines">Go Pipelines</a> - a blog post from the Go team on some effective ways to handle concurrency <em>without</em> using <code class="verbatim">context.Context</code> as a way to signal cancellation</li>
<li><a href="https://evilmartians.com/chronicles/what-could-go-wrong-with-a-mutex-or-the-go-profiling-story">What could Go wrong with a mutex, or the Go profiling story</a> - a good dive debugging a deadlock issue</li>
<li><a href="https://eli.thegreenplace.net/2021/a-comprehensive-guide-to-go-generate/">A comprehensive guide to go generate</a> - a deep dive into the <code class="verbatim">go generate</code> command, and how it can be used</li>
<li><a href="https://www.youtube.com/watch?v=oV9rvDllKEg">Concurrency is not Parallelism</a>, a great presentation from Rob Pike</li>
<li><a href="https://dave.cheney.net/2014/06/27/ice-cream-makers-and-data-races">Ice cream makers and data races</a>, blog post on data races in Go from Dave Cheney</li>
</ul>
<section id="mutexes" class="level3" data-number="7.1.1">
<h3 data-number="7.1.1"><span class="header-section-number">7.1.1</span> Mutexes</h3>
<ul>
<li><a href="https://www.programming-books.io/essential/go/mutex-gotchas-1c78058100ed4b45aab9461f69c05ecd">Mutex gotchas</a></li>
</ul>
</section>
</section>
</section>
</body>
</html>
